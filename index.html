<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #f0f4fb;
      color: var(--texto);
    }

    header {
      background: linear-gradient(90deg, var(--azul), #007bff);
      color: #fff;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header small {
      display: block;
      font-size: 0.8rem;
      opacity: .9;
    }
    .header-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primaria {
      background: #fff;
      color: var(--azul);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .btn-admin {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.6);
      color: #fff;
    }

    main {
      max-width: 1100px;
      margin: 18px auto 30px;
      padding: 0 10px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--borda);
      padding: 15px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      color: var(--azul);
    }
    .card small {
      font-size: 0.8rem;
      color: #555;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 768px){
      .grid-2{ grid-template-columns:1fr; }
    }
    label {
      display:block;
      font-size:0.85rem;
      margin-bottom:3px;
      font-weight:500;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    select,
    textarea {
      width:100%;
      padding:7px 8px;
      border-radius:8px;
      border:1px solid var(--borda);
      background:#fafbff;
      font-size:0.9rem;
    }
    textarea {
      resize:vertical;
      min-height:60px;
    }
    .modalidades-lista {
      margin-top:6px;
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
      gap:6px;
    }
    .modalidade-item {
      display:flex;
      gap:6px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--borda);
      background:var(--azul-claro);
      font-size:0.8rem;
    }
    .modalidade-item input {
      margin-top:3px;
    }
    .modalidade-label {
      font-weight:600;
      font-size:0.85rem;
    }
    .modalidade-vagas {
      display:block;
      font-size:0.75rem;
      color:#333;
    }
    .modalidade-lotado {
      color:var(--vermelho);
      font-weight:600;
    }
    .alerta {
      margin-top:4px;
      font-size:0.8rem;
      color:#555;
    }
    .msg-erro {
      background:#ffe5e5;
      color:#b30000;
      padding:6px 8px;
      border-radius:8px;
      font-size:0.8rem;
      margin-bottom:6px;
    }
    .msg-sucesso {
      background:#e5ffe9;
      color:#0c7a2a;
      padding:6px 8px;
      border-radius:8px;
      font-size:0.8rem;
      margin-bottom:6px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:0.8rem;
    }
    th,td {
      padding:5px 6px;
      border-bottom:1px solid #e1e4eb;
      text-align:left;
    }
    th {
      background:#f2f5ff;
      font-weight:600;
    }
    tr:hover td {
      background:#f9fbff;
    }
    .filtros {
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .filtros > div {
      min-width:150px;
    }

    /* Responsividade tabela inscri√ß√µes (admin) */
    #tab-inscricoes {
      overflow-x: auto;
    }
    #tab-inscricoes table {
      min-width: 700px;
    }

    /* admin */
    #adminSection { display:none; }
    .admin-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .admin-header h2 {
      margin:0;
      font-size:1rem;
      color:var(--azul);
    }
    .admin-sub {
      font-size:0.8rem;
      color:#555;
    }
    .admin-status {
      font-size:0.75rem;
      padding:3px 8px;
      border-radius:999px;
      background:#e5ffe9;
      color:#0c7a2a;
    }
    .admin-status.fechado {
      background:#ffe5e5;
      color:#b30000;
    }
    .admin-tabs {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
      border-bottom:1px solid #e1e4eb;
      padding-bottom:4px;
    }
    .admin-tab-btn {
      border:none;
      border-radius:999px;
      padding:5px 10px;
      font-size:0.8rem;
      background:#f1f3fb;
      cursor:pointer;
    }
    .admin-tab-btn.ativo {
      background:var(--azul);
      color:#fff;
    }
    .admin-tab-content { display:none; }
    .admin-tab-content.ativo { display:block; }
    .admin-bloco {
      background:#f9fbff;
      border-radius:10px;
      border:1px dashed #c5cde0;
      padding:8px;
      margin-bottom:8px;
      font-size:0.82rem;
    }

    /* modal autorizacao (novo) */
    #modalAutorizacao {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
    }
    #modalAutorizacao .card {
      width: 720px;
      max-width: 94%;
      padding: 14px;
    }
    .aut-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
    }
    @media (max-width:600px){ .aut-grid{ grid-template-columns:1fr; } }
    .aut-row { display:flex; gap:8px; align-items:center; }
    .aut-note { font-size:0.82rem; color:#333; }

    /* other styles remain... */
  </style>
</head>
<body>

<!-- OVERLAY E-MAIL -->
<div id="emailOverlay">
  <div id="emailOverlayCard">
    <h2>Antes de continuar...</h2>
    <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o.</p>
    <div id="msgEmailOverlay"></div>
    <input type="text" id="emailAluno" placeholder="seuemail@exemplo.com" />
    <button class="btn btn-primaria" id="btnEntrarEmail">Entrar</button>
  </div>
</div>

<header>
  <div>
    <h1 id="tituloEvento">Inscri√ß√µes Movimenta Odisseia</h1>
    <small id="subEvento">Inscri√ß√µes para o Movimenta Odisseia</small>
  </div>
  <div class="header-right">
    <button class="btn btn-primaria" id="btnToggleInscritos">üëÄ Ver inscritos</button>
    <button class="btn btn-primaria" id="btnVerJogos">üèÜ Ver jogos</button>
    <button class="btn btn-primaria" id="btnClassificados">‚úÖ Classificados</button>
    <button class="btn btn-primaria" id="btnPlacarAoVivo">‚ö° Placar ao vivo</button>
    <button class="btn btn-admin" id="btnAdminArea">üîê √Årea administrativa</button>
  </div>
</header>

<main>

  <!-- INSCRI√á√ÉO -->
  <section class="card" id="secInscricao">
    <h2>Formul√°rio de inscri√ß√£o</h2>
    <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>

    <div id="msgForm"></div>

    <form id="formInscricao">
      <div class="grid-2">
        <div>
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione...</option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="turno">Turno</label>
          <select id="turno" required>
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="turma">Turma</label>
          <select id="turma" required>
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
          <input type="text" id="camisaNumero" />
        </div>
        <div>
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" placeholder="Posi√ß√£o, alguma observa√ß√£o..."></textarea>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Modalidades (m√°ximo 2 por aluno)</label>
        <p class="alerta">
          ‚Ä¢ LIMITE padr√£o por turma: FUTSAL (8), DOMIN√ì/FUTMESA/T√äNIS/XADREZ (2), VOLEI (6), QUEIMADA MISTA (10 ‚Äì 5 meninos / 5 meninas).  
          ‚Ä¢ Esses limites podem ser ajustados na √°rea administrativa.
        </p>
        <div class="modalidades-lista" id="modalidadesContainer"></div>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:0.8rem;">Use o bot√£o <strong>Ver inscritos</strong> para ver quem j√° est√° em cada turma.</span>
        <button type="submit" class="btn btn-primaria">‚úÖ Enviar inscri√ß√£o</button>
      </div>
    </form>
  </section>

  <!-- ... rest of content unchanged ... -->

  <!-- ADMIN -->
  <section class="card" id="adminSection">
    <div class="admin-header">
      <div>
        <h2>√Årea administrativa</h2>
        <div class="admin-sub">Gerencie inscri√ß√µes, jogos e configura√ß√µes.</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span id="adminStatus" class="admin-status">Verificando...</span>
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="btn btn-primaria" id="btnAutorizacaoAbrir">üîì Autoriza√ß√£o</button>
          <button class="btn btn-primaria" id="btnFecharAdmin">‚¨Ö Voltar</button>
        </div>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab-btn ativo" data-tab="inscricoes">üßë‚Äçüéì Inscri√ß√µes</button>
      <button class="admin-tab-btn" data-tab="jogos">üèÜ Jogos</button>
      <button class="admin-tab-btn" data-tab="relatorio">üñ®Ô∏è Imprimir relat√≥rio</button>
      <button class="admin-tab-btn" data-tab="professores">üë©‚Äçüè´ Professores</button>
      <button class="admin-tab-btn" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <!-- TAB CONTENTS (unchanged) -->

  </section>

  <!-- Modal Autoriza√ß√£o (novo) -->
  <div id="modalAutorizacao">
    <div class="card">
      <h3>Autoriza√ß√£o por Turma</h3>
      <p class="aut-note">Use este painel para permitir exce√ß√µes por turma e modalidade (por exemplo: aceitar participantes mesmo que os limites por sexo/total estejam atingidos).</p>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <label style="min-width:80px; margin:0;">Turma</label>
        <select id="autTurmaSelect" style="flex:1">
          <option value="">Selecione a turma...</option>
        </select>
      </div>

      <div id="autModalidadesArea" style="margin-top:10px;">
        <!-- dinamicamente preenchido -->
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="autCancelar">Fechar</button>
        <button class="btn btn-primaria" id="autSalvar">Salvar autoriza√ß√µes</button>
      </div>
      <div id="autStatus" style="margin-top:8px; font-size:0.85rem; color:#0c7a2a;"></div>
    </div>
  </div>

  <!-- PAINEL PARA PROFESSORES / COORDENADORES / GESTORES -->
  <section class="card" id="professoresSection">
    <div class="admin-header">
      <div>
        <h2>Painel de professores</h2>
        <div class="admin-sub">
          Selecione turno e turma para indicar alunos que <strong>n√£o podem participar</strong>.
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span style="font-size:0.8rem;" id="profUsuarioAtivo">Professor logado</span>
        <button class="btn btn-primaria" id="btnFecharProfessores">‚¨Ö Voltar</button>
      </div>
    </div>

    <!-- content unchanged -->
  </section>

</main>

<script>
"use strict";

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== CONSTANTES ========== */

const MODALIDADES = [
  "FUTSAL",
  "QUEIMADA MISTA",
  "DOMIN√ì",
  "FUTMESA",
  "T√äNIS DE MESA",
  "XADREZ",
  "VOLEI"
];

const TURMAS_MATUTINO = [
  "7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F",
  "8¬∫F",
  "9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"
];

const TURMAS_VESPERTINO = [
  "6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G",
  "8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"
];

const TURMAS_NOTURNO = [
  "1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F",
  "2¬∫A","2¬∫B","2¬∫C",
  "3¬∫A","3¬∫B","3¬∫C"
];

const TODAS_TURMAS = [
  ...TURMAS_MATUTINO,
  ...TURMAS_VESPERTINO,
  ...TURMAS_NOTURNO
];

function getTurmasPorTurno(turno) {
  if (turno === "Matutino") return TURMAS_MATUTINO;
  if (turno === "Vespertino") return TURMAS_VESPERTINO;
  if (turno === "Noturno") return TURMAS_NOTURNO;
  return [];
}

function getSerieFromTurma(t){
  if (!t) return "";
  return t.charAt(0);
}

/* limites padr√£o (podem ser alterados nas configs) */
let LIMITE_MODALIDADES_POR_ALUNO = 2;
let LIMITE_MODALIDADE_TURMA = {
  "FUTSAL": 8,
  "DOMIN√ì": 2,
  "FUTMESA": 2,
  "T√äNIS DE MESA": 2,
  "XADREZ": 2,
  "VOLEI": 6
};
let LIMITE_QUEIMADA_TOTAL = 10;
let LIMITE_QUEIMADA_POR_SEXO = 5;

/* controle de inscri√ß√µes por turma/mod e queimada */
let countsPorTurmaModalidade = {};
let countsQueimadaGenero = {};
let todasInscricoes = [];
let todosJogos = [];

/* NOVO: professores e pap√©is */
let todosProfessores = []; // {id, nome, tipo, senha}
let currentRole = null;    // "ADMIN", "Professor", "Coordenador", "Gestor"
let currentProfessor = null; // objeto do professor logado

/* config evento */
let configEvento = {
  dataLimite: null,
  msgEncerradas: "",
  bloquearAgora: false,
  nomeEvento: "Movimenta Odisseia",
  anoEvento: "",
  textoInicial: ""
};

let inscricoesEncerradas = false;
let emailAtual = null;
let isAdmin = false;
const ADMIN_PASSWORD = "52090949";

/* NOVO: cache de autoriza√ß√µes */
let autorizacoesCache = {}; // { turmaId: { "QUEIMADA MISTA": { override:true, note:"" }, ... } }

/* ========== FUN√á√ïES AUXILIARES ========== */

function normalizarNome(str){
  return (str || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ");
}

function validarEmail(email){
  return email && email.includes("@") && email.includes(".");
}

function msgForm(texto, ok){
  const box = document.getElementById("msgForm");
  box.innerHTML = "";
  const div = document.createElement("div");
  div.className = ok ? "msg-sucesso" : "msg-erro";
  div.textContent = texto;
  box.appendChild(div);
}

function formatarDataBR(yyyyMMdd){
  if (!yyyyMMdd) return "-";
  const p = yyyyMMdd.split("-");
  if (p.length !== 3) return yyyyMMdd;
  return p[2] + "/" + p[1] + "/" + p[0];
}

/* ========== CONTROLE DE FECHAMENTO ========== */

function atualizarStatusInscricoes(){
  const hoje = new Date();
  const hojeDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  let fechado = false;

  if (configEvento.bloquearAgora){
    fechado = true;
  } else if (configEvento.dataLimite){
    const p = configEvento.dataLimite.split("-");
    if (p.length === 3){
      const limiteDia = new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2]));
      if (hojeDia.getTime() >= limiteDia.getTime()){
        fechado = true;
      }
    }
  }

  inscricoesEncerradas = fechado;

  const form = document.getElementById("formInscricao");
  const adminStatus = document.getElementById("adminStatus");
  if (form){
    const campos = form.querySelectorAll("input,select,textarea,button[type='submit']");
    campos.forEach(el => { el.disabled = fechado; });
  }
  if (fechado){
    msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false);
    if (adminStatus){
      adminStatus.textContent = "Inscri√ß√µes ENCERRADAS";
      adminStatus.classList.add("fechado");
    }
  } else {
    document.getElementById("msgForm").innerHTML = "";
    if (adminStatus){
      adminStatus.textContent = "Inscri√ß√µes ABERTAS";
      adminStatus.classList.remove("fechado");
    }
  }
}

/* ========== CONFIG FIRESTORE ========== */

async function carregarConfiguracoes(){
  try{
    const docSnap = await db.collection("config").doc("geral").get();
    if (docSnap.exists){
      const d = docSnap.data();
      if (d.dataLimiteInscricao) configEvento.dataLimite = d.dataLimiteInscricao;
      if (typeof d.bloquearInscricoesAgora === "boolean") configEvento.bloquearAgora = d.bloquearInscricoesAgora;
      if (d.mensagemEncerradas) configEvento.msgEncerradas = d.mensagemEncerradas;

      if (typeof d.limiteModalidadesPorAluno === "number") LIMITE_MODALIDADES_POR_ALUNO = d.limiteModalidadesPorAluno;
      if (typeof d.limiteQueimadaTotal === "number") LIMITE_QUEIMADA_TOTAL = d.limiteQueimadaTotal;
      if (typeof d.limiteQueimadaPorSexo === "number") LIMITE_QUEIMADA_POR_SEXO = d.limiteQueimadaPorSexo;
      if (d.limitesModalidadeTurma){
        Object.keys(d.limitesModalidadeTurma).forEach(m => {
          const val = d.limitesModalidadeTurma[m];
          if (typeof val === "number"){
            LIMITE_MODALIDADE_TURMA[m] = val;
          }
        });
      }
      if (d.nomeEvento) configEvento.nomeEvento = d.nomeEvento;
      if (d.anoEdicao) configEvento.anoEvento = d.anoEdicao;
      if (d.textoInicial) configEvento.textoInicial = d.textoInicial;
    }
  }catch(e){
    console.error("Erro ao carregar configura√ß√µes:",e);
  }

  document.getElementById("cfgDataLimite").value = configEvento.dataLimite || "";
  document.getElementById("cfgMsgEncerradas").value = configEvento.msgEncerradas || "";
  document.getElementById("cfgBloquearAgora").checked = !!configEvento.bloquearAgora;
  document.getElementById("cfgLimitePorAluno").value = LIMITE_MODALIDADES_POR_ALUNO;
  document.getElementById("cfgQueimadaTotal").value = LIMITE_QUEIMADA_TOTAL;
  document.getElementById("cfgQueimadaSexo").value = LIMITE_QUEIMADA_POR_SEXO;
  document.getElementById("cfgFutsal").value = LIMITE_MODALIDADE_TURMA["FUTSAL"];
  document.getElementById("cfgDomino").value = LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
  document.getElementById("cfgFutmesa").value = LIMITE_MODALIDADE_TURMA["FUTMESA"];
  document.getElementById("cfgTenis").value = LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
  document.getElementById("cfgXadrez").value = LIMITE_MODALIDADE_TURMA["XADREZ"];
  document.getElementById("cfgVolei").value = LIMITE_MODALIDADE_TURMA["VOLEI"];
  document.getElementById("cfgNomeEvento").value = configEvento.nomeEvento || "";
  document.getElementById("cfgAnoEvento").value = configEvento.anoEvento || "";
  document.getElementById("cfgTextoInicial").value = configEvento.textoInicial || "";

  document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
  if (configEvento.textoInicial){
    document.getElementById("subEvento").textContent = configEvento.textoInicial;
  } else if (configEvento.nomeEvento && configEvento.anoEvento){
    document.getElementById("subEvento").textContent = "Inscri√ß√µes para o " + configEvento.nomeEvento + " " + configEvento.anoEvento;
  }

  atualizarStatusInscricoes();
  atualizarDisponibilidadeModalidades();
}

/* SALVAR CONFIG */

async function salvarConfiguracoes(){
  if (!isAdmin){
    alert("Apenas o administrador pode salvar as configura√ß√µes.");
    return;
  }
  const dataLimite = (document.getElementById("cfgDataLimite").value || "").trim();
  const msgEnc = (document.getElementById("cfgMsgEncerradas").value || "").trim();
  const bloquearAgora = document.getElementById("cfgBloquearAgora").checked;

  const limAluno = parseInt(document.getElementById("cfgLimitePorAluno").value,10) || LIMITE_MODALIDADES_POR_ALUNO;
  const limQueimadaTot = parseInt(document.getElementById("cfgQueimadaTotal").value,10) || LIMITE_QUEIMADA_TOTAL;
  const limQueimadaSex = parseInt(document.getElementById("cfgQueimadaSexo").value,10) || LIMITE_QUEIMADA_POR_SEXO;

  const limFutsal = parseInt(document.getElementById("cfgFutsal").value,10) || LIMITE_MODALIDADE_TURMA["FUTSAL"];
  const limDomino = parseInt(document.getElementById("cfgDomino").value,10) || LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
  const limFutmesa = parseInt(document.getElementById("cfgFutmesa").value,10) || LIMITE_MODALIDADE_TURMA["FUTMESA"];
  const limTenis = parseInt(document.getElementById("cfgTenis").value,10) || LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
  const limXadrez = parseInt(document.getElementById("cfgXadrez").value,10) || LIMITE_MODALIDADE_TURMA["XADREZ"];
  const limVolei = parseInt(document.getElementById("cfgVolei").value,10) || LIMITE_MODALIDADE_TURMA["VOLEI"];

  const nomeEvento = (document.getElementById("cfgNomeEvento").value || "").trim();
  const anoEvento = (document.getElementById("cfgAnoEvento").value || "").trim();
  const textoInicial = (document.getElementById("cfgTextoInicial").value || "").trim();

  const limitesModalidadeTurma = {
    "FUTSAL": limFutsal,
    "DOMIN√ì": limDomino,
    "FUTMESA": limFutmesa,
    "T√äNIS DE MESA": limTenis,
    "XADREZ": limXadrez,
    "VOLEI": limVolei
  };

  try{
    await db.collection("config").doc("geral").set({
      dataLimiteInscricao: dataLimite || null,
      mensagemEncerradas: msgEnc,
      bloquearInscricoesAgora: bloquearAgora,
      limiteModalidadesPorAluno: limAluno,
      limiteQueimadaTotal: limQueimadaTot,
      limiteQueimadaPorSexo: limQueimadaSex,
      limitesModalidadeTurma: limitesModalidadeTurma,
      nomeEvento: nomeEvento,
      anoEdicao: anoEvento,
      textoInicial: textoInicial
    }, { merge:true });

    configEvento.dataLimite = dataLimite || null;
    configEvento.msgEncerradas = msgEnc;
    configEvento.bloquearAgora = bloquearAgora;
    LIMITE_MODALIDADES_POR_ALUNO = limAluno;
    LIMITE_QUEIMADA_TOTAL = limQueimadaTot;
    LIMITE_QUEIMADA_POR_SEXO = limQueimadaSex;
    LIMITE_MODALIDADE_TURMA = limitesModalidadeTurma;
    configEvento.nomeEvento = nomeEvento;
    configEvento.anoEvento = anoEvento;
    configEvento.textoInicial = textoInicial;

    document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
    if (configEvento.textoInicial){
      document.getElementById("subEvento").textContent = configEvento.textoInicial;
    }

    atualizarStatusInscricoes();
    atualizarDisponibilidadeModalidades();
    alert("Configura√ß√µes salvas com sucesso.");
  }catch(e){
    console.error(e);
    alert("Erro ao salvar configura√ß√µes.");
  }
}

/* ========== AUTORIZA√á√ïES (NOVO) ========== */

// Abre modal e preenche turmas
function abrirModalAutorizacao(){
  const sel = document.getElementById('autTurmaSelect');
  sel.innerHTML = '';
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = 'Selecione a turma...';
  sel.appendChild(defaultOpt);
  TODAS_TURMAS.forEach(t => {
    const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o);
  });
  document.getElementById('autModalidadesArea').innerHTML = '';
  // adicionar linhas para cada modalidade
  MODALIDADES.forEach(m => {
    const div = document.createElement('div');
    div.className = 'aut-row';
    div.style.justifyContent = 'space-between';
    const left = document.createElement('div');
    left.style.flex = '1';
    left.innerHTML = '<strong>'+m+'</strong><div style="font-size:0.82rem;color:#555;">'+(m==='QUEIMADA MISTA' ? 'Override permite aceitar independentemente de limites por sexo/total.' : 'Override permite aceitar mesmo que modalidade esteja lotada para a turma.')+'</div>';
    const right = document.createElement('div');
    right.style.display = 'flex'; right.style.gap = '6px'; right.style.alignItems = 'center';

    const chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = 'aut_chk_'+m.replace(/\s+/g,'_'); chk.dataset.mod = m;
    const note = document.createElement('input'); note.type = 'text'; note.placeholder = 'Observa√ß√£o (ex: 5M/5F)'; note.id = 'aut_note_'+m.replace(/\s+/g,'_'); note.style.minWidth = '220px';

    right.appendChild(chk); right.appendChild(note);

    div.appendChild(left); div.appendChild(right);
    document.getElementById('autModalidadesArea').appendChild(div);
  });

  // prefill quando selecionar turma
  document.getElementById('autTurmaSelect').addEventListener('change', async (e) => {
    const turma = e.target.value;
    if (!turma) return;
    await carregarAutorizacoesNoModal(turma);
  });

  document.getElementById('autStatus').textContent = '';
  document.getElementById('modalAutorizacao').style.display = 'flex';
}

async function carregarAutorizacoesNoModal(turma){
  const doc = await db.collection('autorizacoes').doc(turma).get();
  // limpar
  MODALIDADES.forEach(m => {
    const k = m.replace(/\s+/g,'_');
    const chk = document.getElementById('aut_chk_'+k);
    const note = document.getElementById('aut_note_'+k);
    if (chk) chk.checked = false;
    if (note) note.value = '';
  });
  if (!doc.exists) return;
  const data = doc.data() || {};
  MODALIDADES.forEach(m => {
    const obj = data[m] || {};
    const k = m.replace(/\s+/g,'_');
    const chk = document.getElementById('aut_chk_'+k);
    const note = document.getElementById('aut_note_'+k);
    if (chk) chk.checked = !!obj.override;
    if (note) note.value = obj.note || '';
  });
}

async function salvarAutorizacoesDoModal(){
  const turma = document.getElementById('autTurmaSelect').value;
  if (!turma){ alert('Selecione a turma.'); return; }
  const payload = {};
  MODALIDADES.forEach(m => {
    const k = m.replace(/\s+/g,'_');
    const chk = document.getElementById('aut_chk_'+k);
    const note = document.getElementById('aut_note_'+k);
    payload[m] = {
      override: !!(chk && chk.checked),
      note: (note && note.value) ? note.value.trim() : null
    };
  });

  try{
    await db.collection('autorizacoes').doc(turma).set(payload, { merge:true });
    // log
    await db.collection('autorizacoes_logs').add({
      turma: turma,
      data: payload,
      savedBy: currentRole || (isAdmin? 'ADMIN':'UNKNOWN'),
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('autStatus').textContent = 'Autoriza√ß√£o salva com sucesso.';
    // update cache will be automatic via onSnapshot listener
  }catch(e){
    console.error(e);
    document.getElementById('autStatus').textContent = 'Erro ao salvar autoriza√ß√£o.';
  }
}

/* ========== DISPONIBILIDADE MODALIDADES ========== */

function atualizarDisponibilidadeModalidades(){
  const turma = document.getElementById("turma").value;
  const sexo = document.getElementById("sexo").value;
  const spans = document.querySelectorAll(".modalidade-vagas");
  const chks = document.querySelectorAll(".chkModalidade");

  spans.forEach(span => {
    const mod = span.dataset.mod;
    if (!turma){
      span.textContent = mod + " (selecione turno e turma)";
      span.classList.remove("modalidade-lotado");
      return;
    }

    const override = autorizacoesCache[turma] && autorizacoesCache[turma][mod] && autorizacoesCache[turma][mod].override === true;
    const note = autorizacoesCache[turma] && autorizacoesCache[turma][mod] && autorizacoesCache[turma][mod].note;

    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0, Feminino:0};
      if (override){
        span.textContent = mod + " (AUTORIZADO" + (note?": "+note:"") + ") ‚Äî "+tot+"/"+LIMITE_QUEIMADA_TOTAL+" / Meninos: "+gen.Masculino+"/"+LIMITE_QUEIMADA_POR_SEXO+" / Meninas: "+gen.Feminino+"/"+LIMITE_QUEIMADA_POR_SEXO;
        span.classList.remove("modalidade-lotado");
      } else {
        span.textContent = mod + " ("+tot+"/"+LIMITE_QUEIMADA_TOTAL+" / Meninos: "+gen.Masculino+"/"+LIMITE_QUEIMADA_POR_SEXO+" / Meninas: "+gen.Feminino+"/"+LIMITE_QUEIMADA_POR_SEXO+")";
        if (tot >= LIMITE_QUEIMADA_TOTAL) span.classList.add("modalidade-lotado");
        else span.classList.remove("modalidade-lotado");
      }
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (override){
        span.textContent = mod + " (AUTORIZADO" + (note?": "+note:"") + ") ‚Äî "+qtd+"/"+lim+" vagas";
        span.classList.remove("modalidade-lotado");
      } else {
        span.textContent = mod + " ("+qtd+"/"+lim+" vagas)";
        if (qtd >= lim) span.classList.add("modalidade-lotado");
        else span.classList.remove("modalidade-lotado");
      }
    }
  });

  chks.forEach(chk => {
    const mod = chk.value;
    if (!turma){
      chk.disabled = true;
      chk.checked = false;
      return;
    }

    const override = autorizacoesCache[turma] && autorizacoesCache[turma][mod] && autorizacoesCache[turma][mod].override === true;

    if (override){
      // se houver autoriza√ß√£o para a modalidade nesta turma, sempre permitir checar
      chk.disabled = false;
      return;
    }

    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0, Feminino:0};
      if (!sexo || tot >= LIMITE_QUEIMADA_TOTAL){
        chk.disabled = true; chk.checked = false; return;
      }
      if (sexo === "Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO){
        chk.disabled = true; chk.checked = false; return;
      }
      if (sexo === "Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO){
        chk.disabled = true; chk.checked = false; return;
      }
      chk.disabled = false;
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim){
        chk.disabled = true; chk.checked = false;
      } else {
        chk.disabled = false;
      }
    }
  });
}

/* ========== INSCRI√á√ÉO (AJUSTADA PARA CHECAR AUTORIZA√á√ïES) ========== */

async function handleSubmitInscricao(e){
  e.preventDefault();
  if (inscricoesEncerradas){
    msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false);
    return;
  }
  if (!emailAtual || !validarEmail(emailAtual)){
    alert("Informe um e-mail v√°lido antes de se inscrever.");
    return;
  }

  const nome = document.getElementById("nome").value.trim();
  const sexo = document.getElementById("sexo").value;
  const turno = document.getElementById("turno").value;
  const turma = document.getElementById("turma").value;
  const camisaNumero = document.getElementById("camisaNumero").value.trim();
  const observacoes = document.getElementById("observacoes").value.trim();

  const nomeNorm = normalizarNome(nome);
  if (!nome || !sexo || !turno || !turma){
    msgForm("Preencha nome, sexo, turno e turma.", false);
    return;
  }

  const chks = document.querySelectorAll(".chkModalidade:checked");
  const mods = [];
  chks.forEach(chk => mods.push(chk.value));
  if (!mods.length){
    msgForm("Escolha pelo menos 1 modalidade.", false);
    return;
  }
  if (mods.length > LIMITE_MODALIDADES_POR_ALUNO){
    msgForm("Voc√™ s√≥ pode escolher at√© "+LIMITE_MODALIDADES_POR_ALUNO+" modalidades.", false);
    return;
  }

  for (const ins of todasInscricoes){
    if (ins.nomeNormalizado === nomeNorm && ins.turma === turma){
      msgForm("J√° existe inscri√ß√£o para este nome nesta turma.", false);
      return;
    }
  }

  for (const mod of mods){
    // Se existir autoriza√ß√£o para essa turma+modalidade, permite independentemente dos limites
    const override = autorizacoesCache[turma] && autorizacoesCache[turma][mod] && autorizacoesCache[turma][mod].override === true;
    if (override) continue; // pula valida√ß√µes para essa modalidade

    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0,Feminino:0};
      if (tot >= LIMITE_QUEIMADA_TOTAL){
        msgForm("QUEIMADA MISTA est√° lotada para a turma "+turma+".", false); return;
      }
      if (sexo === "Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO){
        msgForm("Limite de meninos na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return;
      }
      if (sexo === "Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO){
        msgForm("Limite de meninas na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return;
      }
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim){
        msgForm('A modalidade "'+mod+'" est√° lotada para a turma '+turma+".", false); return;
      }
    }
  }

  try{
    await db.collection("inscricoes").add({
      nome: nome,
      nomeNormalizado: nomeNorm,
      email: emailAtual,
      sexo: sexo,
      turno: turno,
      turma: turma,
      camisaNumero: camisaNumero || null,
      modalidades: mods,
      observacoes: observacoes || null,
      naoAutorizadoPor: [], // indica√ß√µes de professores
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgForm("Inscri√ß√£o realizada com sucesso! ‚úÖ", true);
    document.getElementById("formInscricao").reset();
    document.getElementById("turma").innerHTML = '<option value="">Selecione o turno primeiro...</option>';
    document.getElementById("turma").disabled = true;
    atualizarDisponibilidadeModalidades();
  }catch(err){
    console.error(err);
    msgForm("Erro ao salvar inscri√ß√£o. Tente novamente.", false);
  }
}

/* CANCELAR INSCRI√á√ÉO (ADMIN) - unchanged */

async function cancelarInscricao(){
  if (!isAdmin){
    alert("Apenas o administrador pode cancelar inscri√ß√µes.");
    return;
  }
  const sel = document.getElementById("selectCancelar");
  const raw = sel.value;
  if (!raw){
    alert("Selecione uma inscri√ß√£o."); return;
  }
  const partes = raw.split("|||");
  const id = partes[0];
  const modalidadeSelecionada = partes[1] || null;

  const ins = todasInscricoes.find(i => i.id === id);
  if (!ins){
    alert("Inscri√ß√£o n√£o encontrada."); return;
  }

  if (!modalidadeSelecionada){
    alert("Modalidade inv√°lida."); return;
  }

  const mensagemConfirm = 'Cancelar a modalidade "'+modalidadeSelecionada+'" do aluno "'+ins.nome+'" da turma '+ins.turma+'?\n\nSe esta for a √∫nica modalidade, a inscri√ß√£o inteira ser√° removida.';
  if (!confirm(mensagemConfirm)) return;

  try{
    const modalidadesAtuais = Array.isArray(ins.modalidades) ? ins.modalidades.slice() : [];
    const filtradas = modalidadesAtuais.filter(m => m !== modalidadeSelecionada);

    if (filtradas.length === 0){
      await db.collection("inscricoes").doc(id).delete();
      alert("Inscri√ß√£o completa cancelada.");
    } else {
      await db.collection("inscricoes").doc(id).update({
        modalidades: filtradas
      });
      alert("Modalidade cancelada com sucesso.");
    }
  }catch(e){
    console.error(e);
    alert("Erro ao cancelar inscri√ß√£o.");
  }
}

/* ========== TABELAS / RENDERS / JOGOS / ETC ========== */
// ... (mantive o restante do c√≥digo original sem altera√ß√µes significativas para brevidade)

/* ========== LISTENERS FIRESTORE (ADAPTED TO INCLUDE AUTORIZACOES) ========== */

function iniciarListeners(){
  // Professores (acesso)
  db.collection("professoresAcesso").onSnapshot(snap => {
    todosProfessores = [];
    snap.forEach(doc => {
      const d = doc.data();
      todosProfessores.push({
        id: doc.id,
        nome: d.nome || "",
        tipo: d.tipo || "Professor",
        senha: d.senha || ""
      });
    });
    renderProfessoresAdmin();
  });

  // INSCRI√á√ïES
  db.collection("inscricoes").orderBy("timestamp","asc").onSnapshot(snap => {
    todasInscricoes = [];
    countsPorTurmaModalidade = {};
    countsQueimadaGenero = {};
    snap.forEach(doc => {
      const d = doc.data();
      const ins = {
        id: doc.id,
        nome: d.nome || "",
        nomeNormalizado: d.nomeNormalizado || normalizarNome(d.nome || ""),
        email: d.email || "",
        sexo: d.sexo || "",
        turno: d.turno || "",
        turma: d.turma || "",
        camisaNumero: d.camisaNumero || "",
        modalidades: d.modalidades || [],
        observacoes: d.observacoes || "",
        naoAutorizadoPor: d.naoAutorizadoPor || [],
        timestamp: d.timestamp
      };
      todasInscricoes.push(ins);

      if (!countsPorTurmaModalidade[ins.turma]) countsPorTurmaModalidade[ins.turma] = {};
      ins.modalidades.forEach(m => {
        if (!countsPorTurmaModalidade[ins.turma][m]) countsPorTurmaModalidade[ins.turma][m] = 0;
        countsPorTurmaModalidade[ins.turma][m]++;
        if (m === "QUEIMADA MISTA"){
          if (!countsQueimadaGenero[ins.turma]) countsQueimadaGenero[ins.turma] = {Masculino:0, Feminino:0};
          if (ins.sexo === "Masculino") countsQueimadaGenero[ins.turma].Masculino++;
          if (ins.sexo === "Feminino") countsQueimadaGenero[ins.turma].Feminino++;
        }
      });
    });
    atualizarDisponibilidadeModalidades();
    atualizarSelectsAdminPublico();
    renderPublico();
    renderAdmin();
    renderRelatorio();
    if (currentRole && currentRole !== "ADMIN"){
      renderPainelProfessores();
    }
  });

  // JOGOS
  db.collection("jogos").orderBy("dataJogo","asc").onSnapshot(snap => {
    todosJogos = [];
    snap.forEach(doc => {
      const d = doc.data();
      let p1 = d.placar1;
      let p2 = d.placar2;
      if (typeof p1 === "string") p1 = parseInt(p1,10);
      if (typeof p2 === "string") p2 = parseInt(p2,10);
      todosJogos.push({
        id: doc.id,
        turno: d.turno || "",
        serie: d.serie || "",
        turma1: d.turma1 || "",
        turma2: d.turma2 || "",
        dataJogo: d.dataJogo || "",
        modalidade: d.modalidade || "",
        horarioJogo: d.horarioJogo || "",
        localJogo: d.localJogo || "",
        status: d.status || "AGENDADO",
        placar1: Number.isFinite(p1) ? p1 : 0,
        placar2: Number.isFinite(p2) ? p2 : 0
      });
    });
    atualizarSelectExcluirJogo();
    renderJogosAluno();
    renderPlacarAoVivo();
    renderClassificacao();
    renderAdminJogos();
  });

  // AUTORIZA√á√ïES: mant√©m 
