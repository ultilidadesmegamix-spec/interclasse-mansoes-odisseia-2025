<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Bcrypt para hashing das senhas das c√¢meras -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }

    header {
      background: #1e88e5;
      padding: 15px;
      color: white;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    nav {
      background: white;
      display: flex;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      overflow-x: auto;
    }

    nav button {
      padding: 10px 14px;
      background: #eee;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    nav button.active {
      background: #1e88e5;
      color: white;
    }

    section {
      display: none;
      padding: 20px;
    }

    /* NOVOS ESTILOS DO SISTEMA DE TRANSMISS√ÉO */
    .camera-card {
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      background: white;
      margin-bottom: 10px;
    }

    .camera-card h4 {
      margin: 0 0 8px 0;
      padding: 0;
    }

    .live-video-container {
      width: 100%;
      background: #222;
      height: 260px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 12px;
      position: relative;
    }

    .live-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: black;
    }

    .placar-overlay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 22px;
      font-weight: bold;
      z-index: 20;
    }

    .thumbnail-list {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      margin-top: 10px;
    }

    .thumbnail-item {
      width: 120px;
      height: 90px;
      background: #000;
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .thumbnail-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnail-item.active {
      border-color: #1e88e5;
    }

  </style>
</head>

<body>

<header>Movimenta Odisseia ‚Äî Sistema de Inscri√ß√µes & Transmiss√£o Ao Vivo</header>

<!-- MENU SUPERIOR -->
<nav>
  <button onclick="abrirSecao('secInscricao')" class="active">Inscri√ß√µes</button>
  <button onclick="abrirSecao('secJogos')">Jogos</button>
  <button onclick="abrirSecao('secRelatorio')">Relat√≥rio</button>
  <button onclick="abrirSecao('secProfessores')">Professores</button>
  <button onclick="abrirSecao('secAdmin')">Admin</button>
  <button onclick="abrirSecao('secAoVivo')">AO VIVO üé•</button>
</nav>

<!-- IN√çCIO DO BODY ‚Äî AS SE√á√ïES V√äM NA PARTE 2 -->
<!-- ============================
     SE√á√ÉO: INSCRI√á√ïES
=============================== -->
<section id="secInscricao" style="display:block;">
  <h2>Inscri√ß√µes</h2>

  <form id="formInscricao">
    <label>Nome:</label><br>
    <input type="text" id="nomeAluno" required><br><br>

    <label>Turma:</label><br>
    <select id="turmaAluno" required>
      <option value="">Selecione</option>
      <option value="101">101</option>
      <option value="102">102</option>
      <option value="103">103</option>
      <option value="201">201</option>
      <option value="202">202</option>
      <option value="203">203</option>
      <option value="301">301</option>
      <option value="302">302</option>
      <option value="303">303</option>
    </select><br><br>

    <label>Modalidade:</label><br>
    <select id="modalidadeAluno" required>
      <option value="">Selecione</option>
      <option value="Futsal">Futsal</option>
      <option value="Queimada">Queimada</option>
      <option value="Basquete">Basquete</option>
    </select><br><br>

    <button type="submit">Enviar inscri√ß√£o</button>
  </form>
</section>

<!-- ============================
     SE√á√ÉO: JOGOS
=============================== -->
<section id="secJogos">
  <h2>Jogos</h2>

  <div id="listaJogos">
    <!-- A lista de jogos cadastrados ser√° carregada aqui via JS -->
  </div>

  <br>
  <h3>Cadastrar Novo Jogo</h3>

  <form id="formJogo">
    <label>Turma A:</label><br>
    <input type="text" id="turmaA" required><br><br>

    <label>Turma B:</label><br>
    <input type="text" id="turmaB" required><br><br>

    <label>Modalidade:</label><br>
    <select id="modalidadeJogo" required>
      <option value="">Selecione</option>
      <option value="Futsal">Futsal</option>
      <option value="Basquete">Basquete</option>
      <option value="Queimada">Queimada</option>
    </select><br><br>

    <label>Data:</label><br>
    <input type="date" id="dataJogo" required><br><br>

    <label>Hor√°rio:</label><br>
    <input type="time" id="horaJogo" required><br><br>

    <button type="submit">Cadastrar jogo</button>
  </form>
</section>

<!-- ============================
     SE√á√ÉO: RELAT√ìRIO
=============================== -->
<section id="secRelatorio">
  <h2>Relat√≥rios</h2>

  <button onclick="gerarRelatorio()">Gerar relat√≥rio de inscri√ß√µes</button>

  <div id="relatorioConteudo" style="margin-top:20px;">
    <!-- O relat√≥rio ser√° gerado aqui -->
  </div>
</section>

<!-- ============================
     SE√á√ÉO: PROFESSORES
=============================== -->
<section id="secProfessores">
  <h2>Professores</h2>

  <form id="formProfessor">
    <label>Nome:</label><br>
    <input type="text" id="nomeProfessor" required><br><br>

    <label>Turma:</label><br>
    <input type="text" id="turmaProfessor" required><br><br>

    <button type="submit">Cadastrar professor</button>
  </form>

  <h3>Lista de Professores</h3>
  <div id="listaProfessores"></div>
</section>

<!-- ============================
     SE√á√ÉO: √ÅREA ADMIN
=============================== -->
<section id="secAdmin">
  <h2>√Årea Administrativa</h2>

  <label>Senha do Administrador:</label><br>
  <input type="password" id="senhaAdmin"><br><br>

  <button onclick="entrarAdmin()">Entrar</button>

  <div id="painelAdmin" style="display:none; margin-top:20px;">
    <h3>Painel do Administrador</h3>

    <p>Selecione uma aba acima para gerenciar o sistema.</p>
  </div>
</section>

<!-- ====================================
     SE√á√ÉO: AO VIVO (A SER COMPLETADA)
     ‚Äî PARTE 4 IR√Å ADICIONAR TODO O SISTEMA
======================================= -->
<section id="secAoVivo">
  <h2>Transmiss√£o Ao Vivo</h2>

  <div id="containerAoVivo">
    <p style="background:#333;color:white;padding:20px;border-radius:6px;text-align:center;">
      O v√≠deo ao vivo e o placar aparecer√£o aqui ap√≥s a ativa√ß√£o do ADM.
    </p>
  </div>
</section>
<!-- =====================================================
     NOVA √ÅREA DO ADMIN ‚Äî TRANSMISS√ÉO + GRAVA√á√ÉO
====================================================== -->

<section id="secAdminTransmissao" style="display:none;">
  <h2>üì° Transmiss√£o de Jogos</h2>

  <p>Selecione um jogo abaixo para iniciar ou gerenciar a transmiss√£o ao vivo.</p>

  <div id="listaJogosTransmissao"></div>
</section>

<section id="secAdminGravacao" style="display:none;">
  <h2>üé• Cadastro de C√¢meras / Gravadores</h2>

  <h3>Cadastrar Nova C√¢mera</h3>

  <label>Nome da c√¢mera:</label><br>
  <input type="text" id="nomeCamera"><br><br>

  <button onclick="criarCamera()">Criar c√¢mera</button>

  <div id="resultadoCriarCamera" style="margin-top:15px; font-weight:bold;"></div>

  <hr><br>

  <h3>C√¢meras cadastradas</h3>
  <div id="listaCameras"></div>

  <hr><br>

  <h3>Entrar como Gravador</h3>

  <label>ID da c√¢mera:</label><br>
  <input type="text" id="gravadorCameraId"><br><br>

  <label>Senha:</label><br>
  <input type="password" id="gravadorSenha"><br><br>

  <button onclick="entrarComoGravador()">Entrar</button>

  <div id="resultadoGravador" style="margin-top:15px; font-weight:bold;"></div>
</section>

<!-- =====================================================
     TELA DO GRAVADOR (CINEGRAFISTA)
====================================================== -->
<section id="secGravador" style="display:none;">
  <h2>üé• √Årea do Gravador</h2>

  <p id="gravadorInfo"></p>

  <button onclick="iniciarTransmissao()">Iniciar transmiss√£o</button>
  <button onclick="pararTransmissao()" style="background:#d9534f;color:white;">Parar</button>

  <div class="live-video-container" style="margin-top:20px;">
    <video id="previewGravador" autoplay muted playsinline></video>
  </div>
</section>


<!-- =====================================================
     BOT√ïES EXTRAS DO ADMIN PARA ABRIR AS NOVAS √ÅREAS
====================================================== -->

<script>
function entrarAdmin() {
  const senha = document.getElementById("senhaAdmin").value;

  if (senha === "ADMIN123") {  // SUA SENHA ATUAL DO ADMIN
    document.getElementById("painelAdmin").style.display = "block";

    // ATIVAR NOVAS ABAS DO ADMIN
    adicionarBotaoAdmin("Transmiss√£o", "secAdminTransmissao");
    adicionarBotaoAdmin("Grava√ß√£o", "secAdminGravacao");

    carregarCameras();
    carregarJogosTransmissao();

  } else {
    alert("Senha incorreta.");
  }
}

function adicionarBotaoAdmin(nome, secaoId) {
  let nav = document.querySelector("nav");
  let btn = document.createElement("button");
  btn.innerText = nome;
  btn.onclick = () => abrirSecao(secaoId);
  nav.appendChild(btn);
}
</script>
<!-- ===========================
  PARTE 4/6 - PLAYER AO VIVO & TROCA DE C√ÇMERAS
  - Player p√∫blico que atualiza quando o ADM troca de c√¢mera
  - Painel ADMIN para escolher c√¢mera ativa por jogo
  - Suporte b√°sico de WebRTC signaling via Firestore (POC/testes)
=========================== -->

<!-- 1) √Årea P√∫blica: Player ao vivo -->
<section class="card" id="secTransmissaoPublica">
  <h2>Transmiss√£o ao vivo</h2>
  <small>Assista √† transmiss√£o oficial do jogo escolhido pelo administrador.</small>

  <div style="margin-top:8px;">
    <label for="selectTransmissaoJogos">Escolha o jogo (apenas para visualizar hist√≥rico):</label>
    <select id="selectTransmissaoJogos">
      <option value="">Selecione um jogo...</option>
    </select>
  </div>

  <div style="margin-top:12px;">
    <div id="liveStatusPublico" style="font-size:0.9rem; margin-bottom:8px;">Nenhuma transmiss√£o selecionada.</div>

    <!-- Player que receber√° a stream (HLS ou MediaStream) -->
    <video id="playerAoVivo" controls playsinline webkit-playsinline style="width:100%; max-height:560px; background:#000;"></video>

    <div id="infoCameraAtiva" style="margin-top:8px; font-size:0.9rem;"></div>
  </div>
</section>

<!-- 2) ADMIN ‚Äî painel de transmiss√£o (com troca de c√¢mera) -->
<!-- (Se j√° existe uma aba, este bloco s√≥ complementa e usa o mesmo container) -->
<div id="adminTransmissaoArea" style="display:none;">
  <h3>Gerenciar Transmiss√£o (ADMIN)</h3>
  <small>Selecione o jogo, veja c√¢meras cadastradas e marque a c√¢mera ATIVA.</small>

  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
    <div style="flex:1; min-width:220px;">
      <label>Jogo</label>
      <select id="adminSelectJogoTransmissao">
        <option value="">Selecione um jogo...</option>
      </select>
    </div>

    <div style="flex:1; min-width:220px;">
      <label>Estado da transmiss√£o</label>
      <select id="adminToggleLive">
        <option value="false">Offline</option>
        <option value="true">Ao vivo</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px;">
    <h4>C√¢meras cadastradas</h4>
    <div id="adminListaCameras"></div>
    <div style="margin-top:8px;">
      <small>Ao clicar em "Tornar principal", o player p√∫blico passar√° a exibir a c√¢mera selecionada.</small>
    </div>
  </div>
</div>

<script>
/* ========= Vari√°veis (usa o mesmo firebase/firestore do projeto j√° carregado) ========= */
const transmissoesCollection = db.collection("transmissoes"); // docs: jogoId -> { activeCameraId, isLive }
const camerasCollection = db.collection("cameras"); // docs: cameraId -> { nome, ownerId, streamUrl (opcional), createdAt }

/* ========= Fun√ß√µes: Carregar jogos para sele√ß√£o p√∫blica/admin ========= */
function popularSelectsJogosParaTransmissao(){
  const selPub = document.getElementById("selectTransmissaoJogos");
  const selAdmin = document.getElementById("adminSelectJogoTransmissao");
  if (!selPub || !selAdmin) return;

  selPub.innerHTML = '<option value="">Selecione um jogo...</option>';
  selAdmin.innerHTML = '<option value="">Selecione um jogo...</option>';

  // usa 'todosJogos' carregado por listeners existentes (parte 1/3)
  TODAS_TURMAS; // refer√™ncia para evitar linter
  (todosJogos || []).forEach(j => {
    const label = (j.modalidade || "")+" ‚Äî "+formatarDataBR(j.dataJogo)+" "+(j.horarioJogo || "")+" ‚Äî "+(j.turma1||"")+" x "+(j.turma2||"");
    const opt1 = document.createElement("option");
    opt1.value = j.id;
    opt1.textContent = label;
    selPub.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = j.id;
    opt2.textContent = label;
    selAdmin.appendChild(opt2);
  });
}

/* Quando jogos mudarem (listener j√° configurado na Parte 1/3), atualiza selects */
function atualizaSelectsTransmissaoAoAtualizarJogos(){
  popularSelectsJogosParaTransmissao();
}

/* ======= PUBLIC VIEW: ouvir altera√ß√µes da transmiss√£o selecionada e reproduzir ======= */

let listenerTransmissaoPublic = null;
let currentViewerPC = null; // PeerConnection (se usarmos WebRTC viewer)
let currentPlayerVideo = document.getElementById("playerAoVivo");
const infoCameraEl = document.getElementById("infoCameraAtiva");
const liveStatusPublico = document.getElementById("liveStatusPublico");

document.getElementById("selectTransmissaoJogos").addEventListener("change", e => {
  const jogoId = e.target.value;
  if (!jogoId){
    if (listenerTransmissaoPublic) { listenerTransmissaoPublic(); listenerTransmissaoPublic = null; }
    liveStatusPublico.textContent = "Nenhuma transmiss√£o selecionada.";
    currentPlayerVideo.pause();
    currentPlayerVideo.srcObject = null;
    currentPlayerVideo.src = "";
    infoCameraEl.textContent = "";
    return;
  }
  escutarTransmissaoPublico(jogoId);
});

function escutarTransmissaoPublico(jogoId){
  // remove listener anterior
  if (listenerTransmissaoPublic) { listenerTransmissaoPublic(); listenerTransmissaoPublic = null; }

  const docRef = transmissoesCollection.doc(jogoId);
  listenerTransmissaoPublic = docRef.onSnapshot(async snap => {
    if (!snap.exists){
      liveStatusPublico.textContent = "Transmiss√£o n√£o configurada para este jogo.";
      return;
    }
    const data = snap.data();
    const isLive = !!data.isLive;
    const activeCameraId = data.activeCameraId || null;

    liveStatusPublico.textContent = isLive ? "Transmiss√£o AO VIVO" : "Transmiss√£o OFFLINE";

    if (!activeCameraId){
      infoCameraEl.textContent = "Nenhuma c√¢mera ativa.";
      // limpa player
      try { stopViewerPeer(); } catch(e){}
      currentPlayerVideo.pause(); currentPlayerVideo.srcObject = null; currentPlayerVideo.src = "";
      return;
    }

    // buscar dados da c√¢mera
    const camDoc = await camerasCollection.doc(activeCameraId).get();
    if (!camDoc.exists){
      infoCameraEl.textContent = "C√¢mera removida ou inexistente.";
      return;
    }
    const cam = camDoc.data();
    infoCameraEl.textContent = "C√¢mera ativa: " + (cam.nome || activeCameraId);

    // Se a c√¢mera tem streamUrl (HLS/HTTP), usar direto
    if (cam.streamUrl){
      // se houver PeerConnection ativa, encerra
      stopViewerPeer();
      // usa URL direto
      try {
        currentPlayerVideo.srcObject = null;
        currentPlayerVideo.src = cam.streamUrl;
        currentPlayerVideo.play().catch(()=>{});
      } catch(e){
        console.error("Erro ao carregar streamUrl", e);
      }
      return;
    }

    // Caso contr√°rio, tentaremos abrir um viewer WebRTC (sinaliza√ß√£o via Firestore)
    // NOTE: Esse fluxo depende do gravador ter criado um "offer" / "answer" exchange via Firestore.
    // Implementamos viewer-side: criaremos um offer para o publisher, ou se o publisher espera oferta do viewer,
    // este c√≥digo √© um POC simples ‚Äî ajustes podem ser necess√°rios conforme o fluxo do publisher.
    try {
      await startViewerWebRTC(activeCameraId);
    } catch(e){
      console.error("Erro ao iniciar viewer WebRTC:",e);
    }
  });
}

/* ========== ADMIN: listar c√¢meras e permitir tornar uma ativa ========== */

function carregarListaCamerasAdmin(){
  const cont = document.getElementById("adminListaCameras");
  cont.innerHTML = "Carregando c√¢meras...";
  camerasCollection.orderBy("createdAt","asc").get().then(snap => {
    cont.innerHTML = "";
    if (snap.empty){
      cont.textContent = "Nenhuma c√¢mera cadastrada.";
      return;
    }
    snap.forEach(doc => {
      const d = doc.data();
      const row = document.createElement("div");
      row.className = "jogo-bloco";
      const nome = d.nome || doc.id;
      const info = document.createElement("div");
      info.innerHTML = "<strong>"+nome+"</strong><br>ID: "+doc.id+"<br>"+(d.streamUrl ? ("Stream URL: "+d.streamUrl) : "Sem URL (WebRTC)");
      row.appendChild(info);

      const botoes = document.createElement("div");
      botoes.style.marginTop = "6px";
      botoes.style.display = "flex";
      botoes.style.gap = "6px";

      const btnMakeActive = document.createElement("button");
      btnMakeActive.className = "btn btn-primaria";
      btnMakeActive.textContent = "Tornar principal";
      btnMakeActive.onclick = async () => {
        const jogoId = document.getElementById("adminSelectJogoTransmissao").value;
        if (!jogoId){ alert("Selecione primeiro o jogo no painel acima."); return; }
        try{
          await transmissoesCollection.doc(jogoId).set({ activeCameraId: doc.id }, { merge: true });
          alert("C√¢mera definida como ativa para o jogo.");
        }catch(e){
          console.error(e); alert("Erro ao definir c√¢mera ativa.");
        }
      };

      const btnPreview = document.createElement("button");
      btnPreview.className = "btn btn-primaria";
      btnPreview.textContent = "Preview";
      btnPreview.onclick = () => {
        // preview local: se streamUrl usa direto, sen√£o tenta WebRTC viewer
        if (d.streamUrl){
          currentPlayerVideo.srcObject = null;
          currentPlayerVideo.src = d.streamUrl;
          currentPlayerVideo.play().catch(()=>{});
        } else {
          // tenta conectar via WebRTC viewer (mesmo m√©todo de p√∫blico)
          startViewerWebRTC(doc.id).catch(err => console.error(err));
        }
      };

      botoes.appendChild(btnMakeActive);
      botoes.appendChild(btnPreview);
      row.appendChild(botoes);

      cont.appendChild(row);
    });
  }).catch(e => {
    console.error(e);
    cont.textContent = "Erro ao carregar c√¢meras.";
  });
}

/* atualiza bot√£o e lista quando selecionar jogo no admin */
document.getElementById("adminSelectJogoTransmissao").addEventListener("change", e => {
  const jogoId = e.target.value;
  if (!jogoId) {
    document.getElementById("adminTransmissaoArea").style.display = "none";
    return;
  }
  document.getElementById("adminTransmissaoArea").style.display = "block";
  // l√™ estado atual dessa transmiss√£o
  transmissoesCollection.doc(jogoId).get().then(snap => {
    if (snap.exists){
      const d = snap.data();
      document.getElementById("adminToggleLive").value = (!!d.isLive).toString();
    }
  }).catch(()=>{});
  carregarListaCamerasAdmin();
});

/* permitir admin ligar/desligar transmissao */
document.getElementById("adminToggleLive").addEventListener("change", e => {
  const jogoId = document.getElementById("adminSelectJogoTransmissao").value;
  if (!jogoId) { alert("Selecione primeiro o jogo."); return; }
  const val = e.target.value === "true";
  transmissoesCollection.doc(jogoId).set({ isLive: val }, { merge:true }).then(()=> {
    alert("Estado da transmiss√£o atualizado.");
  }).catch(e => { console.error(e); alert("Erro ao atualizar estado."); });
});

/* ========= WebRTC viewer (POC) - sinaliza√ß√£o via Firestore =========
   Fluxo (simplificado):
   - Viewer cria doc em "webrtc_signals/{cameraId}/viewers/{viewerId}"
   - Viewer escreve offer -> publisher (gravador) l√™, cria answer
   - Publisher escreve answer -> viewer aplica
   IMPORTANTE: este fluxo requer que o publisher (gravador) implemente a contrapartida.
============================================= */

async function startViewerWebRTC(cameraId){
  // limpa peer anterior
  stopViewerPeer();

  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
      // Em produ√ß√£o, inclua servidor TURN aqui
    ]
  });
  currentViewerPC = pc;

  // quando receber tracks do publisher, mostra no player
  pc.ontrack = (ev) => {
    console.log("Viewer recebeu track", ev);
    try {
      currentPlayerVideo.srcObject = ev.streams[0];
      currentPlayerVideo.play().catch(()=>{});
    } catch (e) { console.error(e); }
  };

  // ICE candidates locais -> escreve no Firestore
  const viewerId = db.collection("webrtc_signals").doc().id;
  const viewerRef = db.collection("webrtc_signals").doc(cameraId).collection("viewers").doc(viewerId);
  const candidatesLocalCol = viewerRef.collection("candidates_local");

  pc.onicecandidate = event => {
    if (event.candidate){
      candidatesLocalCol.add(JSON.parse(JSON.stringify(event.candidate))).catch(console.error);
    }
  };

  // Cria data channel opcional (caso queira sinais)
  const dataChannel = pc.createDataChannel("viewerChannel");
  dataChannel.onmessage = e => console.log("Mensagem do publisher:", e.data);

  // Criar offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await viewerRef.set({
    viewerId: viewerId,
    offer: offer.toJSON(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Escuta por answer do publisher
  const unsubAnswer = viewerRef.onSnapshot(async snap => {
    const data = snap.data();
    if (!data) return;
    if (data.answer){
      const ansDesc = new RTCSessionDescription(data.answer);
      await pc.setRemoteDescription(ansDesc).catch(console.error);
    }
  });

  // Escuta candidates remotos criados pelo publisher
  const candidatesRemoteCol = viewerRef.collection("candidates_remote");
  const unsubCandidates = candidatesRemoteCol.onSnapshot(snap => {
    snap.docChanges().forEach(change => {
      if (change.type === "added"){
        const c = change.doc.data();
        try {
          pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
        } catch (e) { console.error(e); }
      }
    });
  });

  // Para robustez, escuta se o publisher deletar o viewer doc -> encerra
  const unsubDelete = viewerRef.onSnapshot(snap => {
    if (!snap.exists){
      // publisher removeu sess√£o
      stopViewerPeer();
    }
  });

  // guarda cleanup
  pc._firestoreUnsub = () => {
    try { unsubAnswer(); } catch(e){}
    try { unsubCandidates(); } catch(e){}
    try { unsubDelete(); } catch(e){}
  };
}

/* parar viewer peer e limpar campos */
function stopViewerPeer(){
  if (currentViewerPC){
    try {
      if (currentViewerPC._firestoreUnsub) currentViewerPC._firestoreUnsub();
    } catch(e){}
    try { currentViewerPC.close(); } catch(e){}
    currentViewerPC = null;
  }
}

/* ========= FUN√á√ïES DE IN√çCIO (hook para init) ========= */

function initTransmissaoParte4(){
  // popula selects baseados em jogos
  popularSelectsJogosParaTransmissao();

  // popula admin cameras/jogos (quando admin abrir)
  // hook para abrir admin: j√° existe fun√ß√£o abrirAdmin(); depois de autenticar, chama:
  // carregarListaCamerasAdmin(); popularSelectsJogosParaTransmissao();
  // Para manter simples, vamos adicionar listeners que atualizam selects sempre que 'todosJogos' muda:
  // (nos listeners que atualizam todosJogos no projeto, chame atualizaSelectsTransmissaoAoAtualizarJogos)

  // carregar c√¢meras inicial (para o caso de algu√©m abrir se√ß√£o)
  carregarListaCamerasAdmin();

  // iniciar listener global opcional: quando transmissao de qualquer jogo muda, atualiza selects (n√£o obrigat√≥rio)
  transmissoesCollection.onSnapshot(() => {
    // sem bloqueantes: atualiza info das administra√ß√µes se abertas
    // (n√£o fazemos nada pesado aqui)
  });

  // Integra√ß√£o com o bot√£o de admin para mostrar op√ß√µes (caso esteja usando a vers√£o simplificada do Part3)
  // Se voc√™ quiser abrir o painel adminTransmissaoArea quando for admin:
  // document.getElementById("adminTransmissaoArea").style.display = isAdmin ? "block" : "none";

  // Quando os dados de jogos mudarem (o listener central j√° chama essa fun√ß√£o):
  // atualizaSelectsTransmissaoAoAtualizarJogos(); // chame a partir do listener de jogos
}

/* Chamar initTransmissaoParte4 no init() geral do app */
if (typeof init === "function"){
  // Se init() j√° for definido no seu arquivo (parte anterior), injetamos hook:
  const _oldInit = init;
  window.init = function(){
    _oldInit();
    initTransmissaoParte4();
    // vincular atualiza√ß√£o de selects quando 'todosJogos' mudar (o listener de jogos j√° popula 'todosJogos')
    // Se preferir, chame popularSelectsJogosParaTransmissao() sempre que todosJogos for atualizado no listener central.
  };
} else {
  // fallback se n√£o houver init global
  document.addEventListener("DOMContentLoaded", initTransmissaoParte4);
}

/* ===== FIM PARTE 4 ===== */
</script>
<!-- ===============================================
     PARTE 5/6 ‚Äî L√ìGICA DO GRAVADOR (PUBLISHER)
     - Captura de c√¢mera
     - Cria√ß√£o de OFFER
     - Firestore Signaling
     - Envio de ICE candidates
================================================ -->

<script>
/* ===================================================
   üîê 1. ENTRAR COMO GRAVADOR (VALIDA√á√ÉO DE SENHA)
=================================================== */

async function entrarComoGravador() {
  const cameraId = document.getElementById("gravadorCameraId").value.trim();
  const senha = document.getElementById("gravadorSenha").value.trim();
  const resultBox = document.getElementById("resultadoGravador");

  if (!cameraId || !senha) {
    resultBox.innerHTML = "Preencha todos os campos.";
    return;
  }

  const doc = await db.collection("cameras").doc(cameraId).get();

  if (!doc.exists) {
    resultBox.innerHTML = "C√¢mera n√£o encontrada.";
    return;
  }

  const dados = doc.data();

  if (!dados.hashSenha) {
    resultBox.innerHTML = "C√¢mera sem senha registrada.";
    return;
  }

  // Verifica hash com bcryptjs
  const ok = await bcrypt.compare(senha, dados.hashSenha);
  if (!ok) {
    resultBox.innerHTML = "Senha incorreta.";
    return;
  }

  // Liberado!
  cameraSelecionada = cameraId;
  resultBox.innerHTML = "Acesso liberado!";
  abrirSecao("secGravador");
  document.getElementById("gravadorInfo").innerHTML = `C√¢mera: <b>${dados.nome}</b> ‚Äî ID: ${cameraId}`;
}

/* ===================================================
   üé• 2. VARI√ÅVEIS GLOBAIS DO PUBLISHER
=================================================== */

let cameraSelecionada = null;
let publisherPC = null;          // PeerConnection do gravador
let localStream = null;          // Stream capturada
let unsubViewerCollection = null;

/* ===================================================
   üé• 3. INICIAR TRANSMISS√ÉO (GRAVADOR)
=================================================== */

async function iniciarTransmissao() {
  if (!cameraSelecionada) {
    alert("Nenhuma c√¢mera selecionada.");
    return;
  }

  // Captura da c√¢mera
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: false
    });

    document.getElementById("previewGravador").srcObject = localStream;

  } catch (e) {
    alert("Erro ao acessar c√¢mera: " + e);
    return;
  }

  // Cria PeerConnection
  publisherPC = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
      // Em produ√ß√£o: adicione um TURN aqui
    ]
  });

  // Envia tracks locais
  localStream.getTracks().forEach(track => publisherPC.addTrack(track, localStream));

  // ICE ‚Üí Firestore
  publisherPC.onicecandidate = event => {
    if (event.candidate) {
      const cand = JSON.parse(JSON.stringify(event.candidate));
      db.collection("webrtc_signals").doc(cameraSelecionada)
        .collection("publisherCandidates")
        .add(cand);
    }
  };

  // Criar OFFER do publisher
  const offer = await publisherPC.createOffer();
  await publisherPC.setLocalDescription(offer);

  await db.collection("live_cameras").doc(cameraSelecionada).set({
    cameraId: cameraSelecionada,
    offer: offer.toJSON(),
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Escutar VIEWERS que criam OFFER para o publisher
  escutarViewers(cameraSelecionada);

  alert("Transmiss√£o iniciada!");
}

/* ===================================================
   üé• 4. ESCUTAR VIEWERS (quem assiste)
=================================================== */

function escutarViewers(cameraId) {
  if (unsubViewerCollection) unsubViewerCollection();

  unsubViewerCollection = db.collection("webrtc_signals").doc(cameraId)
    .collection("viewers")
    .onSnapshot(async snap => {
      snap.docChanges().forEach(async change => {
        if (change.type === "added") {
          const viewerId = change.doc.id;
          const viewerData = change.doc.data();

          if (!viewerData.offer) return;

          // Cria conex√£o dedicada para esse viewer
          await responderViewer(cameraId, viewerId, viewerData.offer);
        }
      });
    });
}

/* ===================================================
   üé• 5. RESPONDER VIEWER (gera ANSWER)
=================================================== */

async function responderViewer(cameraId, viewerId, viewerOffer) {

  const pcViewer = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  // Envia tracks para o viewer
  localStream.getTracks().forEach(track => pcViewer.addTrack(track, localStream));

  // Envia ICE candidates ao viewer
  pcViewer.onicecandidate = event => {
    if (event.candidate) {
      db.collection("webrtc_signals").doc(cameraId)
       .collection("viewers").doc(viewerId)
       .collection("candidates_remote")
       .add(JSON.parse(JSON.stringify(event.candidate)));
    }
  };

  // Aplica oferta do viewer
  await pcViewer.setRemoteDescription(new RTCSessionDescription(viewerOffer));

  // Cria resposta (ANSWER)
  const answer = await pcViewer.createAnswer();
  await pcViewer.setLocalDescription(answer);

  await db.collection("webrtc_signals").doc(cameraId)
        .collection("viewers").doc(viewerId)
        .set({
          answer: answer.toJSON()
        }, { merge: true });

  // Escuta ICE candidates enviados pelo viewer
  db.collection("webrtc_signals").doc(cameraId)
    .collection("viewers").doc(viewerId)
    .collection("candidates_local")
    .onSnapshot(snap => {
      snap.docChanges().forEach(change => {
        if (change.type === "added") {
          const cand = change.doc.data();
          pcViewer.addIceCandidate(new RTCIceCandidate(cand)).catch(console.error);
        }
      });
    });
}

/* ===================================================
   üü• 6. PARAR TRANSMISS√ÉO DO PUBLISHER
=================================================== */

async function pararTransmissao() {
  if (publisherPC) {
    publisherPC.close();
    publisherPC = null;
  }

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
  }

  await db.collection("live_cameras").doc(cameraSelecionada).delete().catch(() => {});

  // Remove signaling
  await db.collection("webrtc_signals").doc(cameraSelecionada)
    .collection("publisherCandidates").get().then(snap => {
      snap.forEach(doc => doc.ref.delete());
    });

  await db.collection("webrtc_signals").doc(cameraSelecionada)
    .collection("viewers").get().then(snap => {
      snap.forEach(doc => doc.ref.delete());
    });

  alert("Transmiss√£o encerrada!");
}
</script>
<!-- ===============================================
     PARTE 6/6 ‚Äî FINAL DO HTML
     - Interface do Gravador
     - bcryptjs (verifica√ß√£o de senha)
     - Fun√ß√£o abrirSecao()
     - Event listeners finais
================================================ -->

<!-- ========== INTERFACE DO GRAVADOR (oculta at√© login) ========== -->
<section class="card" id="secGravador" style="display:none;">
  <h2>√Årea do Gravador</h2>
  <small>Use esta √°rea para conectar a c√¢mera (apenas com a senha gerada pelo ADM).</small>

  <div id="gravadorInfo" style="margin-bottom:8px; font-size:0.9rem; color:#333;"></div>

  <div style="display:grid; grid-template-columns: 1fr 260px; gap:10px; align-items:start;">
    <div>
      <label for="gravadorCameraId">ID da c√¢mera (fornecido pelo ADM)</label>
      <input type="text" id="gravadorCameraId" placeholder="Ex: cam-01" />

      <label for="gravadorSenha" style="margin-top:8px;">Senha</label>
      <input type="password" id="gravadorSenha" placeholder="Senha fornecida pelo ADM" />

      <div id="resultadoGravador" style="margin-top:8px; font-size:0.9rem; color:#b30000;"></div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primaria" id="btnEntrarGravador">üîì Entrar como gravador</button>
        <button class="btn btn-primaria" id="btnIniciarTransmissao" disabled>‚ñ∂Ô∏è Iniciar transmiss√£o</button>
        <button class="btn btn-primaria" id="btnPararTransmissao" disabled>‚èπ Parar transmiss√£o</button>
      </div>
    </div>

    <div>
      <label>Preview local</label>
      <video id="previewGravador" autoplay muted playsinline style="width:100%; border-radius:8px; border:1px solid var(--borda); background:#000; height:180px; object-fit:cover;"></video>
      <small style="display:block; margin-top:6px; color:#555;">
        O preview mostra o que ser√° enviado durante a transmiss√£o.
      </small>
    </div>
  </div>

  <div style="margin-top:10px; font-size:0.85rem; color:#333;">
    <strong>Observa√ß√µes:</strong>
    <ul style="margin:6px 0 0 18px;">
      <li>Somente a c√¢mera com ID e senha cadastrados pelo ADM poder√° transmitir.</li>
      <li>O ADM recebe a transmiss√£o via signaling e pode abrir viewers a partir do painel.</li>
      <li>Para seguran√ßa, a senha armazenada no Firestore deve ser o hash (o ADM gera e salva o hash).</li>
    </ul>
  </div>
</section>

<!-- ========== bcryptjs (para verificar a senha localmente) ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>

<script>
/* ===================================================
   FUN√á√ÉO abrirSecao - centraliza a troca de telas
   Usada em v√°rias partes do sistema (parcialmente usada antes)
=================================================== */
function abrirSecao(idSec) {
  // poss√≠veis se√ß√µes: inscricao, inscritos, jogos, classificados, placar, admin, professores, secGravador
  const secoes = ["inscricao","inscritos","jogos","classificados","placar","admin","professores","secGravador"];
  secoes.forEach(s => {
    const el = document.getElementById(s === "secGravador" ? "secGravador" : (s === "inscricao" ? "secInscricao" : "sec" + capitalizeFirstLetter(s)));
    if (el) el.style.display = (s === idSec ? "block" : "none");
  });
  // ajuste dos bot√µes header (texto)
  try {
    const btnInscritos = document.getElementById("btnToggleInscritos");
    if (btnInscritos) btnInscritos.textContent = (idSec === "inscritos") ? "‚¨Ö Voltar para inscri√ß√£o" : "üëÄ Ver inscritos";
    const btnVerJogos = document.getElementById("btnVerJogos");
    if (btnVerJogos) btnVerJogos.textContent = (idSec === "jogos") ? "‚¨Ö Voltar para inscri√ß√£o" : "üèÜ Ver jogos";
    const btnClass = document.getElementById("btnClassificados");
    if (btnClass) btnClass.textContent = (idSec === "classificados") ? "‚¨Ö Voltar para inscri√ß√£o" : "‚úÖ Classificados";
    const btnPlacar = document.getElementById("btnPlacarAoVivo");
    if (btnPlacar) btnPlacar.textContent = (idSec === "placar") ? "‚¨Ö Voltar para inscri√ß√£o" : "‚ö° Placar ao vivo";
  } catch(e){}
}

function capitalizeFirstLetter(s){
  if (!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* ===================================================
   Event listeners: conectar bot√µes da interface do gravador
   (essas fun√ß√µes usam as implementa√ß√µes da PARTE 5)
=================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const btnEntrar = document.getElementById("btnEntrarGravador");
  const btnIniciar = document.getElementById("btnIniciarTransmissao");
  const btnParar = document.getElementById("btnPararTransmissao");
  const resultado = document.getElementById("resultadoGravador");

  if (btnEntrar) {
    btnEntrar.addEventListener("click", async (ev) => {
      ev.preventDefault();
      resultado.style.color = "#b30000";
      resultado.textContent = "Validando...";
      try {
        // chama a fun√ß√£o definida na PARTE 5
        await entrarComoGravador();
        resultado.style.color = "#0c7a2a";
        resultado.textContent = "Acesso liberado. Pode iniciar a transmiss√£o.";
        btnIniciar.disabled = false;
      } catch(err) {
        console.error(err);
        resultado.style.color = "#b30000";
        resultado.textContent = "Erro ao entrar como gravador.";
      }
    });
  }

  if (btnIniciar) {
    btnIniciar.addEventListener("click", async (ev) => {
      ev.preventDefault();
      btnIniciar.disabled = true;
      btnParar.disabled = false;
      try {
        await iniciarTransmissao(); // fun√ß√£o da PARTE 5
      } catch(err){
        console.error(err);
        alert("Erro ao iniciar transmiss√£o: " + (err.message || err));
        btnIniciar.disabled = false;
        btnParar.disabled = true;
      }
    });
  }

  if (btnParar) {
    btnParar.addEventListener("click", async (ev) => {
      ev.preventDefault();
      btnParar.disabled = true;
      btnIniciar.disabled = false;
      try {
        await pararTransmissao(); // fun√ß√£o da PARTE 5
        document.getElementById("previewGravador").srcObject = null;
      } catch(err){
        console.error(err);
        alert("Erro ao parar transmiss√£o.");
      }
    });
  }
});

/* ===================================================
   Pequena ajuda: se algum dos IDs n√£o existir (por exemplo,
   se voc√™ colou partes em arquivos diferentes), o c√≥digo
   apenas ignora os listeners sem travar.
=================================================== */
</script>

<!-- ========== FIM DO DOCUMENTO ========== -->
</body>
</html>
