<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscrições Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #f0f4fb;
      color: var(--texto);
    }
    header {
      background: linear-gradient(90deg, var(--azul), #007bff);
      color: #fff;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header small {
      display: block;
      font-size: 0.8rem;
      opacity: .9;
    }
    .header-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primaria {
      background: #fff;
      color: var(--azul);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .btn-admin {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.6);
      color: #fff;
    }
    main {
      max-width: 1100px;
      margin: 18px auto 30px;
      padding: 0 10px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--borda);
      padding: 15px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      color: var(--azul);
    }
    .card small {
      font-size: 0.8rem;
      color: #555;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 768px){
      .grid-2{ grid-template-columns:1fr; }
    }
    .input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--borda);
      border-radius: 8px;
      margin-top: 6px;
    }
    .btn-acao {
      background: var(--azul);
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      margin-top: 10px;
    }
    .lista-inscricoes {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .item-inscricao {
      padding: 12px;
      border: 1px solid var(--borda);
      border-radius: 10px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-imprimir {
      background: var(--verde);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    #scanner-container {
      display: none;
      margin-top: 20px;
    }
    #preview {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1/1;
      border: 2px solid var(--azul);
      border-radius: 10px;
    }
    #resultado-scan {
      margin-top: 10px;
      padding: 12px;
      border: 1px solid var(--borda);
      border-radius: 10px;
      background: #fff;
    }
  </style>
</head>

<body>

<header>
  <div>
    <h1>Painel Administrativo</h1>
    <small>Gerenciamento de inscrições</small>
  </div>
  <div class="header-right">
    <button id="btnCredenciais" class="btn btn-primaria">Credenciais</button>
  </div>
</header>

<main>
  <section id="paginaCredenciais" class="card" style="display:none;">
    <h2>Credenciais</h2>

    <div class="grid-2">
      <div>
        <label>Turno</label>
        <select id="filtroTurno" class="input">
          <option value="">Todos</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
        </select>
      </div>

      <div>
        <label>Turma</label>
        <select id="filtroTurma" class="input">
          <option value="">Todas</option>
          <option value="6º">6º</option>
          <option value="7º">7º</option>
          <option value="8º">8º</option>
          <option value="9º">9º</option>
        </select>
      </div>

      <div>
        <label>Modalidade</label>
        <select id="filtroModalidade" class="input">
          <option value="">Todas</option>
          <option value="Futsal">Futsal</option>
          <option value="Queimada">Queimada</option>
          <option value="Vôlei">Vôlei</option>
        </select>
      </div>
    </div>

    <button id="btnAplicarFiltros" class="btn-acao">Aplicar filtros</button>

    <div class="lista-inscricoes" id="listaInscricoes"></div>

    <button id="btnAbrirScanner" class="btn-acao" style="background:var(--azul);margin-top:25px;">
      Escaneador
    </button>

    <div id="scanner-container">
      <video id="preview"></video>
      <div id="resultado-scan"></div>
    </div>
  </section>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:example"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const paginaCredenciais = document.getElementById("paginaCredenciais");
document.getElementById("btnCredenciais").onclick = () => {
  paginaCredenciais.style.display = "block";
};

document.getElementById("btnAplicarFiltros").onclick = async () => {
  const turno = document.getElementById("filtroTurno").value;
  const turma = document.getElementById("filtroTurma").value;
  const modalidade = document.getElementById("filtroModalidade").value;

  let ref = db.collection("inscricoes");
  if (turno) ref = ref.where("turno","==",turno);
  if (turma) ref = ref.where("turma","==",turma);
  if (modalidade) ref = ref.where("modalidade","==",modalidade);

  const snap = await ref.get();
  const lista = document.getElementById("listaInscricoes");
  lista.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.className = "item-inscricao";
    div.innerHTML = `
      <div>
        <strong>${d.nome}</strong><br>
        ${d.turno} • ${d.turma} • ${d.modalidade}<br>
        ID: ${doc.id}
      </div>
      <button class="btn-imprimir" onclick="imprimir('${doc.id}','${d.nome}','${d.turno}','${d.turma}','${d.modalidade}')">
        Imprimir Credencial
      </button>
    `;
    lista.appendChild(div);
  });
};

window.imprimir = (id,nome,turno,turma,modalidade) => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(18);
  pdf.text("Credencial de Participante", 10, 20);

  pdf.setFontSize(12);
  pdf.text(`Nome: ${nome}`, 10, 40);
  pdf.text(`Turno: ${turno}`, 10, 50);
  pdf.text(`Turma: ${turma}`, 10, 60);
  pdf.text(`Modalidade: ${modalidade}`, 10, 70);
  pdf.text(`ID: ${id}`, 10, 80);

  const tempDiv = document.createElement("div");
  new QRCode(tempDiv, { text: id, width: 150, height: 150 });
  const img = tempDiv.querySelector("img").src;

  pdf.addImage(img, "PNG", 130, 40, 50, 50);
  pdf.save(`credencial_${nome}.pdf`);
};

document.getElementById("btnAbrirScanner").onclick = async () => {
  const senha = prompt("Digite a senha do administrador:");
  if (senha !== "admin") return;

  document.getElementById("scanner-container").style.display = "block";

  const stream = await navigator.mediaDevices.getUserMedia({ video:true });
  const video = document.getElementById("preview");
  video.srcObject = stream;
  video.play();

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  setInterval(() => {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);

      try {
        const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
        if (code) carregarDados(code.data);
      } catch(e){}
    }
  }, 300);
};

async function carregarDados(id){
  const doc = await db.collection("inscricoes").doc(id).get();
  const box = document.getElementById("resultado-scan");

  if (!doc.exists){
    box.innerHTML = "<strong>Inscrição não encontrada ou inválida.</strong>";
    return;
  }

  const d = doc.data();
  box.innerHTML = `
    <strong>${d.nome}</strong><br>
    ${d.turno} • ${d.turma} • ${d.modalidade}<br>
    ID: ${doc.id}
  `;
}
</script>

</body>
</html>
