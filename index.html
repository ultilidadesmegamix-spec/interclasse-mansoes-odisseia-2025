<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin:0; background:#f0f4fb; color:var(--texto); }

    header {
      background: linear-gradient(90deg, var(--azul), #007bff);
      color:#fff;
      padding:14px 18px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    header h1{ margin:0; font-size:1.1rem; }
    header small{ display:block; font-size:0.8rem; opacity:.9; }
    .header-right{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ border:none; border-radius:999px; padding:7px 14px; cursor:pointer; font-size:0.9rem; display:inline-flex; align-items:center; gap:6px; }
    .btn-primaria{ background:#fff; color:var(--azul); box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    .btn-admin{ background:transparent; border:1px solid rgba(255,255,255,0.6); color:#fff; }

    main{ max-width:1100px; margin:18px auto 30px; padding:0 10px; }
    .card{ background:#fff; border-radius:12px; border:1px solid var(--borda); padding:15px; margin-bottom:14px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .card h2{ margin:0 0 8px; font-size:1.05rem; color:var(--azul); }
    .card small{ font-size:0.8rem; color:#555; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    @media (max-width:768px){ .grid-2{ grid-template-columns:1fr; } }
    label{ display:block; font-size:0.85rem; margin-bottom:3px; font-weight:500; }
    input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea{ width:100%; padding:7px 8px; border-radius:8px; border:1px solid var(--borda); background:#fafbff; font-size:0.9rem; }
    textarea{ resize:vertical; min-height:60px; }
    .modalidades-lista{ margin-top:6px; display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:6px; }
    .modalidade-item{ display:flex; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--borda); background:var(--azul-claro); font-size:0.8rem; }
    .modalidade-item input{ margin-top:3px; }
    .modalidade-label{ font-weight:600; font-size:0.85rem; }
    .modalidade-vagas{ display:block; font-size:0.75rem; color:#333; }
    .modalidade-lotado{ color:var(--vermelho); font-weight:600; }
    .alerta{ margin-top:4px; font-size:0.8rem; color:#555; }
    .msg-erro{ background:#ffe5e5; color:#b30000; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    .msg-sucesso{ background:#e5ffe9; color:#0c7a2a; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    table{ width:100%; border-collapse:collapse; margin-top:6px; font-size:0.8rem; }
    th,td{ padding:5px 6px; border-bottom:1px solid #e1e4eb; text-align:left; }
    th{ background:#f2f5ff; font-weight:600; }
    tr:hover td{ background:#f9fbff; }
    .filtros{ margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; }

    /* admin */
    #adminSection{ display:none; }

    /* placar ao vivo: v√≠deo + overlay */
    .live-wrapper{ position:relative; border-radius:10px; overflow:hidden; border:1px solid var(--borda); background:#000; }
    .live-overlay-placar{ position:absolute; inset:auto 0 0 0; background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.55)); color:#fff; padding:8px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; z-index:3; }
    .live-overlay-placar .equipes{ font-weight:700; font-size:1.05rem; }
    .live-video-container{ width:100%; height:360px; background:#000; display:flex; align-items:center; justify-content:center; }
    .live-video-container iframe, .live-video-container video{ width:100%; height:100%; border:0; }

    /* modal TOP10 */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal-card{ background:#fff; border-radius:10px; padding:12px; width:90%; max-width:720px; box-shadow:0 12px 30px rgba(0,0,0,0.3); }
    .modal-card h3{ margin:0 0 6px; color:var(--azul); }
    .top10-list{ margin-top:8px; }
    .top10-item{ display:flex; justify-content:space-between; gap:8px; padding:8px 6px; border-bottom:1px solid #eef3fb; }

    .btn-ghost{ background:transparent; border:1px solid #e6eefb; }

    @media print{ body{ background:#fff; margin:0; } header, #secInscricao, #secInscritos, #secJogos, #secPlacarAoVivo, #secClassificados, #emailOverlay, .admin-header, .admin-tabs, #tab-inscricoes, #tab-jogos, #tab-config, #btnFecharAdmin, #tab-relatorio .admin-bloco, #btnImprimirRelatorio, #btnImprimirTodaTurma{ display:none !important; } main{ margin:0; padding:0; } }
  </style>
</head>
<body>

<!-- OVERLAY E-MAIL -->
<div id="emailOverlay">
  <div id="emailOverlayCard">
    <h2>Antes de continuar...</h2>
    <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o.</p>
    <div id="msgEmailOverlay"></div>
    <input type="text" id="emailAluno" placeholder="seuemail@exemplo.com" />
    <button class="btn btn-primaria" id="btnEntrarEmail">Entrar</button>
  </div>
</div>

<header>
  <div>
    <h1 id="tituloEvento">Inscri√ß√µes Movimenta Odisseia</h1>
    <small id="subEvento">Inscri√ß√µes para o Movimenta Odisseia</small>
  </div>
  <div class="header-right">
    <button class="btn btn-primaria" id="btnToggleInscritos">üëÄ Ver inscritos</button>
    <button class="btn btn-primaria" id="btnVerJogos">üèÜ Ver jogos</button>
    <button class="btn btn-primaria" id="btnClassificados">‚úÖ Classificados</button>
    <button class="btn btn-primaria" id="btnPlacarAoVivo">‚ö° Placar ao vivo</button>
    <button class="btn btn-primaria" id="btnTop10">üèÖ TOP 10</button>
    <button class="btn btn-admin" id="btnAdminArea">üîê √Årea administrativa</button>
  </div>
</header>

<main>
  <!-- INSCRI√á√ÉO -->
  <section class="card" id="secInscricao">
    <h2>Formul√°rio de inscri√ß√£o</h2>
    <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>

    <div id="msgForm"></div>

    <form id="formInscricao">
      <div class="grid-2">
        <div>
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione...</option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="turno">Turno</label>
          <select id="turno" required>
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="turma">Turma</label>
          <select id="turma" required>
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
          <input type="text" id="camisaNumero" />
        </div>
        <div>
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" placeholder="Posi√ß√£o, alguma observa√ß√£o..."></textarea>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Modalidades (m√°ximo 2 por aluno)</label>
        <p class="alerta">
          ‚Ä¢ LIMITE padr√£o por turma: FUTSAL (8), DOMIN√ì/FUTMESA/T√äNIS/XADREZ (2), VOLEI (6), QUEIMADA MISTA (10 ‚Äì 5 meninos / 5 meninas).  
          ‚Ä¢ Esses limites podem ser ajustados na √°rea administrativa.
        </p>
        <div class="modalidades-lista" id="modalidadesContainer"></div>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:0.8rem;">Use o bot√£o <strong>Ver inscritos</strong> para ver quem j√° est√° em cada turma.</span>
        <button type="submit" class="btn btn-primaria">‚úÖ Enviar inscri√ß√£o</button>
      </div>
    </form>
  </section>

  <!-- PAINEL INSCRITOS (ALUNO) -->
  <section class="card" id="secInscritos">
    <h2>Painel de inscritos</h2>
    <small>Visualiza√ß√£o simples para os alunos (apenas nome e turma).</small>

    <div class="filtros">
      <div>
        <label for="filtroTurno">Turno</label>
        <select id="filtroTurno">
          <option value="">Selecione...</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
          <option value="Noturno">Noturno</option>
        </select>
      </div>
      <div>
        <label for="filtroTurma">Turma</label>
        <select id="filtroTurma">
          <option value="">Selecione o turno primeiro...</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidade">Modalidade</label>
        <select id="filtroModalidade">
          <option value="">Selecione a modalidade...</option>
        </select>
      </div>
    </div>

    <table id="tabelaPublica">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Turma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- JOGOS (ALUNO) -->
  <section class="card" id="secJogos">
    <h2>Jogos</h2>
    <small>Selecione a <strong>s√©rie</strong> e a <strong>modalidade</strong>. A data √© opcional.</small>

    <div class="filtros">
      <div>
        <label for="filtroSerieJogo">S√©rie</label>
        <select id="filtroSerieJogo">
          <option value="">Selecione...</option>
          <option value="6">6¬∫ ano</option>
          <option value="7">7¬∫ ano</option>
          <option value="8">8¬∫ ano</option>
          <option value="9">9¬∫ ano</option>
          <option value="1">1¬∫ ano</option>
          <option value="2">2¬∫ ano</option>
          <option value="3">3¬∫ ano</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidadeJogo">Modalidade</label>
        <select id="filtroModalidadeJogo">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div>
        <label for="filtroDataJogo">Data (opcional)</label>
        <input type="date" id="filtroDataJogo">
      </div>
    </div>

    <div id="listaJogosContainer"></div>
  </section>
  <!-- CLASSIFICA√á√ÉO / CLASSIFICADOS (ALUNO) -->
  <section class="card" id="secClassificados">
    <h2>Classificados</h2>
    <small>Veja, jogo por jogo, qual turma foi classificada (apenas jogos finalizados).</small>
    <div id="classificacaoContainer"></div>
  </section>

  <!-- PLACAR AO VIVO (ALUNO) -->
  <section class="card" id="secPlacarAoVivo">
    <h2>Placar ao vivo</h2>
    <small>Veja os jogos que est√£o em andamento ou prestes a come√ßar. Se a transmiss√£o estiver ativa para um jogo, voc√™ ver√° o v√≠deo abaixo do placar.</small>

    <div id="placarAoVivoContainer"></div>
  </section>

  <!-- ADMIN -->
  <section class="card" id="adminSection">
    <div class="admin-header">
      <div>
        <h2>√Årea administrativa</h2>
        <div class="admin-sub">Gerencie inscri√ß√µes, jogos e configura√ß√µes.</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span id="adminStatus" class="admin-status">Verificando...</span>
        <button class="btn btn-primaria" id="btnFecharAdmin">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab-btn ativo" data-tab="inscricoes">üßë‚Äçüéì Inscri√ß√µes</button>
      <button class="admin-tab-btn" data-tab="jogos">üèÜ Jogos</button>
      <button class="admin-tab-btn" data-tab="relatorio">üñ®Ô∏è Imprimir relat√≥rio</button>
      <button class="admin-tab-btn" data-tab="professores">üë©‚Äçüè´ Professores</button>
      <button class="admin-tab-btn" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <!-- TAB INSCRI√á√ïES -->
    <div class="admin-tab-content ativo" id="tab-inscricoes">
      <div class="admin-bloco">
        <strong>Busca / filtro</strong>
        <div class="filtros" style="margin-top:4px;">
          <div>
            <label for="adminFiltroNome">Nome</label>
            <input type="text" id="adminFiltroNome" placeholder="Parte do nome...">
          </div>
          <div>
            <label for="adminFiltroTurma">Turma</label>
            <select id="adminFiltroTurma">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            <label for="adminFiltroModalidade">Modalidade</label>
            <select id="adminFiltroModalidade">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Cancelar inscri√ß√£o</strong>
        <small style="display:block;margin-top:2px;">Busque pelo nome acima e escolha a modalidade espec√≠fica para cancelar.</small>
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
          <select id="selectCancelar" style="min-width:220px; flex:1;">
            <option value="">Selecione uma inscri√ß√£o...</option>
          </select>
          <button class="btn btn-primaria" id="btnCancelarInscricao">Cancelar</button>
        </div>
      </div>

      <table id="tabelaAdmin">
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>N¬∫ camisa</th>
            <th>Modalidades</th>
            <th>Obs</th>
            <th>Data/Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TAB JOGOS -->
    <div class="admin-tab-content" id="tab-jogos">
      <div class="admin-bloco">
        <strong>Cadastrar jogo</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoData">Data</label>
            <input type="date" id="jogoData">
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoTurma1">Turma 1</label>
            <select id="jogoTurma1">
              <option value="">Selecione a turma 1...</option>
            </select>
          </div>
          <div>
            <label for="jogoTurma2">Turma 2</label>
            <select id="jogoTurma2">
              <option value="">Selecione a turma 2...</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoModalidade">Modalidade</label>
            <select id="jogoModalidade">
              <option value="">Selecione...</option>
            </select>
          </div>
          <div>
            <label for="jogoHorario">Hor√°rio</label>
            <input type="time" id="jogoHorario">
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="jogoLocal">Local</label>
          <input type="text" id="jogoLocal" placeholder="Ex: Quadra principal">
        </div>
        <button class="btn btn-primaria" style="margin-top:6px;" id="btnCadastrarJogo">Cadastrar jogo</button>
      </div>

      <div class="admin-bloco">
        <strong>Jogos cadastrados</strong>
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
          <input type="text" id="filtroExcluirJogo" placeholder="Pesquisar jogo (turma, modalidade, data...)" style="flex:1; min-width:200px;">
          <select id="selectExcluirJogo" style="min-width:220px; flex:1;">
            <option value="">Selecione um jogo...</option>
          </select>
          <button class="btn btn-primaria" id="btnExcluirJogo">Excluir</button>
        </div>
      </div>

      <div class="admin-bloco" id="adminPainelJogos">
        <strong>Placar ao vivo / Status dos jogos</strong>
        <small style="display:block;margin-top:2px;">Atualize o status, placar e controle transmiss√£o (c√¢meras) do jogo. As mudan√ßas aparecem em tempo real no site p√∫blico.</small>
        <div id="listaAdminJogos" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- RESTANTE DAS ABAS (RELAT√ìRIO / PROFESSORES / CONFIG) PRESERVADAS -->
    <div class="admin-tab-content" id="tab-relatorio">
      <!-- conte√∫do existente do relat√≥rio (mantido) -->
      <div class="admin-bloco">
        <strong>Filtros para relat√≥rio</strong>
        <div class="filtros" style="margin-top:4px;">
          <div>
            <label for="relatorioTurno">Turno</label>
            <select id="relatorioTurno">
              <option value="">Selecione...</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Noturno">Noturno</option>
            </select>
          </div>
          <div>
            <label for="relatorioTurma">Turma</label>
            <select id="relatorioTurma">
              <option value="">Selecione o turno primeiro...</option>
            </select>
          </div>
          <div>
            <label for="relatorioModalidade">Modalidade</label>
            <select id="relatorioModalidade">
              <option value="">Selecione a modalidade...</option>
            </select>
          </div>
        </div>
        <div id="relatorioCabecalhoImpressao">
          <h3 id="relatorioTituloLinha1">Relat√≥rio de inscritos ‚Äì Movimenta Odisseia</h3>
          <small id="relatorioTituloLinha2">Selecione turno, turma e modalidade para gerar o relat√≥rio.</small>
        </div>
        <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn btn-primaria" id="btnImprimirRelatorio">üñ®Ô∏è Imprimir</button>
          <button class="btn btn-primaria" id="btnImprimirTodaTurma">üñ®Ô∏è Imprimir Toda Turma</button>
        </div>
      </div>

      <table id="tabelaRelatorio">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>Modalidades</th>
            <th>E-mail</th>
            <th>N¬∫ camisa</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- As outras abas (professores/config) seguem id√™nticas ao original. -->
  </section>

</main>

<!-- MODAL TOP10 -->
<div id="top10Modal" style="display:none;" class="modal-backdrop">
  <div class="modal-card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
      <h3>TOP 10 ‚Äî Turmas com mais pontos (jogos finalizados)</h3>
      <button id="btnCloseTop10" class="btn btn-ghost">Fechar</button>
    </div>
    <div id="top10Content" class="top10-list"></div>
  </div>
</div>

<script>
"use strict";

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== CONSTANTES e VARI√ÅVEIS (mantidas) ========== */
const MODALIDADES = ["FUTSAL","QUEIMADA MISTA","DOMIN√ì","FUTMESA","T√äNIS DE MESA","XADREZ","VOLEI"];
const TURMAS_MATUTINO = ["7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F","8¬∫F","9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"];
const TURMAS_VESPERTINO = ["6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G","8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"];
const TURMAS_NOTURNO = ["1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F","2¬∫A","2¬∫B","2¬∫C","3¬∫A","3¬∫B","3¬∫C"];
const TODAS_TURMAS = [...TURMAS_MATUTINO,...TURMAS_VESPERTINO,...TURMAS_NOTURNO];
function getTurmasPorTurno(turno){ if(turno==='Matutino') return TURMAS_MATUTINO; if(turno==='Vespertino') return TURMAS_VESPERTINO; if(turno==='Noturno') return TURMAS_NOTURNO; return []; }
function getSerieFromTurma(t){ if(!t) return ''; return t.charAt(0); }

let LIMITE_MODALIDADES_POR_ALUNO = 2;
let LIMITE_MODALIDADE_TURMA = {"FUTSAL":8,"DOMIN√ì":2,"FUTMESA":2,"T√äNIS DE MESA":2,"XADREZ":2,"VOLEI":6};
let LIMITE_QUEIMADA_TOTAL = 10;
let LIMITE_QUEIMADA_POR_SEXO = 5;

let countsPorTurmaModalidade = {};
let countsQueimadaGenero = {};
let todasInscricoes = [];
let todosJogos = [];

let todosProfessores = [];
let currentRole = null;
let currentProfessor = null;

let configEvento = { dataLimite:null, msgEncerradas:'', bloquearAgora:false, nomeEvento:'Movimenta Odisseia', anoEvento:'', textoInicial:'', autorizacoes:{} };
let inscricoesEncerradas = false;
let emailAtual = null;
let isAdmin = false;
const ADMIN_PASSWORD = "52090949";

/* ========== FUN√á√ïES AUXILIARES (mantidas do original) ========== */

function normalizarNome(str){
  return (str || "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ");
}
function validarEmail(email){ return email && email.includes("@") && email.includes("."); }
function msgForm(texto, ok){ const box=document.getElementById("msgForm"); box.innerHTML=""; const div=document.createElement("div"); div.className = ok ? "msg-sucesso" : "msg-erro"; div.textContent = texto; box.appendChild(div); }
function formatarDataBR(yyyyMMdd){ if(!yyyyMMdd) return "-"; const p=yyyyMMdd.split("-"); if(p.length!==3) return yyyyMMdd; return p[2] + "/" + p[1] + "/" + p[0]; }

/* ========== ATUALIZA√á√ÉO: TOP10 / TRANSMISS√ÉO FUNCTIONS ========== */

function calcularPontuacaoPorTurma(){
  const mapa = {};
  todosJogos.filter(j => j.status === 'FINALIZADO').forEach(j => {
    const t1 = j.turma1 || '‚Äî';
    const t2 = j.turma2 || '‚Äî';
    mapa[t1] = (mapa[t1]||0) + (Number.isFinite(j.placar1)? j.placar1 : 0);
    mapa[t2] = (mapa[t2]||0) + (Number.isFinite(j.placar2)? j.placar2 : 0);
  });
  return mapa;
}

function renderTop10Modal(){
  const mapa = calcularPontuacaoPorTurma();
  const arr = Object.keys(mapa).map(t => ({ turma: t, pontos: mapa[t] }));
  arr.sort((a,b) => b.pontos - a.pontos);
  const top = arr.slice(0,10);

  const cont = document.getElementById('top10Content');
  cont.innerHTML = '';
  if(!top.length){ cont.innerHTML = '<div style="padding:8px 6px;">Ainda n√£o h√° jogos finalizados para calcular o Top 10.</div>'; return; }
  top.forEach((it, idx) => {
    const div = document.createElement('div'); div.className='top10-item';
    const left = document.createElement('div'); left.textContent = (idx+1)+'. '+it.turma;
    const right = document.createElement('div'); right.textContent = it.pontos + ' pts';
    div.appendChild(left); div.appendChild(right); cont.appendChild(div);
  });
}

/* abrir/fechar TOP10 */
document.addEventListener('click', function(e){
  const t = e.target;
  if(t && t.id === 'btnTop10'){
    renderTop10Modal();
    document.getElementById('top10Modal').style.display = 'flex';
  }
  if(t && t.id === 'btnCloseTop10'){
    document.getElementById('top10Modal').style.display = 'none';
  }
});

/* ========== Helper: render video embed from URL (simples heur√≠sticas) ========== */
function buildVideoEmbedHTML(url){
  if(!url) return '<div style="padding:14px;color:#fff;">Nenhuma transmiss√£o configurada.</div>';
  const u = url.toLowerCase();
  if(u.includes('youtube.com') || u.includes('youtu.be') || u.includes('twitch.tv')){
    return '<iframe src="'+url+'" allowfullscreen></iframe>';
  }
  if(u.endsWith('.m3u8') || u.includes('.m3u8')){
    return '<video controls playsinline><source src="'+url+'" type="application/vnd.apple.mpegurl"></video>';
  }
  if(u.endsWith('.mp4')){
    return '<video controls playsinline><source src="'+url+'" type="video/mp4"></video>';
  }
  return '<iframe src="'+url+'" allowfullscreen></iframe>';
}

/* ========== RENDER PLACAR AO VIVO (public) com v√≠deo quando transmitir ========== */
function renderPlacarAoVivo(){
  const container = document.getElementById("placarAoVivoContainer");
  if(!container) return;
  container.innerHTML = "";

  const statusLabel = { "AGENDADO":"Agendado", "PRESTES":"Prestes a come√ßar", "EM_ANDAMENTO":"Em andamento", "FINALIZADO":"Finalizado" };
  const jogosAoVivo = todosJogos.filter(j => j.status === "EM_ANDAMENTO" || j.status === "PRESTES");

  if(!jogosAoVivo.length){
    const p = document.createElement("p");
    p.textContent = "Nenhum jogo em andamento ou prestes a come√ßar neste momento.";
    container.appendChild(p);
    return;
  }

  jogosAoVivo.sort((a,b) => ((a.dataJogo||"") + " " + (a.horarioJogo||"")).localeCompare((b.dataJogo||"") + " " + (b.horarioJogo||"")));

  jogosAoVivo.forEach(j => {
    const card = document.createElement("div");
    card.className = "placar-card";

    const topo = document.createElement("div");
    topo.className = "placar-linha-principal";
    topo.textContent = (j.modalidade || "-") + " ‚Äî " + formatarDataBR(j.dataJogo) + " √†s " + (j.horarioJogo || "-");
    card.appendChild(topo);

    const info = document.createElement("div");
    info.innerHTML =
      "Local: "+(j.localJogo || "-")+"<br>"+
      (j.turma1 || "")+" <strong>"+(j.placar1 ?? 0)+"</strong> x <strong>"+(j.placar2 ?? 0)+"</strong> "+(j.turma2 || "");
    card.appendChild(info);

    const statusSpan = document.createElement("span");
    statusSpan.className = "placar-status";
    if (j.status === "EM_ANDAMENTO") statusSpan.classList.add("andamento");
    if (j.status === "PRESTES") statusSpan.classList.add("prestes");
    statusSpan.textContent = statusLabel[j.status] || j.status || "‚Äì";
    card.appendChild(statusSpan);

    // se transmitir ativo e tem cameras -> mostrar live wrapper com overlay
    if(j.transmitir && Array.isArray(j.cameras) && j.cameras.length){
      const live = document.createElement("div");
      live.className = "live-wrapper";
      live.style.marginTop = "8px";
      const videoContainer = document.createElement("div");
      videoContainer.className = "live-video-container";
      const activeIndex = (typeof j.activeCameraIndex === 'number') ? j.activeCameraIndex : 0;
      const cam = j.cameras[activeIndex] || j.cameras[0];
      videoContainer.innerHTML = buildVideoEmbedHTML(cam ? cam.url : '');
      live.appendChild(videoContainer);

      const overlay = document.createElement("div");
      overlay.className = "live-overlay-placar";
      const equipes = document.createElement("div");
      equipes.className = "equipes";
      equipes.textContent = (j.turma1||'')+' '+(j.placar1??0)+' x '+(j.placar2??0)+' '+(j.turma2||'');
      const infoRight = document.createElement("div");
      infoRight.style.fontSize = "0.85rem";
      infoRight.textContent = cam ? (cam.name || ('C√¢mera '+(activeIndex+1))) : 'Sem c√¢mera ativa';
      overlay.appendChild(equipes);
      overlay.appendChild(infoRight);
      live.appendChild(overlay);

      card.appendChild(live);
    }

    container.appendChild(card);
  });
}

/* ========== ADMIN: gerenciar cameras por jogo (cameras array, activeCameraIndex, transmitir) ========== */
async function adicionarCameraAoJogo(jogoId, nome, url){
  if(!isAdmin) return alert('Apenas administrador.');
  try{
    const docRef = db.collection('jogos').doc(jogoId);
    const doc = await docRef.get();
    const d = doc.exists ? doc.data() : {};
    const cams = Array.isArray(d.cameras) ? d.cameras.slice() : [];
    cams.push({ name: nome, url: url });
    await docRef.update({ cameras: cams });
    alert('C√¢mera adicionada.');
  }catch(e){ console.error(e); alert('Erro ao adicionar c√¢mera.'); }
}
async function definirCameraAtiva(jogoId, idx){
  if(!isAdmin) return alert('Apenas administrador.');
  try{ await db.collection('jogos').doc(jogoId).update({ activeCameraIndex: idx }); alert('C√¢mera ativa atualizada.'); }catch(e){ console.error(e); alert('Erro ao atualizar c√¢mera ativa.'); }
}
async function removerCameraDoJogo(jogoId, idx){
  if(!isAdmin) return alert('Apenas administrador.');
  try{
    const ref = db.collection('jogos').doc(jogoId);
    const snap = await ref.get(); const d = snap.exists ? snap.data() : {};
    const cams = Array.isArray(d.cameras) ? d.cameras.slice() : [];
    if(idx < 0 || idx >= cams.length) return alert('√çndice inv√°lido');
    cams.splice(idx,1);
    await ref.update({ cameras: cams });
    alert('C√¢mera removida.');
  }catch(e){ console.error(e); alert('Erro ao remover c√¢mera.'); }
}
async function toggleTransmitirJogo(jogoId, flag){
  if(!isAdmin) return alert('Apenas administrador.');
  try{ await db.collection('jogos').doc(jogoId).update({ transmitir: !!flag }); alert('Altera√ß√£o salva.'); }catch(e){ console.error(e); alert('Erro ao atualizar transmiss√£o.'); }
}

/* ========== RENDER ADMIN JOGOS (atualizado com controles de c√¢mera) ========== */
function renderAdminJogos(){
  const container = document.getElementById("listaAdminJogos");
  if(!container) return;
  container.innerHTML = "";

  if(!todosJogos.length){
    container.textContent = "Nenhum jogo cadastrado.";
    return;
  }

  const statusOptions = ["AGENDADO","PRESTES","EM_ANDAMENTO","FINALIZADO"];

  todosJogos.forEach(j => {
    const bloco = document.createElement("div");
    bloco.className = "jogo-bloco";

    const linha1 = document.createElement("div");
    linha1.innerHTML = "<strong>"+(j.modalidade||"-")+"</strong> ‚Äî "+formatarDataBR(j.dataJogo)+" √†s "+(j.horarioJogo||"-");
    bloco.appendChild(linha1);

    const linha2 = document.createElement("div");
    linha2.textContent = "Jogo: "+(j.turma1||"")+" x "+(j.turma2||"")+" ‚Äî Local: "+(j.localJogo||"-");
    bloco.appendChild(linha2);

    const controles = document.createElement("div");
    controles.style.marginTop = "4px";
    controles.style.display = "flex";
    controles.style.flexWrap = "wrap";
    controles.style.gap = "6px";
    controles.style.alignItems = "center";

    const selStatus = document.createElement("select");
    selStatus.dataset.id = j.id;
    statusOptions.forEach(st => {
      const opt = document.createElement("option");
      opt.value = st;
      opt.textContent = st;
      if (j.status === st) opt.selected = true;
      selStatus.appendChild(opt);
    });

    const inpP1 = document.createElement("input");
    inpP1.type = "number";
    inpP1.min = "0";
    inpP1.value = (j.placar1 ?? 0);
    inpP1.style.width = "60px";
    inpP1.dataset.id = j.id;
    inpP1.dataset.tipo = "p1";

    const inpP2 = document.createElement("input");
    inpP2.type = "number";
    inpP2.min = "0";
    inpP2.value = (j.placar2 ?? 0);
    inpP2.style.width = "60px";
    inpP2.dataset.id = j.id;
    inpP2.dataset.tipo = "p2";

    const labelP1 = document.createElement("span");
    labelP1.textContent = (j.turma1 || "T1")+":";
    const labelP2 = document.createElement("span");
    labelP2.textContent = (j.turma2 || "T2")+":"; 

    const btnSalvar = document.createElement("button");
    btnSalvar.className = "btn btn-primaria btnSalvarJogo";
    btnSalvar.textContent = "Salvar";
    btnSalvar.dataset.id = j.id;

    controles.appendChild(document.createTextNode("Status:"));
    controles.appendChild(selStatus);
    controles.appendChild(labelP1);
    controles.appendChild(inpP1);
    controles.appendChild(labelP2);
    controles.appendChild(inpP2);
    controles.appendChild(btnSalvar);

    bloco.appendChild(controles);

    // CONTROLES DE C√ÇMERA
    const camBlock = document.createElement('div');
    camBlock.style.marginTop = '8px';
    camBlock.style.borderTop = '1px dashed #dfe8f8';
    camBlock.style.paddingTop = '8px';
    const tituloCam = document.createElement('div'); tituloCam.style.fontWeight='600'; tituloCam.textContent='C√¢meras / Transmiss√£o deste jogo'; camBlock.appendChild(tituloCam);

    const transmitirLabel = document.createElement('label');
    transmitirLabel.style.display='inline-flex';
    transmitirLabel.style.alignItems='center';
    transmitirLabel.style.gap='8px';
    transmitirLabel.style.marginTop='6px';
    const chkTransmitir = document.createElement('input');
    chkTransmitir.type='checkbox';
    chkTransmitir.checked = !!j.transmitir;
    chkTransmitir.addEventListener('change', () => { toggleTransmitirJogo(j.id, chkTransmitir.checked); });
    transmitirLabel.appendChild(chkTransmitir);
    transmitirLabel.appendChild(document.createTextNode('Ativar transmiss√£o p√∫blica'));
    camBlock.appendChild(transmitirLabel);

    const listaCams = document.createElement('div');
    listaCams.style.marginTop='6px';
    const cams = Array.isArray(j.cameras) ? j.cameras : [];
    if(!cams.length){ listaCams.innerHTML = '<div style="font-size:0.9rem;color:#555;">Nenhuma c√¢mera cadastrada ainda.</div>'; }
    cams.forEach((c, idx) => {
      const linha = document.createElement('div');
      linha.style.display='flex'; linha.style.alignItems='center'; linha.style.gap='8px'; linha.style.marginTop='6px';
      const nome = document.createElement('div'); nome.style.flex='1'; nome.textContent = (c.name || ('C√¢mera '+(idx+1)));
      const btnAtivar = document.createElement('button'); btnAtivar.className='btn btn-primaria'; btnAtivar.textContent = ( (j.activeCameraIndex===idx)?'Ativa':'Definir ativa' );
      btnAtivar.addEventListener('click', () => definirCameraAtiva(j.id, idx));
      const btnRem = document.createElement('button'); btnRem.className='btn btn-ghost'; btnRem.textContent='Remover';
      btnRem.addEventListener('click', () => { if(confirm('Remover c√¢mera '+(c.name||('C√¢mera '+(idx+1)))+'?')) removerCameraDoJogo(j.id, idx); });
      linha.appendChild(nome); linha.appendChild(btnAtivar); linha.appendChild(btnRem); listaCams.appendChild(linha);
    });
    camBlock.appendChild(listaCams);

    const formAdd = document.createElement('div'); formAdd.style.display='flex'; formAdd.style.gap='6px'; formAdd.style.marginTop='8px';
    const inpNome = document.createElement('input'); inpNome.placeholder='Nome da c√¢mera'; inpNome.style.flex='1';
    const inpUrl = document.createElement('input'); inpUrl.placeholder='URL (YouTube, HLS, MP4, embed...)'; inpUrl.style.flex='2';
    const btnAddCam = document.createElement('button'); btnAddCam.className='btn btn-primaria'; btnAddCam.textContent='Adicionar c√¢mera';
    btnAddCam.addEventListener('click', (ev)=>{ ev.preventDefault(); if(!inpNome.value||!inpUrl.value) return alert('Preencha nome e URL.'); adicionarCameraAoJogo(j.id, inpNome.value.trim(), inpUrl.value.trim()); });
    formAdd.appendChild(inpNome); formAdd.appendChild(inpUrl); formAdd.appendChild(btnAddCam);
    camBlock.appendChild(formAdd);

    bloco.appendChild(camBlock);

    document.getElementById('listaAdminJogos').appendChild(bloco);
  });

  // handles save buttons
  container.querySelectorAll('.btnSalvarJogo').forEach(btn => {
    btn.addEventListener('click', async () => {
      if(!isAdmin){ alert('Apenas o administrador pode atualizar jogos.'); return; }
      const id = btn.dataset.id;
      const bloco = btn.closest('.jogo-bloco');
      const selStatus = bloco.querySelector('select');
      const inpP1 = bloco.querySelector('input[data-tipo="p1"]');
      const inpP2 = bloco.querySelector('input[data-tipo="p2"]');

      const novoStatus = selStatus.value;
      const placar1 = parseInt(inpP1.value,10) || 0;
      const placar2 = parseInt(inpP2.value,10) || 0;

      try{
        await db.collection('jogos').doc(id).update({
          status: novoStatus,
          placar1: placar1,
          placar2: placar2
        });
        alert('Jogo atualizado com sucesso.');
      }catch(e){
        console.error(e);
        alert('Erro ao atualizar jogo.');
      }
    });
  });
}

/* ========== LISTENERS FIRESTORE (atualizado p/ incluir campos de cameras/transmitir) ========== */
function iniciarListeners(){
  db.collection("professoresAcesso").onSnapshot(snap => {
    todosProfessores = [];
    snap.forEach(doc => {
      const d = doc.data();
      todosProfessores.push({ id: doc.id, nome: d.nome || "", tipo: d.tipo || "Professor", senha: d.senha || "" });
    });
    renderProfessoresAdmin();
  });

  db.collection("inscricoes").orderBy("timestamp","asc").onSnapshot(snap => {
    todasInscricoes = [];
    countsPorTurmaModalidade = {};
    countsQueimadaGenero = {};
    snap.forEach(doc => {
      const d = doc.data();
      const ins = {
        id: doc.id,
        nome: d.nome || "",
        nomeNormalizado: d.nomeNormalizado || normalizarNome(d.nome || ""),
        email: d.email || "",
        sexo: d.sexo || "",
        turno: d.turno || "",
        turma: d.turma || "",
        camisaNumero: d.camisaNumero || "",
        modalidades: d.modalidades || [],
        observacoes: d.observacoes || "",
        naoAutorizadoPor: d.naoAutorizadoPor || [],
        timestamp: d.timestamp
      };
      todasInscricoes.push(ins);

      if (!countsPorTurmaModalidade[ins.turma]) countsPorTurmaModalidade[ins.turma] = {};
      ins.modalidades.forEach(m => {
        if (!countsPorTurmaModalidade[ins.turma][m]) countsPorTurmaModalidade[ins.turma][m] = 0;
        countsPorTurmaModalidade[ins.turma][m]++;
        if (m === "QUEIMADA MISTA"){
          if (!countsQueimadaGenero[ins.turma]) countsQueimadaGenero[ins.turma] = {Masculino:0, Feminino:0};
          if (ins.sexo === "Masculino") countsQueimadaGenero[ins.turma].Masculino++;
          if (ins.sexo === "Feminino") countsQueimadaGenero[ins.turma].Feminino++;
        }
      });
    });
    atualizarDisponibilidadeModalidades();
    atualizarSelectsAdminPublico();
    renderPublico();
    renderAdmin();
    renderRelatorio();
    if (currentRole && currentRole !== "ADMIN"){
      renderPainelProfessores();
    }
  });

  db.collection("jogos").orderBy("dataJogo","asc").onSnapshot(snap => {
    todosJogos = [];
    snap.forEach(doc => {
      const d = doc.data();
      let p1 = d.placar1;
      let p2 = d.placar2;
      if (typeof p1 === "string") p1 = parseInt(p1,10);
      if (typeof p2 === "string") p2 = parseInt(p2,10);
      todosJogos.push({
        id: doc.id,
        turno: d.turno || "",
        serie: d.serie || "",
        turma1: d.turma1 || "",
        turma2: d.turma2 || "",
        dataJogo: d.dataJogo || "",
        modalidade: d.modalidade || "",
        horarioJogo: d.horarioJogo || "",
        localJogo: d.localJogo || "",
        status: d.status || "AGENDADO",
        placar1: Number.isFinite(p1) ? p1 : 0,
        placar2: Number.isFinite(p2) ? p2 : 0,
        cameras: Array.isArray(d.cameras) ? d.cameras : [],
        activeCameraIndex: (typeof d.activeCameraIndex === 'number') ? d.activeCameraIndex : 0,
        transmitir: !!d.transmitir
      });
    });
    atualizarSelectExcluirJogo();
    renderJogosAluno();
    renderPlacarAoVivo();
    renderClassificacao();
    renderAdminJogos();
  });
}

/* ========== INICIALIZA√á√ÉO E RESTANTE DO C√ìDIGO ========== */
/* O restante das fun√ß√µes originais (handleSubmitInscricao, cancelarInscricao, renderPublico, renderAdmin, renderRelatorio, renderRelatorioTodaTurma, atualizarSelectsAdminPublico, renderJogosAluno, renderClassificacao, cadastrarJogo, atualizarSelectExcluirJogo, excluirJogo, adicionarProfessorAcesso, excluirProfessorAcesso, renderProfessoresAdmin, renderPainelProfessores, indicarAlunoNaoParticipa, mostrarSecao, abrirAdmin, fecharAdmin, fecharProfessores, configurarAbasAdmin, salvarConfiguracoes, carregarConfiguracoes, atualizarAutorizacoesUI, atualizarDisponibilidadeModalidades, etc.) permanecem como no seu arquivo original ‚Äî apenas acrescentei/atualizei as partes relacionadas ao TOP10 e √† transmiss√£o/c√¢meras. */

function init(){
  try {
    const saved = localStorage.getItem('insc_email');
    if (saved && saved.includes('@')){
      emailAtual = saved;
      const ov = document.getElementById('emailOverlay');
      if (ov) ov.style.display = 'none';
    }
  } catch(e){}

  // associar listeners m√≠nimos (o resto das liga√ß√µes est√° preservado no original)
  const btnEntrar = document.getElementById("btnEntrarEmail");
  if (btnEntrar) btnEntrar.addEventListener("click", () => {
    const emailInput = document.getElementById("emailAluno");
    const val = (emailInput.value || '').trim();
    if (!validarEmail(val)) { document.getElementById('msgEmailOverlay').textContent = "Digite um e-mail v√°lido."; return; }
    emailAtual = val; try { localStorage.setItem('insc_email', val); } catch(e){}
    document.getElementById('emailOverlay').style.display = 'none';
  });

  configurarAbasAdmin();
  iniciarListeners();
  carregarConfiguracoes();
  mostrarSecao('inscricao');
}

if (document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>

</body>
</html>
