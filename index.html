<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- QR generation & scanning libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f0f4fb; color: var(--texto); }
    header { background: linear-gradient(90deg, var(--azul), #007bff); color: #fff; padding: 14px 18px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
    header h1 { margin:0; font-size:1.1rem; }
    header small { display:block; font-size:0.8rem; opacity:.9; }
    .header-right { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { border:none; border-radius:999px; padding:7px 14px; cursor:pointer; font-size:0.9rem; display:inline-flex; align-items:center; gap:6px; }
    .btn-primaria { background:#fff; color:var(--azul); box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    .btn-admin { background:transparent; border:1px solid rgba(255,255,255,0.6); color:#fff; }

    main { max-width:1100px; margin:18px auto 30px; padding:0 10px; }
    .card { background:#fff; border-radius:12px; border:1px solid var(--borda); padding:15px; margin-bottom:14px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .card h2 { margin:0 0 8px; font-size:1.05rem; color:var(--azul); }
    .card small { font-size:0.8rem; color:#555; }
    .grid-2 { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    @media (max-width:768px){ .grid-2{ grid-template-columns:1fr; } }
    label { display:block; font-size:0.85rem; margin-bottom:3px; font-weight:500; }
    input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
      width:100%; padding:7px 8px; border-radius:8px; border:1px solid var(--borda); background:#fafbff; font-size:0.9rem;
    }
    textarea { resize:vertical; min-height:60px; }
    .modalidades-lista { margin-top:6px; display:grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap:6px; }
    .modalidade-item { display:flex; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--borda); background:var(--azul-claro); font-size:0.8rem; }
    .modalidade-item input { margin-top:3px; }
    .modalidade-label { font-weight:600; font-size:0.85rem; }
    .modalidade-vagas { display:block; font-size:0.75rem; color:#333; }
    .modalidade-lotado { color:var(--vermelho); font-weight:600; }
    .alerta { margin-top:4px; font-size:0.8rem; color:#555; }
    .msg-erro { background:#ffe5e5; color:#b30000; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    .msg-sucesso { background:#e5ffe9; color:#0c7a2a; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    table { width:100%; border-collapse:collapse; margin-top:6px; font-size:0.8rem; }
    th,td { padding:5px 6px; border-bottom:1px solid #e1e4eb; text-align:left; }
    th { background:#f2f5ff; font-weight:600; }
    tr:hover td { background:#f9fbff; }
    .filtros { margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; }
    .filtros > div { min-width:150px; }

    /* Responsividade tabela inscri√ß√µes (admin) */
    #tab-inscricoes { overflow-x:auto; }
    #tab-inscricoes table { min-width:700px; }

    /* admin */
    #adminSection { display:none; }
    .admin-header { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px; }
    .admin-header h2 { margin:0; font-size:1rem; color:var(--azul); }
    .admin-sub { font-size:0.8rem; color:#555; }
    .admin-status { font-size:0.75rem; padding:3px 8px; border-radius:999px; background:#e5ffe9; color:#0c7a2a; }
    .admin-status.fechado { background:#ffe5e5; color:#b30000; }
    .admin-tabs { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; border-bottom:1px solid #e1e4eb; padding-bottom:4px; }
    .admin-tab-btn { border:none; border-radius:999px; padding:5px 10px; font-size:0.8rem; background:#f1f3fb; cursor:pointer; }
    .admin-tab-btn.ativo { background:var(--azul); color:#fff; }
    .admin-tab-content { display:none; }
    .admin-tab-content.ativo { display:block; }
    .admin-bloco { background:#f9fbff; border-radius:10px; border:1px dashed #c5cde0; padding:8px; margin-bottom:8px; font-size:0.82rem; }

    /* scanner modal */
    #scannerOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:99999;
    }
    #scannerCard {
      background:#fff; border-radius:10px; padding:12px; width:90%; max-width:720px; box-shadow:0 8px 20px rgba(0,0,0,0.3);
    }
    #scannerHeader { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
    #scannerResult {
      margin-top:8px; padding:8px; border-radius:8px; display:none; align-items:center; gap:8px;
    }
    #scannerResult.valid { background:#e9ffef; color:#0a6b2a; border:1px solid #c3efcf; display:flex; }
    #scannerResult.invalid { background:#ffecec; color:#b30000; border:1px solid #f5c3c3; display:flex; }

    /* credenciais list */
    .cred-card { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; border:1px solid #e1e4eb; margin-top:8px; background:#fff; }
    .badge-preview { border:1px dashed #cfd8e3; padding:8px; border-radius:6px; display:inline-block; font-size:0.9rem; background:#fafcff; }

    /* CHAMADA list */
    .chamada-list { margin-top:8px; display:grid; gap:6px; }
    .chamada-item { padding:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid #e1e4eb; background:#fff; }
    .presente { color:var(--verde); font-weight:700; }
    .ausente { color:var(--vermelho); font-weight:700; }

    /* small responsive fixes */
    @media print {
      header, #emailOverlay, .admin-tabs, #btnFecharAdmin, #scannerOverlay { display:none !important; }
    }
  </style>
</head>
<body>

<!-- OVERLAY E-MAIL -->
<div id="emailOverlay">
  <div id="emailOverlayCard" class="card" style="max-width:420px; margin:60px auto; position:relative;">
    <h2>Antes de continuar...</h2>
    <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o.</p>
    <div id="msgEmailOverlay" style="min-height:18px; color:var(--vermelho);"></div>
    <input type="text" id="emailAluno" placeholder="seuemail@exemplo.com" />
    <div style="margin-top:8px; display:flex; gap:8px;">
      <button class="btn btn-primaria" id="btnEntrarEmail">Entrar</button>
    </div>
  </div>
</div>

<header>
  <div>
    <h1 id="tituloEvento">Inscri√ß√µes Movimenta Odisseia</h1>
    <small id="subEvento">Inscri√ß√µes para o Movimenta Odisseia</small>
  </div>
  <div class="header-right">
    <button class="btn btn-primaria" id="btnToggleInscritos">üëÄ Ver inscritos</button>
    <button class="btn btn-primaria" id="btnVerJogos">üèÜ Ver jogos</button>
    <button class="btn btn-primaria" id="btnClassificados">‚úÖ Classificados</button>
    <button class="btn btn-primaria" id="btnPlacarAoVivo">‚ö° Placar ao vivo</button>
    <button class="btn btn-admin" id="btnAdminArea">üîê √Årea administrativa</button>
  </div>
</header>

<main>

  <!-- INSCRI√á√ÉO (mantido igual) -->
  <section class="card" id="secInscricao">
    <h2>Formul√°rio de inscri√ß√£o</h2>
    <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>

    <div id="msgForm"></div>

    <form id="formInscricao">
      <div class="grid-2">
        <div>
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione...</option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="turno">Turno</label>
          <select id="turno" required>
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="turma">Turma</label>
          <select id="turma" required>
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
          <input type="text" id="camisaNumero" />
        </div>
        <div>
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" placeholder="Posi√ß√£o, alguma observa√ß√£o..."></textarea>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Modalidades (m√°ximo 2 por aluno)</label>
        <p class="alerta">
          ‚Ä¢ LIMITE padr√£o por turma: FUTSAL (8), DOMIN√ì/FUTMESA/T√äNIS/XADREZ (2), VOLEI (6), QUEIMADA MISTA (10 ‚Äì 5 meninos / 5 meninas).  
          ‚Ä¢ Esses limites podem ser ajustados na √°rea administrativa.
        </p>
        <div class="modalidades-lista" id="modalidadesContainer"></div>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:0.8rem;">Use o bot√£o <strong>Ver inscritos</strong> para ver quem j√° est√° em cada turma.</span>
        <button type="submit" class="btn btn-primaria">‚úÖ Enviar inscri√ß√£o</button>
      </div>
    </form>
  </section>

  <!-- PAINEL INSCRITOS (ALUNO) -->
  <section class="card" id="secInscritos">
    <h2>Painel de inscritos</h2>
    <small>Visualiza√ß√£o simples para os alunos (apenas nome e turma).</small>

    <div class="filtros">
      <div>
        <label for="filtroTurno">Turno</label>
        <select id="filtroTurno">
          <option value="">Selecione...</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
          <option value="Noturno">Noturno</option>
        </select>
      </div>
      <div>
        <label for="filtroTurma">Turma</label>
        <select id="filtroTurma">
          <option value="">Selecione o turno primeiro...</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidade">Modalidade</label>
        <select id="filtroModalidade">
          <option value="">Selecione a modalidade...</option>
        </select>
      </div>
    </div>

    <table id="tabelaPublica">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Turma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- JOGOS (ALUNO) -->
  <section class="card" id="secJogos">
    <h2>Jogos</h2>
    <small>Selecione a <strong>s√©rie</strong> e a <strong>modalidade</strong>. A data √© opcional.</small>

    <div class="filtros">
      <div>
        <label for="filtroSerieJogo">S√©rie</label>
        <select id="filtroSerieJogo">
          <option value="">Selecione...</option>
          <option value="6">6¬∫ ano</option>
          <option value="7">7¬∫ ano</option>
          <option value="8">8¬∫ ano</option>
          <option value="9">9¬∫ ano</option>
          <option value="1">1¬∫ ano</option>
          <option value="2">2¬∫ ano</option>
          <option value="3">3¬∫ ano</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidadeJogo">Modalidade</label>
        <select id="filtroModalidadeJogo">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div>
        <label for="filtroDataJogo">Data (opcional)</label>
        <input type="date" id="filtroDataJogo">
      </div>
    </div>

    <div id="listaJogosContainer"></div>
  </section>

  <!-- CLASSIFICA√á√ÉO / CLASSIFICADOS (ALUNO) -->
  <section class="card" id="secClassificados">
    <h2>Classificados</h2>
    <small>Veja, jogo por jogo, qual turma foi classificada (apenas jogos finalizados).</small>
    <div id="classificacaoContainer"></div>
  </section>

  <!-- PLACAR AO VIVO (ALUNO) -->
  <section class="card" id="secPlacarAoVivo">
    <h2>Placar ao vivo</h2>
    <small>Veja os jogos que est√£o em andamento ou prestes a come√ßar.</small>

    <div id="placarAoVivoContainer"></div>
  </section>

  <!-- ADMIN -->
  <section class="card" id="adminSection">
    <div class="admin-header">
      <div>
        <h2>√Årea administrativa</h2>
        <div class="admin-sub">Gerencie inscri√ß√µes, jogos e credenciais.</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span id="adminStatus" class="admin-status">Verificando...</span>
        <button class="btn btn-primaria" id="btnFecharAdmin">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab-btn ativo" data-tab="inscricoes">üßë‚Äçüéì Inscri√ß√µes</button>
      <button class="admin-tab-btn" data-tab="jogos">üèÜ Jogos</button>
      <button class="admin-tab-btn" data-tab="relatorio">üñ®Ô∏è Imprimir relat√≥rio</button>
      <button class="admin-tab-btn" data-tab="professores">üë©‚Äçüè´ Professores</button>
      <button class="admin-tab-btn" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
      <!-- NOVA ABA: CREDENCIAIS -->
      <button class="admin-tab-btn" data-tab="credenciais">üé´ Credenciais</button>
    </div>

    <!-- TAB INSCRI√á√ïES -->
    <div class="admin-tab-content ativo" id="tab-inscricoes">
      <div class="admin-bloco">
        <strong>Busca / filtro</strong>
        <div class="filtros" style="margin-top:4px;">
          <div>
            <label for="adminFiltroNome">Nome</label>
            <input type="text" id="adminFiltroNome" placeholder="Parte do nome...">
          </div>
          <div>
            <label for="adminFiltroTurma">Turma</label>
            <select id="adminFiltroTurma">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            <label for="adminFiltroModalidade">Modalidade</label>
            <select id="adminFiltroModalidade">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Cancelar inscri√ß√£o</strong>
        <small style="display:block;margin-top:2px;">Busque pelo nome acima e escolha a modalidade espec√≠fica para cancelar.</small>
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
          <select id="selectCancelar" style="min-width:220px; flex:1;">
            <option value="">Selecione uma inscri√ß√£o...</option>
          </select>
          <button class="btn btn-primaria" id="btnCancelarInscricao">Cancelar</button>
        </div>
      </div>

      <table id="tabelaAdmin">
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>N¬∫ camisa</th>
            <th>Modalidades</th>
            <th>Obs</th>
            <th>Data/Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TAB JOGOS -->
    <div class="admin-tab-content" id="tab-jogos">
      <div class="admin-bloco">
        <strong>Cadastrar jogo</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoData">Data</label>
            <input type="date" id="jogoData">
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoTurma1">Turma 1</label>
            <select id="jogoTurma1">
              <option value="">Selecione a turma 1...</option>
            </select>
          </div>
          <div>
            <label for="jogoTurma2">Turma 2</label>
            <select id="jogoTurma2">
              <option value="">Selecione a turma 2...</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoModalidade">Modalidade</label>
            <select id="jogoModalidade">
              <option value="">Selecione...</option>
            </select>
          </div>
          <div>
            <label for="jogoHorario">Hor√°rio</label>
            <input type="time" id="jogoHorario">
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="jogoLocal">Local</label>
          <input type="text" id="jogoLocal" placeholder="Ex: Quadra principal">
        </div>
        <button class="btn btn-primaria" style="margin-top:6px;" id="btnCadastrarJogo">Cadastrar jogo</button>
      </div>

      <div class="admin-bloco">
        <strong>Jogos cadastrados</strong>
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
          <input type="text" id="filtroExcluirJogo" placeholder="Pesquisar jogo (turma, modalidade, data...)" style="flex:1; min-width:200px;">
          <select id="selectExcluirJogo" style="min-width:220px; flex:1;">
            <option value="">Selecione um jogo...</option>
          </select>
          <button class="btn btn-primaria" id="btnExcluirJogo">Excluir</button>
        </div>
      </div>

      <div class="admin-bloco" id="adminPainelJogos">
        <strong>Placar ao vivo / Status dos jogos</strong>
        <small style="display:block;margin-top:2px;">Atualize o status e o placar. As mudan√ßas aparecem em tempo real no site p√∫blico.</small>
        <div id="listaAdminJogos" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- TAB RELAT√ìRIO -->
    <div class="admin-tab-content" id="tab-relatorio">
      <div class="admin-bloco">
        <strong>Filtros para relat√≥rio</strong>
        <div class="filtros" style="margin-top:4px;">
          <div>
            <label for="relatorioTurno">Turno</label>
            <select id="relatorioTurno">
              <option value="">Selecione...</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Noturno">Noturno</option>
            </select>
          </div>
          <div>
            <label for="relatorioTurma">Turma</label>
            <select id="relatorioTurma">
              <option value="">Selecione o turno primeiro...</option>
            </select>
          </div>
          <div>
            <label for="relatorioModalidade">Modalidade</label>
            <select id="relatorioModalidade">
              <option value="">Selecione a modalidade...</option>
            </select>
          </div>
        </div>
        <div id="relatorioCabecalhoImpressao">
          <h3 id="relatorioTituloLinha1">Relat√≥rio de inscritos ‚Äì Movimenta Odisseia</h3>
          <small id="relatorioTituloLinha2">Selecione turno, turma e modalidade para gerar o relat√≥rio.</small>
        </div>
        <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn btn-primaria" id="btnImprimirRelatorio">üñ®Ô∏è Imprimir</button>
          <button class="btn btn-primaria" id="btnImprimirTodaTurma">üñ®Ô∏è Imprimir Toda Turma</button>
        </div>
      </div>

      <table id="tabelaRelatorio">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>Modalidades</th>
            <th>E-mail</th>
            <th>N¬∫ camisa</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TAB PROFESSORES (ADMIN GERENCIA SENHAS) -->
    <div class="admin-tab-content" id="tab-professores">
      <div class="admin-bloco">
        <strong>Cadastrar acesso de professor / coordenador / gestor</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="profNomeCadastro">Nome</label>
            <input type="text" id="profNomeCadastro" placeholder="Ex: Jean">
          </div>
          <div>
            <label for="profTipoCadastro">Tipo de acesso</label>
            <select id="profTipoCadastro">
              <option value="Professor">Professor</option>
              <option value="Coordenador">Coordenador</option>
              <option value="Gestor">Gestor</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="profSenhaCadastro">Senha</label>
            <div style="display:flex; gap:6px; align-items:center;">
              <input type="text" id="profSenhaCadastro" placeholder="Senha que ele vai usar" style="flex:1;">
              <button type="button" class="btn btn-primaria" id="btnGerarSenhaProfessor">Gerar senha</button>
            </div>
          </div>
        </div>
        <button class="btn btn-primaria" style="margin-top:6px;" id="btnAdicionarProfessor">‚ûï Adicionar acesso</button>
      </div>

      <div class="admin-bloco">
        <strong>Acessos cadastrados</strong>
        <small style="display:block;margin-top:2px;">Use para controlar quem pode entrar no painel de professores.</small>
        <table style="margin-top:4px; width:100%; border-collapse:collapse; font-size:0.8rem;">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Senha</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaProfessoresAdmin"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB CONFIG -->
    <div class="admin-tab-content" id="tab-config">
      <div class="admin-bloco">
        <strong>Datas e bloqueio</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgDataLimite">Data de encerramento</label>
            <input type="date" id="cfgDataLimite">
          </div>
          <div>
            <label><input type="checkbox" id="cfgBloquearAgora"> Bloquear inscri√ß√µes agora</label>
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="cfgMsgEncerradas">Mensagem quando estiver encerrado</label>
          <textarea id="cfgMsgEncerradas" placeholder="Ex: As inscri√ß√µes foram encerradas."></textarea>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Limites</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgLimitePorAluno">M√°x. modalidades por aluno</label>
            <input type="number" id="cfgLimitePorAluno" min="1">
          </div>
          <div>
            <label for="cfgQueimadaTotal">Queimada total (por turma)</label>
            <input type="number" id="cfgQueimadaTotal" min="1">
          </div>
          <div>
            <label for="cfgQueimadaSexo">Queimada por sexo</label>
            <input type="number" id="cfgQueimadaSexo" min="1">
          </div>
        </div>
        <p style="margin:6px 0 4px; font-size:0.8rem;"><strong>Limite por modalidade / turma</strong></p>
        <div class="grid-2">
          <div><label for="cfgFutsal">FUTSAL</label><input type="number" id="cfgFutsal" min="1"></div>
          <div><label for="cfgDomino">DOMIN√ì</label><input type="number" id="cfgDomino" min="1"></div>
          <div><label for="cfgFutmesa">FUTMESA</label><input type="number" id="cfgFutmesa" min="1"></div>
          <div><label for="cfgTenis">T√äNIS DE MESA</label><input type="number" id="cfgTenis" min="1"></div>
          <div><label for="cfgXadrez">XADREZ</label><input type="number" id="cfgXadrez" min="1"></div>
          <div><label for="cfgVolei">VOLEI</label><input type="number" id="cfgVolei" min="1"></div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Autoriza√ß√µes (ignorar limites por turma)</strong>
        <small style="display:block;margin-top:2px;">Selecione a turma e marque as modalidades que devem ser autorizadas ‚Äî quando marcada, a modalidade ser√° aceita mesmo que os limites estejam preenchidos (aplica-se √† QUEIMADA tamb√©m).</small>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
          <select id="cfgAutTurma" style="min-width:220px;">
            <option value="">Selecione a turma...</option>
          </select>
          <div id="cfgAutModalidadesContainer" style="flex:1;"></div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Texto do evento</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgNomeEvento">Nome do evento</label>
            <input type="text" id="cfgNomeEvento" placeholder="Movimenta Odisseia">
          </div>
          <div>
            <label for="cfgAnoEvento">Ano</label>
            <input type="text" id="cfgAnoEvento" placeholder="2025">
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="cfgTextoInicial">Texto abaixo do t√≠tulo</label>
          <textarea id="cfgTextoInicial"></textarea>
        </div>
      </div>

      <button class="btn btn-primaria" id="btnSalvarConfig">üíæ Salvar configura√ß√µes</button>
    </div>

    <!-- TAB CREDENCIAIS (NOVO) -->
    <div class="admin-tab-content" id="tab-credenciais">
      <div class="admin-bloco">
        <strong>Filtros - Credenciais</strong>
        <div class="filtros" style="margin-top:6px;">
          <div>
            <label for="credFiltroTurno">Turno</label>
            <select id="credFiltroTurno">
              <option value="">Todos</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Noturno">Noturno</option>
            </select>
          </div>
          <div>
            <label for="credFiltroTurma">Turma</label>
            <select id="credFiltroTurma">
              <option value="">Selecione o turno primeiro...</option>
            </select>
          </div>
          <div>
            <label for="credFiltroModalidade">Modalidade</label>
            <select id="credFiltroModalidade">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Listagem de inscritos (individual)</strong>
        <small style="display:block;margin-top:4px;">Cada inscri√ß√£o aparece separada ‚Äî clique em <strong>Imprimir Credenciais</strong> para gerar o crach√° em PDF com QR Code.</small>
        <div id="credListContainer" style="margin-top:8px;"></div>
      </div>

      <div class="admin-bloco">
        <strong>Escaneador (valida√ß√£o / crach√°)</strong>
        <small style="display:block;margin-top:4px;">Digite a senha administrativa para abrir o leitor de QR Code.</small>
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <input type="password" id="scannerSenha" placeholder="Senha administrativa" style="flex:1; min-width:180px;">
          <button class="btn btn-primaria" id="btnAbrirScanner">Abrir Escaneador</button>
          <button class="btn" id="btnAbrirScannerChamada">Abrir Escaneador (CHAMADA)</button>
        </div>
        <div style="margin-top:8px;">
          <small>Observa√ß√£o: o escaneador volta automaticamente para ler o pr√≥ximo crach√° ap√≥s valida√ß√£o.</small>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>CHAMADA (por jogo)</strong>
        <small style="display:block;margin-top:4px;">Filtre e selecione um jogo abaixo ‚Äî a chamada marcar√° presen√ßa por jogo (op√ß√£o B).</small>
        <div class="filtros" style="margin-top:6px;">
          <div>
            <label for="chamadaFiltroTurno">Turno</label>
            <select id="chamadaFiltroTurno">
              <option value="">Todos</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Noturno">Noturno</option>
            </select>
          </div>
          <div>
            <label for="chamadaFiltroTurma">Turma</label>
            <select id="chamadaFiltroTurma">
              <option value="">Selecione o turno primeiro...</option>
            </select>
          </div>
          <div>
            <label for="chamadaFiltroModalidade">Modalidade</label>
            <select id="chamadaFiltroModalidade">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px;">
          <label for="selectJogoChamada">Selecione o Jogo (opcional ‚Äî se vazio o sistema tenta detectar automaticamente)</label>
          <select id="selectJogoChamada" style="width:100%; margin-top:6px;">
            <option value="">Escolha um jogo...</option>
          </select>
        </div>

        <div style="margin-top:10px;">
          <button class="btn btn-primaria" id="btnGerarListaChamada">Gerar lista de chamada</button>
        </div>

        <div id="chamadaList" style="margin-top:8px;"></div>
      </div>
    </div>

  </section>

  <!-- PAINEL PARA PROFESSORES / COORDENADORES / GESTORES -->
  <section class="card" id="professoresSection">
    <div class="admin-header">
      <div>
        <h2>Painel de professores</h2>
        <div class="admin-sub">
          Selecione turno e turma para indicar alunos que <strong>n√£o podem participar</strong>.
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span style="font-size:0.8rem;" id="profUsuarioAtivo">Professor logado</span>
        <button class="btn btn-primaria" id="btnFecharProfessores">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="admin-bloco">
      <strong>Filtrar turma</strong>
      <div class="filtros" style="margin-top:4px;">
        <div>
          <label for="profTurnoSelect">Turno</label>
          <select id="profTurnoSelect">
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="profTurmaSelect">Turma</label>
          <select id="profTurmaSelect">
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>
    </div>

    <div class="admin-bloco">
      <strong>Alunos inscritos na turma</strong>
      <small style="display:block;margin-top:2px;">
        Clique para indicar que o aluno <strong>n√£o deve participar</strong>. Quando dois professores diferentes indicarem o mesmo aluno, a inscri√ß√£o ser√° cancelada automaticamente.
      </small>
      <div id="profListaAlunos" style="margin-top:6px;"></div>
    </div>
  </section>

</main>

<!-- SCANNER OVERLAY -->
<div id="scannerOverlay">
  <div id="scannerCard">
    <div id="scannerHeader">
      <div>
        <strong>Escaneador de QR</strong>
        <div style="font-size:0.85rem; color:#444;">Aproxime a c√¢mera do crach√° para validar.</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="btnFecharScanner">Fechar</button>
      </div>
    </div>

    <div id="scannerArea" style="min-height:280px;">
      <!-- local where html5-qrcode will render -->
      <div id="html5qr-inline-full-region" style="width:100%;"></div>
    </div>

    <div id="scannerResult" class="">
      <!-- result panel populated dynamically -->
    </div>
  </div>
</div>

<script>
"use strict";

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== CONSTANTES & ESTADO ========== */
const MODALIDADES = [
  "FUTSAL",
  "QUEIMADA MISTA",
  "DOMIN√ì",
  "FUTMESA",
  "T√äNIS DE MESA",
  "XADREZ",
  "VOLEI"
];

const TURMAS_MATUTINO = [
  "7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F","8¬∫F","9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"
];

const TURMAS_VESPERTINO = [
  "6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G","8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"
];

const TURMAS_NOTURNO = [
  "1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F","2¬∫A","2¬∫B","2¬∫C","3¬∫A","3¬∫B","3¬∫C"
];

const TODAS_TURMAS = [...TURMAS_MATUTINO, ...TURMAS_VESPERTINO, ...TURMAS_NOTURNO];

function getTurmasPorTurno(turno){ if (turno==="Matutino") return TURMAS_MATUTINO; if (turno==="Vespertino") return TURMAS_VESPERTINO; if (turno==="Noturno") return TURMAS_NOTURNO; return []; }
function getSerieFromTurma(t){ if(!t) return ""; return t.charAt(0); }

let LIMITE_MODALIDADES_POR_ALUNO = 2;
let LIMITE_MODALIDADE_TURMA = { "FUTSAL":8, "DOMIN√ì":2, "FUTMESA":2, "T√äNIS DE MESA":2, "XADREZ":2, "VOLEI":6 };
let LIMITE_QUEIMADA_TOTAL = 10;
let LIMITE_QUEIMADA_POR_SEXO = 5;

let countsPorTurmaModalidade = {};
let countsQueimadaGenero = {};
let todasInscricoes = [];
let todosJogos = [];
let todosProfessores = [];

let configEvento = { dataLimite:null, msgEncerradas:"", bloquearAgora:false, nomeEvento:"Movimenta Odisseia", anoEvento:"", textoInicial:"", autorizacoes:{} };

let inscricoesEncerradas = false;
let emailAtual = null;
let isAdmin = false;
const ADMIN_PASSWORD = "52090949"; // mantenho a mesma senha que voc√™ usava

/* scanner state */
let html5QrScannerInstance = null;
let scanningMode = null; // "VALIDACAO" ou "CHAMADA"
let chamadaGameSelected = ""; // id do jogo selecionado para chamada
let chamadaGameContext = null;

/* ========== HELPERS ========== */

function normalizarNome(str){ return (str||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," "); }
function validarEmail(email){ return email && email.includes("@") && email.includes("."); }
function msgForm(texto, ok){ const box = document.getElementById("msgForm"); box.innerHTML=""; const div=document.createElement("div"); div.className = ok ? "msg-sucesso" : "msg-erro"; div.textContent = texto; box.appendChild(div); }
function formatarDataBR(yyyyMMdd){ if(!yyyyMMdd) return "-"; const p=yyyyMMdd.split("-"); if(p.length!==3) return yyyyMMdd; return p[2]+"/"+p[1]+"/"+p[0]; }

/* ========== ATUALIZA√á√ÉO DE CONFIG E LIMITES (mesma l√≥gica) ========== */

function atualizarStatusInscricoes(){
  const hoje = new Date();
  const hojeDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  let fechado = false;
  if (configEvento.bloquearAgora) fechado = true;
  else if (configEvento.dataLimite){
    const p = configEvento.dataLimite.split("-");
    if (p.length === 3){
      const limiteDia = new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2]));
      if (hojeDia.getTime() >= limiteDia.getTime()) fechado = true;
    }
  }
  inscricoesEncerradas = fechado;
  const form = document.getElementById("formInscricao");
  const adminStatus = document.getElementById("adminStatus");
  if (form){
    const campos = form.querySelectorAll("input,select,textarea,button[type='submit']");
    campos.forEach(el => { el.disabled = fechado; });
  }
  if (fechado){
    msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false);
    if (adminStatus){ adminStatus.textContent = "Inscri√ß√µes ENCERRADAS"; adminStatus.classList.add("fechado"); }
  } else {
    document.getElementById("msgForm").innerHTML = "";
    if (adminStatus){ adminStatus.textContent = "Inscri√ß√µes ABERTAS"; adminStatus.classList.remove("fechado"); }
  }
}

/* ========== CARREGAR / SALVAR CONFIG ========== */

async function carregarConfiguracoes(){
  try{
    const docSnap = await db.collection("config").doc("geral").get();
    if (docSnap.exists){
      const d = docSnap.data();
      if (d.dataLimiteInscricao) configEvento.dataLimite = d.dataLimiteInscricao;
      if (typeof d.bloquearInscricoesAgora === "boolean") configEvento.bloquearAgora = d.bloquearInscricoesAgora;
      if (d.mensagemEncerradas) configEvento.msgEncerradas = d.mensagemEncerradas;
      if (typeof d.limiteModalidadesPorAluno === "number") LIMITE_MODALIDADES_POR_ALUNO = d.limiteModalidadesPorAluno;
      if (typeof d.limiteQueimadaTotal === "number") LIMITE_QUEIMADA_TOTAL = d.limiteQueimadaTotal;
      if (typeof d.limiteQueimadaPorSexo === "number") LIMITE_QUEIMADA_POR_SEXO = d.limiteQueimadaPorSexo;
      if (d.limitesModalidadeTurma){
        Object.keys(d.limitesModalidadeTurma).forEach(m => {
          const val = d.limitesModalidadeTurma[m];
          if (typeof val === "number"){
            LIMITE_MODALIDADE_TURMA[m] = val;
          }
        });
      }
      if (d.nomeEvento) configEvento.nomeEvento = d.nomeEvento;
      if (d.anoEdicao) configEvento.anoEvento = d.anoEdicao;
      if (d.textoInicial) configEvento.textoInicial = d.textoInicial;
      if (d.autorizacoes) configEvento.autorizacoes = d.autorizacoes || {};
    }
  }catch(e){ console.error("Erro ao carregar configura√ß√µes:", e); }

  document.getElementById("cfgDataLimite").value = configEvento.dataLimite || "";
  document.getElementById("cfgMsgEncerradas").value = configEvento.msgEncerradas || "";
  document.getElementById("cfgBloquearAgora").checked = !!configEvento.bloquearAgora;
  document.getElementById("cfgLimitePorAluno").value = LIMITE_MODALIDADES_POR_ALUNO;
  document.getElementById("cfgQueimadaTotal").value = LIMITE_QUEIMADA_TOTAL;
  document.getElementById("cfgQueimadaSexo").value = LIMITE_QUEIMADA_POR_SEXO;
  document.getElementById("cfgFutsal").value = LIMITE_MODALIDADE_TURMA["FUTSAL"];
  document.getElementById("cfgDomino").value = LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
  document.getElementById("cfgFutmesa").value = LIMITE_MODALIDADE_TURMA["FUTMESA"];
  document.getElementById("cfgTenis").value = LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
  document.getElementById("cfgXadrez").value = LIMITE_MODALIDADE_TURMA["XADREZ"];
  document.getElementById("cfgVolei").value = LIMITE_MODALIDADE_TURMA["VOLEI"];
  document.getElementById("cfgNomeEvento").value = configEvento.nomeEvento || "";
  document.getElementById("cfgAnoEvento").value = configEvento.anoEvento || "";
  document.getElementById("cfgTextoInicial").value = configEvento.textoInicial || "";

  document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
  if (configEvento.textoInicial) document.getElementById("subEvento").textContent = configEvento.textoInicial;
  atualizarAutorizacoesUI();
  atualizarStatusInscricoes();
  atualizarDisponibilidadeModalidades();
}

async function salvarConfiguracoes(){
  if (!isAdmin){ alert("Apenas o administrador pode salvar as configura√ß√µes."); return; }
  const dataLimite = (document.getElementById("cfgDataLimite").value || "").trim();
  const msgEnc = (document.getElementById("cfgMsgEncerradas").value || "").trim();
  const bloquearAgora = document.getElementById("cfgBloquearAgora").checked;

  const limAluno = parseInt(document.getElementById("cfgLimitePorAluno").value,10) || LIMITE_MODALIDADES_POR_ALUNO;
  const limQueimadaTot = parseInt(document.getElementById("cfgQueimadaTotal").value,10) || LIMITE_QUEIMADA_TOTAL;
  const limQueimadaSex = parseInt(document.getElementById("cfgQueimadaSexo").value,10) || LIMITE_QUEIMADA_POR_SEXO;

  const limFutsal = parseInt(document.getElementById("cfgFutsal").value,10) || LIMITE_MODALIDADE_TURMA["FUTSAL"];
  const limDomino = parseInt(document.getElementById("cfgDomino").value,10) || LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
  const limFutmesa = parseInt(document.getElementById("cfgFutmesa").value,10) || LIMITE_MODALIDADE_TURMA["FUTMESA"];
  const limTenis = parseInt(document.getElementById("cfgTenis").value,10) || LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
  const limXadrez = parseInt(document.getElementById("cfgXadrez").value,10) || LIMITE_MODALIDADE_TURMA["XADREZ"];
  const limVolei = parseInt(document.getElementById("cfgVolei").value,10) || LIMITE_MODALIDADE_TURMA["VOLEI"];

  const nomeEvento = (document.getElementById("cfgNomeEvento").value || "").trim();
  const anoEvento = (document.getElementById("cfgAnoEvento").value || "").trim();
  const textoInicial = (document.getElementById("cfgTextoInicial").value || "").trim();

  const limitesModalidadeTurma = {
    "FUTSAL": limFutsal,
    "DOMIN√ì": limDomino,
    "FUTMESA": limFutmesa,
    "T√äNIS DE MESA": limTenis,
    "XADREZ": limXadrez,
    "VOLEI": limVolei
  };

  try{
    await db.collection("config").doc("geral").set({
      dataLimiteInscricao: dataLimite || null,
      mensagemEncerradas: msgEnc,
      bloquearInscricoesAgora: bloquearAgora,
      limiteModalidadesPorAluno: limAluno,
      limiteQueimadaTotal: limQueimadaTot,
      limiteQueimadaPorSexo: limQueimadaSex,
      limitesModalidadeTurma: limitesModalidadeTurma,
      nomeEvento: nomeEvento,
      anoEdicao: anoEvento,
      textoInicial: textoInicial,
      autorizacoes: configEvento.autorizacoes || {}
    }, { merge:true });

    configEvento.dataLimite = dataLimite || null;
    configEvento.msgEncerradas = msgEnc;
    configEvento.bloquearAgora = bloquearAgora;
    LIMITE_MODALIDADES_POR_ALUNO = limAluno;
    LIMITE_QUEIMADA_TOTAL = limQueimadaTot;
    LIMITE_QUEIMADA_POR_SEXO = limQueimadaSex;
    LIMITE_MODALIDADE_TURMA = limitesModalidadeTurma;
    configEvento.nomeEvento = nomeEvento;
    configEvento.anoEvento = anoEvento;
    configEvento.textoInicial = textoInicial;

    document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
    if (configEvento.textoInicial) document.getElementById("subEvento").textContent = configEvento.textoInicial;

    atualizarStatusInscricoes();
    atualizarDisponibilidadeModalidades();
    alert("Configura√ß√µes salvas com sucesso.");
  }catch(e){ console.error(e); alert("Erro ao salvar configura√ß√µes."); }
}

/* ========== AUTORIZA√á√ïES UI ========== */
function atualizarAutorizacoesUI(){
  const sel = document.getElementById("cfgAutTurma");
  const cont = document.getElementById("cfgAutModalidadesContainer");
  if (!sel || !cont) return;
  sel.innerHTML = '<option value="">Selecione a turma...</option>';
  TODAS_TURMAS.forEach(t => {
    const o = document.createElement("option"); o.value = t; o.textContent = t; sel.appendChild(o);
  });

  cont.innerHTML = "";
  MODALIDADES.forEach(m => {
    const id = "cfgAutChk_" + m.replace(/\s+/g,"_");
    const wrapper = document.createElement("label");
    wrapper.style.marginRight = "10px";
    wrapper.style.fontSize = "0.9rem";
    wrapper.style.display = "inline-flex";
    wrapper.style.alignItems = "center";
    wrapper.style.gap = "6px";
    const chk = document.createElement("input");
    chk.type = "checkbox"; chk.id = id; chk.dataset.mod = m; chk.className = "cfgAutChk";
    wrapper.appendChild(chk);
    const span = document.createElement("span"); span.textContent = "Permitir " + m; wrapper.appendChild(span);
    cont.appendChild(wrapper);
    chk.onchange = () => {
      const turma = sel.value;
      if (!turma) return;
      if (!configEvento.autorizacoes) configEvento.autorizacoes = {};
      if (!configEvento.autorizacoes[turma]) configEvento.autorizacoes[turma] = {};
      configEvento.autorizacoes[turma][m] = chk.checked ? true : false;
    };
  });

  sel.addEventListener("change", () => {
    const turma = sel.value;
    const autorz = (configEvento.autorizacoes && configEvento.autorizacoes[turma]) || {};
    const chks = document.querySelectorAll(".cfgAutChk");
    chks.forEach(chk => { const mod = chk.dataset.mod; chk.checked = !!autorz[mod]; });
  });
}

/* ========== DISPONIBILIDADE MODALIDADES ========== */
function atualizarDisponibilidadeModalidades(){
  const turma = document.getElementById("turma") ? document.getElementById("turma").value : "";
  const sexo = document.getElementById("sexo") ? document.getElementById("sexo").value : "";
  const spans = document.querySelectorAll(".modalidade-vagas");
  const chks = document.querySelectorAll(".chkModalidade");

  spans.forEach(span => {
    const mod = span.dataset.mod;
    if (!turma){
      span.textContent = mod + " (selecione turno e turma)";
      span.classList.remove("modalidade-lotado");
      return;
    }
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0, Feminino:0};
      span.textContent = mod + " ("+tot+"/"+LIMITE_QUEIMADA_TOTAL+" / Meninos: "+gen.Masculino+"/"+LIMITE_QUEIMADA_POR_SEXO+" / Meninas: "+gen.Feminino+"/"+LIMITE_QUEIMADA_POR_SEXO+")" + (autorizada ? " ‚Äî AUTORIZADO" : "");
      if (tot >= LIMITE_QUEIMADA_TOTAL && !autorizada) span.classList.add("modalidade-lotado"); else span.classList.remove("modalidade-lotado");
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      span.textContent = mod + " ("+qtd+"/"+lim+" vagas)" + (autorizada ? " ‚Äî AUTORIZADO" : "");
      if (qtd >= lim && !autorizada) span.classList.add("modalidade-lotado"); else span.classList.remove("modalidade-lotado");
    }
  });

  chks.forEach(chk => {
    const mod = chk.value;
    if (!turma){ chk.disabled = true; chk.checked = false; return; }
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0,Feminino:0};
      if (!sexo || (tot >= LIMITE_QUEIMADA_TOTAL && !autorizada)){ chk.disabled=true; chk.checked=false; return; }
      if (sexo==="Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO && !autorizada){ chk.disabled=true; chk.checked=false; return; }
      if (sexo==="Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO && !autorizada){ chk.disabled=true; chk.checked=false; return; }
      chk.disabled=false;
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim && !autorizada){ chk.disabled=true; chk.checked=false; } else { chk.disabled=false; }
    }
  });
}

/* ========== INSCRI√á√ÉO ========== */

async function handleSubmitInscricao(e){
  e.preventDefault();
  if (inscricoesEncerradas){
    msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false);
    return;
  }
  if (!emailAtual){
    try{ const fromStorage = localStorage.getItem('insc_email'); if (validarEmail(fromStorage)) emailAtual = fromStorage; }catch(e){}
  }
  if (!emailAtual || !validarEmail(emailAtual)){ alert("Informe um e-mail v√°lido antes de se inscrever."); return; }

  const nome = document.getElementById("nome").value.trim();
  const sexo = document.getElementById("sexo").value;
  const turno = document.getElementById("turno").value;
  const turma = document.getElementById("turma").value;
  const camisaNumero = document.getElementById("camisaNumero").value.trim();
  const observacoes = document.getElementById("observacoes").value.trim();

  const nomeNorm = normalizarNome(nome);
  if (!nome || !sexo || !turno || !turma){ msgForm("Preencha nome, sexo, turno e turma.", false); return; }

  const chks = document.querySelectorAll(".chkModalidade:checked");
  const mods = [];
  chks.forEach(chk => mods.push(chk.value));
  if (!mods.length){ msgForm("Escolha pelo menos 1 modalidade.", false); return; }
  if (mods.length > LIMITE_MODALIDADES_POR_ALUNO){ msgForm("Voc√™ s√≥ pode escolher at√© "+LIMITE_MODALIDADES_POR_ALUNO+" modalidades.", false); return; }

  for (const ins of todasInscricoes){ if (ins.nomeNormalizado === nomeNorm && ins.turma === turma){ msgForm("J√° existe inscri√ß√£o para este nome nesta turma.", false); return; } }

  for (const mod of mods){
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (autorizada) continue;
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0,Feminino:0};
      if (tot >= LIMITE_QUEIMADA_TOTAL){ msgForm("QUEIMADA MISTA est√° lotada para a turma "+turma+".", false); return; }
      if (sexo==="Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO){ msgForm("Limite de meninos na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return; }
      if (sexo==="Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO){ msgForm("Limite de meninas na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return; }
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim){ msgForm('A modalidade "'+mod+'" est√° lotada para a turma '+turma+".", false); return; }
    }
  }

  try{
    await db.collection("inscricoes").add({
      nome: nome,
      nomeNormalizado: nomeNorm,
      email: emailAtual,
      sexo: sexo,
      turno: turno,
      turma: turma,
      camisaNumero: camisaNumero || null,
      modalidades: mods,
      observacoes: observacoes || null,
      naoAutorizadoPor: [],
      presencas: {}, // campo onde ser√£o gravadas as presen√ßas por jogo
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgForm("Inscri√ß√£o realizada com sucesso! ‚úÖ", true);
    document.getElementById("formInscricao").reset();
    document.getElementById("turma").innerHTML = '<option value="">Selecione o turno primeiro...</option>';
    document.getElementById("turma").disabled = true;
    atualizarDisponibilidadeModalidades();
  }catch(err){ console.error(err); msgForm("Erro ao salvar inscri√ß√£o. Tente novamente.", false); }
}

/* ========== CANCELAR INSCRI√á√ÉO (ADMIN) ========== */

async function cancelarInscricao(){
  if (!isAdmin){ alert("Apenas o administrador pode cancelar inscri√ß√µes."); return; }
  const sel = document.getElementById("selectCancelar");
  const raw = sel.value;
  if (!raw){ alert("Selecione uma inscri√ß√£o."); return; }
  const partes = raw.split("|||");
  const id = partes[0];
  const modalidadeSelecionada = partes[1] || null;
  const ins = todasInscricoes.find(i => i.id === id);
  if (!ins){ alert("Inscri√ß√£o n√£o encontrada."); return; }
  if (!modalidadeSelecionada){ alert("Modalidade inv√°lida."); return; }
  const mensagemConfirm = 'Cancelar a modalidade "'+modalidadeSelecionada+'" do aluno "'+ins.nome+'" da turma '+ins.turma+'?\n\nSe esta for a √∫nica modalidade, a inscri√ß√£o inteira ser√° removida.';
  if (!confirm(mensagemConfirm)) return;
  try{
    const modalidadesAtuais = Array.isArray(ins.modalidades) ? ins.modalidades.slice() : [];
    const filtradas = modalidadesAtuais.filter(m => m !== modalidadeSelecionada);
    if (filtradas.length === 0){
      await db.collection("inscricoes").doc(id).delete();
      alert("Inscri√ß√£o completa cancelada.");
    } else {
      await db.collection("inscricoes").doc(id).update({ modalidades: filtradas });
      alert("Modalidade cancelada com sucesso.");
    }
  }catch(e){ console.error(e); alert("Erro ao cancelar inscri√ß√£o."); }
}

/* ========== RENDERS E TABELAS EXISTENTES ========== */

function renderPublico(){
  const corpo = document.querySelector("#tabelaPublica tbody");
  const filtroTurnoEl = document.getElementById("filtroTurno");
  const filtroTurmaEl = document.getElementById("filtroTurma");
  const filtroModEl = document.getElementById("filtroModalidade");
  if (!corpo || !filtroTurnoEl || !filtroTurmaEl || !filtroModEl) return;
  const turno = filtroTurnoEl.value;
  const turma = filtroTurmaEl.value;
  const mod = filtroModEl.value;
  corpo.innerHTML = "";
  if (!turno || !turma || !mod){
    const tr = document.createElement("tr"); const td=document.createElement("td"); td.colSpan=2; td.textContent="Selecione turno, turma e modalidade para ver os inscritos."; tr.appendChild(td); corpo.appendChild(tr); return;
  }
  const lista = todasInscricoes.filter(ins => ins.turno===turno && ins.turma===turma && ins.modalidades && ins.modalidades.includes(mod));
  if (!lista.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=2; td.textContent="Nenhum inscrito para esses filtros."; tr.appendChild(td); corpo.appendChild(tr); return; }
  lista.forEach(ins => { const tr=document.createElement("tr"); const tdN=document.createElement("td"); const tdT=document.createElement("td"); tdN.textContent = ins.nome; tdT.textContent = ins.turma; tr.appendChild(tdN); tr.appendChild(tdT); corpo.appendChild(tr); });
}

function renderAdmin(){
  if (!isAdmin) return;
  const corpo = document.querySelector("#tabelaAdmin tbody");
  corpo.innerHTML = "";
  const nomeFiltro = (document.getElementById("adminFiltroNome").value || "").toLowerCase();
  const turmaFiltro = document.getElementById("adminFiltroTurma").value;
  const modFiltro = document.getElementById("adminFiltroModalidade").value;
  const lista = todasInscricoes.filter(ins => {
    if (nomeFiltro && !(ins.nome||"").toLowerCase().includes(nomeFiltro)) return false;
    if (turmaFiltro && ins.turma !== turmaFiltro) return false;
    if (modFiltro && (!ins.modalidades || !ins.modalidades.includes(modFiltro))) return false;
    return true;
  });
  if (!lista.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=9; td.textContent="Nenhuma inscri√ß√£o com esses filtros."; tr.appendChild(td); corpo.appendChild(tr); return; }
  lista.forEach(ins => {
    const tr=document.createElement("tr");
    const tdN=document.createElement("td"); const tdE=document.createElement("td"); const tdS=document.createElement("td");
    const tdT=document.createElement("td"); const tdTu=document.createElement("td"); const tdC=document.createElement("td");
    const tdM=document.createElement("td"); const tdO=document.createElement("td"); const tdD=document.createElement("td");
    tdN.textContent = ins.nome || ""; tdE.textContent = ins.email || ""; tdS.textContent = ins.sexo || "";
    tdT.textContent = ins.turma || ""; tdTu.textContent = ins.turno || ""; tdC.textContent = ins.camisaNumero || "";
    tdM.textContent = (ins.modalidades || []).join(", "); tdO.textContent = ins.observacoes || "";
    if (ins.timestamp && ins.timestamp.toDate){ const d=ins.timestamp.toDate(); tdD.textContent = d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}); } else tdD.textContent = "-";
    tr.appendChild(tdN); tr.appendChild(tdE); tr.appendChild(tdS); tr.appendChild(tdT); tr.appendChild(tdTu); tr.appendChild(tdC); tr.appendChild(tdM); tr.appendChild(tdO); tr.appendChild(tdD);
    corpo.appendChild(tr);
  });
}

/* ========== RELAT√ìRIO ========== */

function renderRelatorio(){
  const tbody = document.querySelector("#tabelaRelatorio tbody");
  const turnoEl = document.getElementById("relatorioTurno");
  const turmaEl = document.getElementById("relatorioTurma");
  const modEl = document.getElementById("relatorioModalidade");
  const tituloLinha1 = document.getElementById("relatorioTituloLinha1");
  const tituloLinha2 = document.getElementById("relatorioTituloLinha2");
  if (!tbody || !turnoEl || !turmaEl || !modEl) return;
  const turno = turnoEl.value;
  const turma = turmaEl.value;
  const modalidade = modEl.value;
  tbody.innerHTML = "";
  tituloLinha1.textContent = "Relat√≥rio de inscritos ‚Äì " + (configEvento.nomeEvento || "Movimenta Odisseia");
  if (!turno || !turma || !modalidade){ tituloLinha2.textContent = "Selecione turno, turma e modalidade para gerar o relat√≥rio."; const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=8; td.textContent="Selecione turno, turma e modalidade para gerar o relat√≥rio."; tr.appendChild(td); tbody.appendChild(tr); return; }
  let lista = todasInscricoes.filter(ins => ins.turno===turno && ins.turma===turma && ins.modalidades && ins.modalidades.includes(modalidade));
  lista = lista.slice().sort((a,b) => (a.nome||"").localeCompare(b.nome||"","pt-BR"));
  if (!lista.length){ tituloLinha2.textContent = `Turno: ${turno} | Turma: ${turma} | Modalidade: ${modalidade} ‚Äì 0 inscritos.`; const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=8; td.textContent="Nenhuma inscri√ß√£o para esses filtros."; tr.appendChild(td); tbody.appendChild(tr); return; }
  tituloLinha2.textContent = `Turno: ${turno} | Turma: ${turma} | Modalidade: ${modalidade} ‚Äì Total: ${lista.length} inscrito(s).`;
  lista.forEach(ins => {
    const tr=document.createElement("tr");
    const tdNome=document.createElement("td"); const tdSexo=document.createElement("td"); const tdTurma=document.createElement("td");
    const tdTurno=document.createElement("td"); const tdModalidades=document.createElement("td"); const tdEmail=document.createElement("td");
    const tdCamisa=document.createElement("td"); const tdObs=document.createElement("td");
    tdNome.textContent = ins.nome || ""; tdSexo.textContent = ins.sexo || ""; tdTurma.textContent = ins.turma || "";
    tdTurno.textContent = ins.turno || ""; tdModalidades.textContent = modalidade; tdEmail.textContent = ins.email || "";
    tdCamisa.textContent = ins.camisaNumero || ""; tdObs.textContent = ins.observacoes || "";
    tr.appendChild(tdNome); tr.appendChild(tdSexo); tr.appendChild(tdTurma); tr.appendChild(tdTurno); tr.appendChild(tdModalidades); tr.appendChild(tdEmail); tr.appendChild(tdCamisa); tr.appendChild(tdObs);
    tbody.appendChild(tr);
  });
}

function renderRelatorioTodaTurma(){
  const tbody = document.querySelector("#tabelaRelatorio tbody");
  const turnoEl = document.getElementById("relatorioTurno");
  const turmaEl = document.getElementById("relatorioTurma");
  const tituloLinha1 = document.getElementById("relatorioTituloLinha1");
  const tituloLinha2 = document.getElementById("relatorioTituloLinha2");
  if (!tbody || !turnoEl || !turmaEl) return;
  const turno = turnoEl.value; const turma = turmaEl.value;
  tbody.innerHTML = "";
  tituloLinha1.textContent = "Relat√≥rio completo da turma ‚Äì " + (configEvento.nomeEvento || "Movimenta Odisseia");
  if (!turno || !turma){ tituloLinha2.textContent = "Selecione turno e turma para gerar o relat√≥rio da turma inteira."; const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=8; td.textContent="Selecione turno e turma para gerar o relat√≥rio da turma inteira."; tr.appendChild(td); tbody.appendChild(tr); return; }
  let lista = todasInscricoes.filter(ins => ins.turno===turno && ins.turma===turma);
  lista = lista.slice().sort((a,b) => (a.nome||"").localeCompare(b.nome||"","pt-BR"));
  if (!lista.length){ tituloLinha2.textContent = `Turno: ${turno} | Turma: ${turma} ‚Äì Total: 0 inscritos.`; const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=8; td.textContent="Nenhuma inscri√ß√£o nesta turma."; tr.appendChild(td); tbody.appendChild(tr); return; }
  tituloLinha2.textContent = `Turno: ${turno} | Turma: ${turma} ‚Äì Total: ${lista.length} inscrito(s).`;
  lista.forEach(ins => {
    const tr=document.createElement("tr");
    const tdNome=document.createElement("td"); const tdSexo=document.createElement("td"); const tdTurma=document.createElement("td");
    const tdTurno=document.createElement("td"); const tdModalidades=document.createElement("td"); const tdEmail=document.createElement("td");
    const tdCamisa=document.createElement("td"); const tdObs=document.createElement("td");
    tdNome.textContent = ins.nome || ""; tdSexo.textContent = ins.sexo || ""; tdTurma.textContent = ins.turma || "";
    tdTurno.textContent = ins.turno || ""; tdModalidades.textContent = (ins.modalidades||[]).join(", "); tdEmail.textContent = ins.email || "";
    tdCamisa.textContent = ins.camisaNumero || ""; tdObs.textContent = ins.observacoes || "";
    tr.appendChild(tdNome); tr.appendChild(tdSexo); tr.appendChild(tdTurma); tr.appendChild(tdTurno); tr.appendChild(tdModalidades); tr.appendChild(tdEmail); tr.appendChild(tdCamisa); tr.appendChild(tdObs);
    tbody.appendChild(tr);
  });
}

/* preencher selects (filtros e cancelar) */
function atualizarSelectsAdminPublico(){
  const filtroTurma = document.getElementById("filtroTurma");
  const filtroMod = document.getElementById("filtroModalidade");
  const adminTurma = document.getElementById("adminFiltroTurma");
  const adminMod = document.getElementById("adminFiltroModalidade");
  const selectCancel = document.getElementById("selectCancelar");

  const turmasSet = new Set();
  todasInscricoes.forEach(i => { if (i.turma) turmasSet.add(i.turma); });
  const turmasOrd = Array.from(turmasSet).sort();

  adminTurma.innerHTML = '<option value="">Todas</option>';
  turmasOrd.forEach(t => { const opt=document.createElement("option"); opt.value=t; opt.textContent=t; adminTurma.appendChild(opt); });

  filtroMod.innerHTML = '<option value="">Selecione a modalidade...</option>';
  adminMod.innerHTML = '<option value="">Todas</option>';
  MODALIDADES.forEach(m => { const o1=document.createElement("option"); o1.value=m; o1.textContent=m; filtroMod.appendChild(o1); const o2=document.createElement("option"); o2.value=m; o2.textContent=m; adminMod.appendChild(o2); });

  const nomeFiltro = (document.getElementById("adminFiltroNome").value || "").toLowerCase();
  const turmaFiltro = document.getElementById("adminFiltroTurma").value;

  selectCancel.innerHTML = '<option value="">Selecione uma inscri√ß√£o...</option>';
  todasInscricoes.forEach(ins => {
    if (nomeFiltro && !(ins.nome||"").toLowerCase().includes(nomeFiltro)) return;
    if (turmaFiltro && ins.turma !== turmaFiltro) return;
    (ins.modalidades || []).forEach(mod => {
      const opt = document.createElement("option");
      opt.value = ins.id + "|||" + mod;
      opt.textContent = ins.nome + " ‚Äî " + ins.turma + " ‚Äî " + mod;
      selectCancel.appendChild(opt);
    });
  });
}

/* ========== JOGOS & ADMIN JOGOS ========== */

function renderJogosAluno(){
  const serieEl = document.getElementById("filtroSerieJogo");
  const modalidadeEl = document.getElementById("filtroModalidadeJogo");
  const dataEl = document.getElementById("filtroDataJogo");
  const container = document.getElementById("listaJogosContainer");
  if (!serieEl || !modalidadeEl || !dataEl || !container) return;
  const serie = serieEl.value;
  const modalidade = modalidadeEl.value;
  const dataFiltro = dataEl.value;
  container.innerHTML = "";
  if (!serie || !modalidade){ container.textContent = "Selecione a s√©rie e a modalidade para ver os jogos."; return; }
  let lista = todosJogos.filter(j => {
    const s1 = getSerieFromTurma(j.turma1); const s2 = getSerieFromTurma(j.turma2);
    if (s1 !== serie && s2 !== serie) return false;
    if (j.modalidade !== modalidade) return false;
    if (dataFiltro && j.dataJogo !== dataFiltro) return false;
    return true;
  });
  if (!lista.length){ container.textContent = "Nenhum jogo para esses filtros."; return; }
  lista = lista.slice().sort((a,b) => ((a.dataJogo||"") + " " + (a.horarioJogo||"")).localeCompare((b.dataJogo||"") + " " + (b.horarioJogo||"")));
  lista.forEach(j => {
    const div = document.createElement("div"); div.className = "jogo-bloco";
    div.innerHTML = "<strong>"+(j.modalidade||"-")+"</strong><br>Data: "+formatarDataBR(j.dataJogo)+" ‚Äî Hor√°rio: "+(j.horarioJogo||"-")+"<br>Jogo: "+(j.turma1||"")+" x "+(j.turma2||"")+"<br>Local: "+(j.localJogo||"-");
    container.appendChild(div);
  });
}

function renderPlacarAoVivo(){
  const container = document.getElementById("placarAoVivoContainer");
  if (!container) return;
  container.innerHTML = "";
  const statusLabel = { "AGENDADO":"Agendado", "PRESTES":"Prestes a come√ßar", "EM_ANDAMENTO":"Em andamento", "FINALIZADO":"Finalizado" };
  const jogosAoVivo = todosJogos.filter(j => j.status === "EM_ANDAMENTO" || j.status === "PRESTES");
  if (!jogosAoVivo.length){ const p=document.createElement("p"); p.textContent = "Nenhum jogo em andamento ou prestes a come√ßar neste momento."; container.appendChild(p); return; }
  jogosAoVivo.sort((a,b) => ((a.dataJogo||"") + " " + (a.horarioJogo||"")).localeCompare((b.dataJogo||"") + " " + (b.horarioJogo||"")));
  jogosAoVivo.forEach(j => {
    const card = document.createElement("div"); card.className = "placar-card";
    const topo = document.createElement("div"); topo.className = "placar-linha-principal"; topo.textContent = (j.modalidade||"-") + " ‚Äî " + formatarDataBR(j.dataJogo) + " √†s " + (j.horarioJogo||"-"); card.appendChild(topo);
    const info = document.createElement("div"); info.innerHTML = "Local: "+(j.localJogo||"-")+"<br>"+(j.turma1||"")+" <strong>"+(j.placar1 ?? 0)+"</strong> x <strong>"+(j.placar2 ?? 0)+"</strong> "+(j.turma2||""); card.appendChild(info);
    const statusSpan = document.createElement("span"); statusSpan.className = "placar-status"; if (j.status === "EM_ANDAMENTO") statusSpan.classList.add("andamento"); if (j.status === "PRESTES") statusSpan.classList.add("prestes"); statusSpan.textContent = statusLabel[j.status] || j.status || "‚Äì"; card.appendChild(statusSpan);
    container.appendChild(card);
  });
}

function renderClassificacao(){
  const container = document.getElementById("classificacaoContainer");
  if (!container) return;
  container.innerHTML = "";
  if (!todosJogos.length){ container.textContent = "Nenhum jogo registrado ainda."; return; }
  const finalizados = todosJogos.filter(j => j.status === "FINALIZADO");
  if (!finalizados.length){ container.textContent = "Nenhum jogo finalizado ainda para mostrar classificados."; return; }
  finalizados.sort((a,b) => ((a.dataJogo||"") + " " + (a.horarioJogo||"")).localeCompare((b.dataJogo||"") + " " + (b.horarioJogo||"")));
  finalizados.forEach(j => {
    const card = document.createElement("div"); card.className = "jogo-bloco";
    const header = document.createElement("div"); header.style.fontWeight="600"; header.style.marginBottom="4px"; header.textContent = (j.modalidade||"-") + " ‚Äî " + formatarDataBR(j.dataJogo) + " √†s " + (j.horarioJogo||"-"); card.appendChild(header);
    const p1 = j.placar1 ?? 0; const p2 = j.placar2 ?? 0;
    let vencedor = null; if (p1>p2) vencedor="t1"; else if (p2>p1) vencedor="t2";
    function montarLinha(turma, placar, pos){
      const linha=document.createElement("div"); linha.className="linha-classificado";
      const bol=document.createElement("span"); bol.className="bolinha-resultado";
      if (!vencedor) bol.classList.add("bolinha-neutra"); else if ((vencedor==="t1"&&pos===1)||(vencedor==="t2"&&pos===2)) bol.classList.add("bolinha-verde"); else bol.classList.add("bolinha-vermelha");
      const nomeSpan=document.createElement("span"); nomeSpan.textContent=turma||"-"; nomeSpan.style.marginRight="6px";
      const placarSpan=document.createElement("strong"); placarSpan.textContent = placar;
      linha.appendChild(bol); linha.appendChild(nomeSpan); linha.appendChild(document.createTextNode(" ‚Äî ")); linha.appendChild(placarSpan);
      return linha;
    }
    card.appendChild(montarLinha(j.turma1,p1,1)); card.appendChild(montarLinha(j.turma2,p2,2));
    const info=document.createElement("div"); info.style.marginTop="4px";
    if (vencedor==="t1") info.textContent = "Classificado: " + (j.turma1||"-"); else if (vencedor==="t2") info.textContent = "Classificado: " + (j.turma2||"-"); else info.textContent = "Empate ‚Äì sem classificado definido.";
    card.appendChild(info); container.appendChild(card);
  });
}

/* ========== ADMIN JOGOS CONTROLS (cadastrar/excluir/atualizar) ========== */

async function cadastrarJogo(){
  if (!isAdmin){ alert("Apenas o administrador pode cadastrar jogos."); return; }
  const dataJogo = document.getElementById("jogoData").value;
  const turma1 = document.getElementById("jogoTurma1").value;
  const turma2 = document.getElementById("jogoTurma2").value;
  const modalidade = document.getElementById("jogoModalidade").value;
  const horario = document.getElementById("jogoHorario").value;
  const local = (document.getElementById("jogoLocal").value || "").trim();
  if (!dataJogo || !turma1 || !turma2 || !modalidade || !horario || !local){ alert("Preencha todos os campos do jogo."); return; }
  if (turma1 === turma2){ alert("Turma 1 e Turma 2 devem ser diferentes."); return; }
  try{
    await db.collection("jogos").add({
      dataJogo: dataJogo,
      turma1: turma1,
      turma2: turma2,
      modalidade: modalidade,
      horarioJogo: horario,
      localJogo: local,
      status: "AGENDADO",
      placar1: 0,
      placar2: 0,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Jogo cadastrado com sucesso.");
    document.getElementById("jogoData").value = "";
    document.getElementById("jogoTurma1").value = "";
    document.getElementById("jogoTurma2").value = "";
    document.getElementById("jogoModalidade").value = "";
    document.getElementById("jogoHorario").value = "";
    document.getElementById("jogoLocal").value = "";
  }catch(e){ console.error(e); alert("Erro ao cadastrar jogo."); }
}

function atualizarSelectExcluirJogo(){
  const sel = document.getElementById("selectExcluirJogo");
  if (!sel) return;
  const filtroInput = document.getElementById("filtroExcluirJogo");
  const termo = filtroInput ? (filtroInput.value || "").toLowerCase() : "";
  sel.innerHTML = '<option value="">Selecione um jogo...</option>';
  todosJogos.forEach(j => {
    const label = (j.modalidade || "")+" ‚Äî "+formatarDataBR(j.dataJogo)+" "+(j.horarioJogo || "")+" ‚Äî "+(j.turma1 || "")+" x "+(j.turma2 || "");
    if (termo && !label.toLowerCase().includes(termo)) return;
    const opt = document.createElement("option"); opt.value = j.id; opt.textContent = label; sel.appendChild(opt);
  });
}

async function excluirJogo(){
  if (!isAdmin){ alert("Apenas o administrador pode excluir jogos."); return; }
  const sel = document.getElementById("selectExcluirJogo");
  const id = sel.value; if (!id){ alert("Selecione um jogo."); return; }
  const jogo = todosJogos.find(j => j.id === id);
  const desc = jogo ? ((jogo.modalidade || "")+" ‚Äî "+formatarDataBR(jogo.dataJogo)+" "+(jogo.horarioJogo || "")+" ‚Äî "+(jogo.turma1 || "")+" x "+(jogo.turma2 || "")) : "";
  if (!confirm("Excluir o jogo: "+desc+" ?")) return;
  try{ await db.collection("jogos").doc(id).delete(); alert("Jogo exclu√≠do."); }catch(e){ console.error(e); alert("Erro ao excluir jogo."); }
}

function renderAdminJogos(){
  const container = document.getElementById("listaAdminJogos");
  if (!container) return;
  container.innerHTML = "";
  if (!todosJogos.length){ container.textContent = "Nenhum jogo cadastrado."; return; }
  const statusOptions = ["AGENDADO","PRESTES","EM_ANDAMENTO","FINALIZADO"];
  todosJogos.forEach(j => {
    const bloco = document.createElement("div"); bloco.className = "jogo-bloco";
    const linha1 = document.createElement("div"); linha1.innerHTML = "<strong>"+(j.modalidade||"-")+"</strong> ‚Äî "+formatarDataBR(j.dataJogo)+" √†s "+(j.horarioJogo||"-"); bloco.appendChild(linha1);
    const linha2 = document.createElement("div"); linha2.textContent = "Jogo: "+(j.turma1||"")+" x "+(j.turma2||"")+" ‚Äî Local: "+(j.localJogo||"-"); bloco.appendChild(linha2);
    const controles = document.createElement("div"); controles.style.marginTop="4px"; controles.style.display="flex"; controles.style.flexWrap="wrap"; controles.style.gap="6px"; controles.style.alignItems="center";
    const selStatus = document.createElement("select"); selStatus.dataset.id = j.id;
    statusOptions.forEach(st => { const opt=document.createElement("option"); opt.value=st; opt.textContent=st; if (j.status===st) opt.selected=true; selStatus.appendChild(opt); });
    const inpP1 = document.createElement("input"); inpP1.type="number"; inpP1.min="0"; inpP1.value=(j.placar1 ?? 0); inpP1.style.width="60px"; inpP1.dataset.id=j.id; inpP1.dataset.tipo="p1";
    const inpP2 = document.createElement("input"); inpP2.type="number"; inpP2.min="0"; inpP2.value=(j.placar2 ?? 0); inpP2.style.width="60px"; inpP2.dataset.id=j.id; inpP2.dataset.tipo="p2";
    const labelP1=document.createElement("span"); labelP1.textContent=(j.turma1||"T1")+":"; const labelP2=document.createElement("span"); labelP2.textContent=(j.turma2||"T2")+":"; 
    const btnSalvar=document.createElement("button"); btnSalvar.className="btn btn-primaria btnSalvarJogo"; btnSalvar.textContent="Salvar"; btnSalvar.dataset.id=j.id;
    controles.appendChild(document.createTextNode("Status:")); controles.appendChild(selStatus); controles.appendChild(labelP1); controles.appendChild(inpP1); controles.appendChild(labelP2); controles.appendChild(inpP2); controles.appendChild(btnSalvar);
    bloco.appendChild(controles); container.appendChild(bloco);
  });

  container.querySelectorAll(".btnSalvarJogo").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!isAdmin){ alert("Apenas o administrador pode atualizar jogos."); return; }
      const id = btn.dataset.id;
      const bloco = btn.closest(".jogo-bloco");
      const selStatus = bloco.querySelector("select");
      const inpP1 = bloco.querySelector('input[data-tipo="p1"]');
      const inpP2 = bloco.querySelector('input[data-tipo="p2"]');
      const novoStatus = selStatus.value;
      const placar1 = parseInt(inpP1.value,10) || 0;
      const placar2 = parseInt(inpP2.value,10) || 0;
      try{ await db.collection("jogos").doc(id).update({ status: novoStatus, placar1: placar1, placar2: placar2 }); alert("Jogo atualizado com sucesso."); }catch(e){ console.error(e); alert("Erro ao atualizar jogo."); }
    });
  });
}

/* ========== PROFESSORES ========== */

async function adicionarProfessorAcesso(){
  if (!isAdmin){ alert("Apenas o administrador pode cadastrar acessos de professores."); return; }
  const nome = (document.getElementById("profNomeCadastro").value || "").trim();
  const tipo = document.getElementById("profTipoCadastro").value || "Professor";
  const senha = (document.getElementById("profSenhaCadastro").value || "").trim();
  if (!nome || !senha){ alert("Preencha nome e senha."); return; }
  try{ await db.collection("professoresAcesso").add({ nome:nome, tipo:tipo, senha:senha }); alert("Acesso cadastrado com sucesso."); document.getElementById("profNomeCadastro").value=""; document.getElementById("profSenhaCadastro").value=""; document.getElementById("profTipoCadastro").value="Professor"; }catch(e){ console.error(e); alert("Erro ao cadastrar acesso."); }
}
async function excluirProfessorAcesso(id){ if (!isAdmin){ alert("Apenas o administrador pode excluir acessos."); return; } if (!confirm("Excluir este acesso de professor?")) return; try{ await db.collection("professoresAcesso").doc(id).delete(); alert("Acesso exclu√≠do."); }catch(e){ console.error(e); alert("Erro ao excluir acesso."); } }
function renderProfessoresAdmin(){ const tbody = document.getElementById("tabelaProfessoresAdmin"); if (!tbody) return; tbody.innerHTML=""; if (!todosProfessores.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=4; td.textContent="Nenhum acesso cadastrado."; tr.appendChild(td); tbody.appendChild(tr); return; } todosProfessores.forEach(p => { const tr=document.createElement("tr"); const tdNome=document.createElement("td"); const tdTipo=document.createElement("td"); const tdSenha=document.createElement("td"); const tdAcoes=document.createElement("td"); tdNome.textContent=p.nome||""; tdTipo.textContent=p.tipo||""; tdSenha.textContent=p.senha||""; const btn=document.createElement("button"); btn.className="btn btn-primaria"; btn.style.padding="3px 8px"; btn.textContent="Excluir"; btn.addEventListener("click",()=>excluirProfessorAcesso(p.id)); tdAcoes.appendChild(btn); tr.appendChild(tdNome); tr.appendChild(tdTipo); tr.appendChild(tdSenha); tr.appendChild(tdAcoes); tbody.appendChild(tr); }); }

/* ========== PAINEL PROFESSORES ========== */

function renderPainelProfessores(){
  const listaDiv = document.getElementById("profListaAlunos");
  const turnoSel = document.getElementById("profTurnoSelect");
  const turmaSel = document.getElementById("profTurmaSelect");
  const labelProf = document.getElementById("profUsuarioAtivo");
  if (!listaDiv || !turnoSel || !turmaSel) return;
  if (currentProfessor && labelProf) labelProf.textContent = currentProfessor.nome + " (" + currentProfessor.tipo + ")";
  const turno = turnoSel.value; const turma = turmaSel.value;
  listaDiv.innerHTML = "";
  if (!turno || !turma){ listaDiv.textContent = "Selecione turno e turma para ver os alunos inscritos."; return; }
  const lista = todasInscricoes.filter(ins => ins.turno === turno && ins.turma === turma);
  if (!lista.length){ listaDiv.textContent = "Nenhum inscrito nesta turma para estes filtros."; return; }
  lista.forEach(ins => {
    const bloqueios = Array.isArray(ins.naoAutorizadoPor) ? ins.naoAutorizadoPor : [];
    const jaIndicou = currentProfessor ? bloqueios.includes(currentProfessor.id) : false;
    const card = document.createElement("div"); card.className="jogo-bloco";
    const nome = document.createElement("div"); nome.innerHTML = "<strong>"+(ins.nome||"")+"</strong>"; card.appendChild(nome);
    const detalhe = document.createElement("div"); detalhe.style.fontSize="0.8rem"; detalhe.innerHTML = "Turma: "+(ins.turma||"-")+" ‚Äî Turno: "+(ins.turno||"-")+"<br>Modalidades: "+((ins.modalidades||[]).join(", ")||"-"); card.appendChild(detalhe);
    const info = document.createElement("div"); info.style.marginTop="4px"; info.style.fontSize="0.78rem"; info.textContent = "J√° indicado por "+bloqueios.length+" professor(es)."; card.appendChild(info);
    const btn = document.createElement("button"); btn.className="btn btn-primaria"; btn.style.marginTop="4px"; btn.textContent = jaIndicou ? "Voc√™ j√° indicou este aluno" : "Indicar que N√ÉO pode participar"; btn.disabled = jaIndicou; btn.addEventListener("click", ()=>indicarAlunoNaoParticipa(ins.id)); card.appendChild(btn);
    listaDiv.appendChild(card);
  });
}
function configurarSelectTurmaProfessor(){ const turnoSel=document.getElementById("profTurnoSelect"); const turmaSel=document.getElementById("profTurmaSelect"); if (!turnoSel || !turmaSel) return; const turno = turnoSel.value; turmaSel.innerHTML=""; const optDefault=document.createElement("option"); if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; turmaSel.appendChild(optDefault); } else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault); const turmasTurno=getTurmasPorTurno(turno); turmasTurno.forEach(t=>{ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; turmaSel.appendChild(opt); }); } }

async function indicarAlunoNaoParticipa(inscricaoId){
  if (!currentProfessor){ alert("Fa√ßa login como professor/coordenador/gestor para indicar alunos."); return; }
  if (!confirm("Confirmar indica√ß√£o de que este aluno N√ÉO pode participar?")) return;
  const ref = db.collection("inscricoes").doc(inscricaoId);
  try{
    await db.runTransaction(function(tx){
      return tx.get(ref).then(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        let lista = Array.isArray(data.naoAutorizadoPor) ? data.naoAutorizadoPor.slice() : [];
        if (!lista.includes(currentProfessor.id)) lista.push(currentProfessor.id);
        if (lista.length >= 2){ tx.delete(ref); } else { tx.update(ref, { naoAutorizadoPor: lista }); }
      });
    });
    alert("Indica√ß√£o registrada. Se mais um professor indicar este aluno, a inscri√ß√£o ser√° cancelada automaticamente.");
  }catch(e){ console.error(e); alert("Erro ao registrar indica√ß√£o."); }
}

/* ========== TROCA DE TELAS E ABRIR ADMIN ========== */

let currentRole = null;
let currentProfessor = null;

function mostrarSecao(sec){
  document.getElementById("secInscricao").style.display = (sec==="inscricao"?"block":"none");
  document.getElementById("secInscritos").style.display = (sec==="inscritos"?"block":"none");
  document.getElementById("secJogos").style.display = (sec==="jogos"?"block":"none");
  document.getElementById("secClassificados").style.display = (sec==="classificados"?"block":"none");
  document.getElementById("secPlacarAoVivo").style.display = (sec==="placar"?"block":"none");
  document.getElementById("adminSection").style.display = (sec==="admin"?"block":"none");
  document.getElementById("professoresSection").style.display = (sec==="professores"?"block":"none");
}

function abrirAdmin(){
  const opcao = prompt("Selecione o tipo de acesso:\n1 - Administrador\n2 - Professor\n3 - Coordenador\n4 - Gestor");
  if (opcao === null) return;
  let role = null;
  if (opcao === "1") role = "ADMIN";
  else if (opcao === "2") role = "Professor";
  else if (opcao === "3") role = "Coordenador";
  else if (opcao === "4") role = "Gestor";
  else { alert("Op√ß√£o inv√°lida."); return; }
  const senha = prompt("Digite a senha:");
  if (senha === null || senha === "") return;
  if (role === "ADMIN"){
    if (senha !== ADMIN_PASSWORD){ alert("Senha incorreta."); return; }
    isAdmin = true; currentRole = "ADMIN"; currentProfessor = null; mostrarSecao("admin"); renderAdmin(); renderAdminJogos(); renderCredenciaisList(); preencherCredSelects(); return;
  }
  const prof = todosProfessores.find(p => p.senha === senha && p.tipo === role);
  if (!prof){ alert("Senha incorreta ou acesso n√£o encontrado para este tipo."); return; }
  isAdmin = false; currentRole = role; currentProfessor = prof; mostrarSecao("professores"); renderPainelProfessores();
}

function fecharAdmin(){ mostrarSecao("inscricao"); currentRole=null; isAdmin=false; }
function fecharProfessores(){ mostrarSecao("inscricao"); currentRole=null; currentProfessor=null; }

/* abas admin */
function configurarAbasAdmin(){
  const botoes = document.querySelectorAll(".admin-tab-btn");
  botoes.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      botoes.forEach(b => b.classList.remove("ativo"));
      btn.classList.add("ativo");
      document.querySelectorAll(".admin-tab-content").forEach(c => c.classList.remove("ativo"));
      document.getElementById("tab-"+tab).classList.add("ativo");
      // when entering credentials tab, render up-to-date lists
      if (tab === "credenciais") { renderCredenciaisList(); preencherCredSelects(); preencherModalidadesSelectsCred(); atualizarListaJogosChamada(); }
    });
  });
}

/* ========== LISTENERS FIRESTORE (ON SNAPSHOT) ========== */

function iniciarListeners(){
  db.collection("professoresAcesso").onSnapshot(snap => {
    todosProfessores = [];
    snap.forEach(doc => {
      const d = doc.data();
      todosProfessores.push({ id: doc.id, nome: d.nome || "", tipo: d.tipo || "Professor", senha: d.senha || "" });
    });
    renderProfessoresAdmin();
  });

  db.collection("inscricoes").orderBy("timestamp","asc").onSnapshot(snap => {
    todasInscricoes = [];
    countsPorTurmaModalidade = {};
    countsQueimadaGenero = {};
    snap.forEach(doc => {
      const d = doc.data();
      const ins = {
        id: doc.id,
        nome: d.nome || "",
        nomeNormalizado: d.nomeNormalizado || normalizarNome(d.nome || ""),
        email: d.email || "",
        sexo: d.sexo || "",
        turno: d.turno || "",
        turma: d.turma || "",
        camisaNumero: d.camisaNumero || "",
        modalidades: d.modalidades || [],
        observacoes: d.observacoes || "",
        naoAutorizadoPor: d.naoAutorizadoPor || [],
        presencas: d.presencas || {},
        timestamp: d.timestamp
      };
      todasInscricoes.push(ins);

      if (!countsPorTurmaModalidade[ins.turma]) countsPorTurmaModalidade[ins.turma] = {};
      ins.modalidades.forEach(m => {
        if (!countsPorTurmaModalidade[ins.turma][m]) countsPorTurmaModalidade[ins.turma][m] = 0;
        countsPorTurmaModalidade[ins.turma][m]++;
        if (m === "QUEIMADA MISTA"){
          if (!countsQueimadaGenero[ins.turma]) countsQueimadaGenero[ins.turma] = {Masculino:0, Feminino:0};
          if (ins.sexo === "Masculino") countsQueimadaGenero[ins.turma].Masculino++;
          if (ins.sexo === "Feminino") countsQueimadaGenero[ins.turma].Feminino++;
        }
      });
    });
    atualizarDisponibilidadeModalidades();
    atualizarSelectsAdminPublico();
    renderPublico();
    renderAdmin();
    renderRelatorio();
    renderCredenciaisList();
    atualizarListaJogosChamada();
    if (currentRole && currentRole !== "ADMIN") renderPainelProfessores();
  });

  db.collection("jogos").orderBy("dataJogo","asc").onSnapshot(snap => {
    todosJogos = [];
    snap.forEach(doc => {
      const d = doc.data();
      let p1 = d.placar1; let p2 = d.placar2;
      if (typeof p1 === "string") p1 = parseInt(p1,10);
      if (typeof p2 === "string") p2 = parseInt(p2,10);
      todosJogos.push({
        id: doc.id,
        turno: d.turno || "",
        serie: d.serie || "",
        turma1: d.turma1 || "",
        turma2: d.turma2 || "",
        dataJogo: d.dataJogo || "",
        modalidade: d.modalidade || "",
        horarioJogo: d.horarioJogo || "",
        localJogo: d.localJogo || "",
        status: d.status || "AGENDADO",
        placar1: Number.isFinite(p1) ? p1 : 0,
        placar2: Number.isFinite(p2) ? p2 : 0
      });
    });
    atualizarSelectExcluirJogo();
    renderJogosAluno();
    renderPlacarAoVivo();
    renderClassificacao();
    renderAdminJogos();
    preencherSelectsJogos(); // atualiza selects de jogos no admin (CHAMADA)
  });
}

/* ========== INIT / DOM / UI SETUP ========== */

function init(){
  try { const saved = localStorage.getItem('insc_email'); if (saved && saved.includes('@')){ emailAtual = saved; const ov = document.getElementById('emailOverlay'); if (ov) ov.style.display = 'none'; } } catch(e) {}
  const overlay = document.getElementById("emailOverlay");
  const emailInput = document.getElementById("emailAluno");
  const msgEmail = document.getElementById("msgEmailOverlay");

  function liberarEmail(){
    const val = (emailInput.value || '').trim();
    if (!validarEmail(val)){ msgEmail.textContent = "Digite um e-mail v√°lido."; return; }
    emailAtual = val;
    try { localStorage.setItem('insc_email', val); } catch(e){}
    try { window._inscricao_email_fallback = val; } catch(e){}
    if (overlay) overlay.style.display = "none";
  }
  const btnEntrar = document.getElementById("btnEntrarEmail");
  if (btnEntrar) btnEntrar.addEventListener("click", liberarEmail);
  if (emailInput) emailInput.addEventListener("keydown", e => { if (e.key === "Enter"){ e.preventDefault(); liberarEmail(); } });

  const contMods = document.getElementById("modalidadesContainer");
  MODALIDADES.forEach(m => {
    const item=document.createElement("div"); item.className="modalidade-item";
    const chk=document.createElement("input"); chk.type="checkbox"; chk.className="chkModalidade"; chk.value=m;
    const info=document.createElement("div");
    const lbl=document.createElement("span"); lbl.className="modalidade-label"; lbl.textContent = m;
    const vagas=document.createElement("span"); vagas.className="modalidade-vagas"; vagas.dataset.mod = m; vagas.textContent = "Selecione turno e turma para ver vagas.";
    info.appendChild(lbl); info.appendChild(vagas);
    item.appendChild(chk); item.appendChild(info);
    contMods.appendChild(item);
  });

  contMods.addEventListener("change", e => {
    if (e.target.classList.contains("chkModalidade")){
      const marcados = contMods.querySelectorAll(".chkModalidade:checked");
      if (marcados.length > LIMITE_MODALIDADES_POR_ALUNO){ e.target.checked = false; alert("M√°ximo de "+LIMITE_MODALIDADES_POR_ALUNO+" modalidades por aluno."); }
    }
  });

  const turnoSel = document.getElementById("turno");
  const turmaSel = document.getElementById("turma");
  if (turmaSel) turmaSel.disabled = true;
  turnoSel.addEventListener("change", () => {
    const turno = turnoSel.value;
    turmaSel.innerHTML = "";
    if (!turno){ turmaSel.disabled = true; turmaSel.innerHTML = '<option value="">Selecione o turno primeiro...</option>'; }
    else {
      turmaSel.disabled = false;
      const turmasTurno = getTurmasPorTurno(turno);
      const optDefault = document.createElement("option"); optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault);
      turmasTurno.forEach(t => { const opt=document.createElement("option"); opt.value=t; opt.textContent=t; turmaSel.appendChild(opt); });
    }
    atualizarDisponibilidadeModalidades();
  });
  turmaSel.addEventListener("change", atualizarDisponibilidadeModalidades);
  document.getElementById("sexo").addEventListener("change", atualizarDisponibilidadeModalidades);

  const filtroTurno = document.getElementById("filtroTurno");
  const filtroTurma = document.getElementById("filtroTurma");
  const filtroModalidade = document.getElementById("filtroModalidade");
  filtroTurma.innerHTML = '<option value="">Selecione o turno primeiro...</option>';
  filtroModalidade.innerHTML = '<option value="">Selecione a modalidade...</option>';
  filtroTurno.addEventListener("change", () => {
    const turno = filtroTurno.value; filtroTurma.innerHTML="";
    const optDefault=document.createElement("option");
    if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; filtroTurma.appendChild(optDefault); }
    else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; filtroTurma.appendChild(optDefault); const turmasTurno=getTurmasPorTurno(turno); turmasTurno.forEach(t=>{ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; filtroTurma.appendChild(opt); }); }
    renderPublico();
  });
  filtroTurma.addEventListener("change", renderPublico);
  filtroModalidade.addEventListener("change", renderPublico);

  // jogos selects
  const jogoTurma1 = document.getElementById("jogoTurma1");
  const jogoTurma2 = document.getElementById("jogoTurma2");
  if (jogoTurma1 && jogoTurma2){
    jogoTurma1.innerHTML = '<option value="">Selecione a turma 1...</option>';
    jogoTurma2.innerHTML = '<option value="">Selecione a turma 2...</option>';
    TODAS_TURMAS.forEach(t => {
      const o1=document.createElement("option"); o1.value=t; o1.textContent=t; jogoTurma1.appendChild(o1);
      const o2=document.createElement("option"); o2.value=t; o2.textContent=t; jogoTurma2.appendChild(o2);
    });
  }
  const jogoModalidade = document.getElementById("jogoModalidade");
  MODALIDADES.forEach(m => { const opt=document.createElement("option"); opt.value=m; opt.textContent=m; if (jogoModalidade) jogoModalidade.appendChild(opt); });

  // relatorio selects
  const relatorioTurno = document.getElementById("relatorioTurno");
  const relatorioTurma = document.getElementById("relatorioTurma");
  const relatorioModalidade = document.getElementById("relatorioModalidade");
  if (relatorioModalidade){ relatorioModalidade.innerHTML = '<option value="">Selecione a modalidade...</option>'; MODALIDADES.forEach(m => { const opt=document.createElement("option"); opt.value=m; opt.textContent=m; relatorioModalidade.appendChild(opt); }); }
  if (relatorioTurno && relatorioTurma){
    relatorioTurno.addEventListener("change", () => {
      const turno = relatorioTurno.value; relatorioTurma.innerHTML = ""; const optDefault=document.createElement("option");
      if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; relatorioTurma.appendChild(optDefault); }
      else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; relatorioTurma.appendChild(optDefault); const turmasTurno=getTurmasPorTurno(turno); turmasTurno.forEach(t=>{ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; relatorioTurma.appendChild(opt); }); }
      renderRelatorio();
    });
    relatorioTurma.addEventListener("change", renderRelatorio);
  }
  if (relatorioModalidade) relatorioModalidade.addEventListener("change", renderRelatorio);

  // print buttons
  const btnImprimirRelatorio = document.getElementById("btnImprimirRelatorio");
  if (btnImprimirRelatorio) btnImprimirRelatorio.addEventListener("click", () => { renderRelatorio(); window.print(); });
  const btnImprimirTodaTurma = document.getElementById("btnImprimirTodaTurma");
  if (btnImprimirTodaTurma) btnImprimirTodaTurma.addEventListener("click", () => { renderRelatorioTodaTurma(); window.print(); });

  // toggle panels
  document.getElementById("btnToggleInscritos").addEventListener("click", () => {
    const sec = document.getElementById("secInscritos").style.display === "block";
    const btn = document.getElementById("btnToggleInscritos");
    if (sec){ mostrarSecao("inscricao"); btn.textContent = "üëÄ Ver inscritos"; } else { mostrarSecao("inscritos"); btn.textContent = "‚¨Ö Voltar para inscri√ß√£o"; }
  });
  document.getElementById("btnVerJogos").addEventListener("click", () => {
    const sec = document.getElementById("secJogos").style.display === "block";
    const btn = document.getElementById("btnVerJogos");
    if (sec){ mostrarSecao("inscricao"); btn.textContent = "üèÜ Ver jogos"; } else { mostrarSecao("jogos"); btn.textContent = "‚¨Ö Voltar para inscri√ß√£o"; }
  });
  document.getElementById("btnClassificados").addEventListener("click", () => {
    const sec = document.getElementById("secClassificados").style.display === "block";
    const btn = document.getElementById("btnClassificados");
    if (sec){ mostrarSecao("inscricao"); btn.textContent = "‚úÖ Classificados"; } else { mostrarSecao("classificados"); btn.textContent = "‚¨Ö Voltar para inscri√ß√£o"; }
  });
  document.getElementById("btnPlacarAoVivo").addEventListener("click", () => {
    const sec = document.getElementById("secPlacarAoVivo").style.display === "block";
    const btn = document.getElementById("btnPlacarAoVivo");
    if (sec){ mostrarSecao("inscricao"); btn.textContent = "‚ö° Placar ao vivo"; } else { mostrarSecao("placar"); btn.textContent = "‚¨Ö Voltar para inscri√ß√£o"; }
  });

  document.getElementById("btnAdminArea").addEventListener("click", abrirAdmin);
  document.getElementById("btnFecharAdmin").addEventListener("click", fecharAdmin);
  document.getElementById("btnFecharProfessores").addEventListener("click", fecharProfessores);

  document.getElementById("formInscricao").addEventListener("submit", handleSubmitInscricao);

  document.getElementById("adminFiltroNome").addEventListener("input", () => { renderAdmin(); atualizarSelectsAdminPublico(); });
  document.getElementById("adminFiltroTurma").addEventListener("change", () => { renderAdmin(); atualizarSelectsAdminPublico(); });
  document.getElementById("adminFiltroModalidade").addEventListener("change", renderAdmin);
  document.getElementById("btnCancelarInscricao").addEventListener("click", cancelarInscricao);

  // filtro modalidades para jogos (aluno)
  const filtroModalidadeJogo = document.getElementById("filtroModalidadeJogo");
  if (filtroModalidadeJogo){
    filtroModalidadeJogo.innerHTML = '<option value="">Selecione...</option>';
    MODALIDADES.forEach(m => { const opt=document.createElement("option"); opt.value=m; opt.textContent=m; filtroModalidadeJogo.appendChild(opt); });
    filtroModalidadeJogo.addEventListener("change", renderJogosAluno);
  }
  document.getElementById("filtroSerieJogo").addEventListener("change", renderJogosAluno);
  document.getElementById("filtroDataJogo").addEventListener("change", renderJogosAluno);

  document.getElementById("filtroExcluirJogo").addEventListener("input", atualizarSelectExcluirJogo);
  document.getElementById("btnCadastrarJogo").addEventListener("click", cadastrarJogo);
  document.getElementById("btnExcluirJogo").addEventListener("click", excluirJogo);
  document.getElementById("btnSalvarConfig").addEventListener("click", e => { e.preventDefault(); salvarConfiguracoes(); });

  // Bot√£o adicionar professor
  document.getElementById("btnAdicionarProfessor").addEventListener("click", e => { e.preventDefault(); adicionarProfessorAcesso(); });

  const btnGerarSenha = document.getElementById("btnGerarSenhaProfessor");
  if (btnGerarSenha) btnGerarSenha.addEventListener("click", e => { e.preventDefault(); let senha=""; for(let i=0;i<5;i++) senha += Math.floor(Math.random()*10); document.getElementById("profSenhaCadastro").value = senha; });

  const profTurnoSelect = document.getElementById("profTurnoSelect");
  const profTurmaSelect = document.getElementById("profTurmaSelect");
  if (profTurnoSelect && profTurmaSelect){
    profTurnoSelect.addEventListener("change", () => { configurarSelectTurmaProfessor(); renderPainelProfessores(); });
    profTurmaSelect.addEventListener("change", renderPainelProfessores);
  }

  configurarAbasAdmin();
  iniciarListeners();
  carregarConfiguracoes();

  mostrarSecao("inscricao");

  // scanner UI buttons
  document.getElementById("btnAbrirScanner").addEventListener("click", abrirScannerValidacao);
  document.getElementById("btnAbrirScannerChamada").addEventListener("click", abrirScannerChamada);
  document.getElementById("btnFecharScanner").addEventListener("click", fecharScannerOverlay);

  // chamada list controls
  document.getElementById("chamadaFiltroTurno").addEventListener("change", atualizarChamadaTurmas);
  document.getElementById("chamadaFiltroTurma").addEventListener("change", atualizarListaJogosChamada);
  document.getElementById("chamadaFiltroModalidade").addEventListener("change", atualizarListaJogosChamada);
  document.getElementById("btnGerarListaChamada").addEventListener("click", gerarListaChamada);

  // credenciais filters
  document.getElementById("credFiltroTurno").addEventListener("change", () => { preencherCredSelects(); renderCredenciaisList(); });
  document.getElementById("credFiltroTurma").addEventListener("change", () => { renderCredenciaisList(); });
  document.getElementById("credFiltroModalidade").addEventListener("change", () => { renderCredenciaisList(); });

  // atualizar selects padr√µes de turmas nos filtros administrativos (credenciais e chamada)
  const filtersToInit = ["credFiltroTurno","chamadaFiltroTurno"];
  filtersToInit.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("change", () => {
        const turno = el.value;
        const pair = (id==="credFiltroTurno") ? "credFiltroTurma" : "chamadaFiltroTurma";
        const selectTurma = document.getElementById(pair);
        if (!selectTurma) return;
        selectTurma.innerHTML = "";
        const optDefault = document.createElement("option");
        if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; selectTurma.appendChild(optDefault); }
        else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; selectTurma.appendChild(optDefault); const turmasTurno=getTurmasPorTurno(turno); turmasTurno.forEach(t=>{ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; selectTurma.appendChild(opt); }); }
      });
    }
  });
}

/* ========== CREDENCIAIS: LISTAGEM, IMPRIMIR CRAch√° (gera QR), ESCANEADOR & CHAMADA ========== */

/* Render lista de credenciais no admin (individual) */
function renderCredenciaisList(){
  const container = document.getElementById("credListContainer");
  if (!container) return;
  container.innerHTML = "";

  const turno = document.getElementById("credFiltroTurno").value;
  const turma = document.getElementById("credFiltroTurma").value;
  const modalidade = document.getElementById("credFiltroModalidade").value;

  // filter inscritos
  let lista = todasInscricoes.slice();
  if (turno) lista = lista.filter(i => i.turno === turno);
  if (turma) lista = lista.filter(i => i.turma === turma);
  if (modalidade) lista = lista.filter(i => i.modalidades && i.modalidades.includes(modalidade));

  if (!lista.length){
    const p = document.createElement("div"); p.style.marginTop="6px"; p.textContent = "Nenhuma inscri√ß√£o para esses filtros."; container.appendChild(p); return;
  }

  lista.forEach(ins => {
    const row = document.createElement("div"); row.className = "cred-card";
    const left = document.createElement("div");
    const name = document.createElement("div"); name.style.fontWeight="700"; name.textContent = ins.nome || "";
    const meta = document.createElement("div"); meta.style.fontSize="0.85rem"; meta.textContent = (ins.turno||"") + " ‚Ä¢ " + (ins.turma||"") + " ‚Ä¢ " + ((ins.modalidades||[]).join(", ")||"-");
    const idline = document.createElement("div"); idline.style.fontSize="0.78rem"; idline.style.color="#666"; idline.textContent = "ID: " + ins.id;
    left.appendChild(name); left.appendChild(meta); left.appendChild(idline);

    const actions = document.createElement("div"); actions.style.display="flex"; actions.style.gap="8px"; actions.style.alignItems="center";
    const btnPrint = document.createElement("button"); btnPrint.className="btn btn-primaria"; btnPrint.textContent = "Imprimir Credenciais";
    btnPrint.addEventListener("click", () => imprimirCracha(ins));
    actions.appendChild(btnPrint);

    // badge preview small
    const badge = document.createElement("div"); badge.className="badge-preview"; badge.innerHTML = `<strong>${ins.nome}</strong><br>${ins.turma} ‚Ä¢ ${ins.turno}`;
    actions.appendChild(badge);

    row.appendChild(left); row.appendChild(actions);
    container.appendChild(row);
  });
}

/* gerar crach√° em nova janela (inclui QR code) e chama print */
async function imprimirCracha(inscricao){
  try{
    // gera dataURL do QR com payload simples: id
    const qrData = String(inscricao.id);
    const dataUrl = await QRCode.toDataURL(qrData, { margin:1, width:260 });
    // const dataUrlSmall = await QRCode.toDataURL(qrData, { margin:1, width:160 });
    const nome = inscricao.nome || "";
    const turno = inscricao.turno || "";
    const turma = inscricao.turma || "";
    const modalidades = (inscricao.modalidades || []).join(", ");
    const id = inscricao.id;

    const w = window.open("", "_blank", "width=520,height=640");
    if (!w) { alert("Bloqueador de popups impediu abrir a janela de impress√£o. Permita popups e tente novamente."); return; }

    const html = `
      <!doctype html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Cracha - ${nome}</title>
        <style>
          @media print { @page { margin: 8mm; } body { margin:0; } }
          body { font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; padding:12px; }
          .cracha { width:300px; height:180px; border:1px solid #ccc; border-radius:8px; padding:10px; box-sizing:border-box; display:flex; gap:8px; align-items:center; }
          .info { flex:1; }
          .info .nome { font-size:18px; font-weight:700; color:#003366; margin-bottom:6px; }
          .info .meta { font-size:12px; color:#333; margin-bottom:6px; }
          .qr { width:120px; height:120px; display:flex; align-items:center; justify-content:center; }
          .small { font-size:11px; color:#555; margin-top:8px; }
        </style>
      </head>
      <body>
        <div style="display:flex; justify-content:center;">
          <div class="cracha">
            <div class="info">
              <div class="nome">${nome}</div>
              <div class="meta">Turma: ${turma}</div>
              <div class="meta">Turno: ${turno}</div>
              <div class="meta">Modalidade(s): ${modalidades}</div>
              <div class="small">ID: ${id}</div>
            </div>
            <div class="qr">
              <img src="${dataUrl}" width="120" height="120" alt="QR">
            </div>
          </div>
        </div>
        <script>
          setTimeout(()=>{ window.print(); }, 500);
        </script>
      </body>
      </html>
    `;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }catch(e){ console.error(e); alert("Erro ao gerar crach√°."); }
}

/* ========== SCANNER: abrir / fechar / tratamento de detectado ========== */

function abrirScannerValidacao(){
  const senha = document.getElementById("scannerSenha").value || "";
  if (senha !== ADMIN_PASSWORD){ alert("Senha incorreta."); return; }
  scanningMode = "VALIDACAO";
  chamadaGameSelected = ""; chamadaGameContext = null;
  abrirScannerOverlay();
}

function abrirScannerChamada(){
  const senha = document.getElementById("scannerSenha").value || "";
  if (senha !== ADMIN_PASSWORD){ alert("Senha incorreta."); return; }
  scanningMode = "CHAMADA";
  // use selected game in CHAMADA, if any
  chamadaGameSelected = document.getElementById("selectJogoChamada").value || "";
  chamadaGameContext = todosJogos.find(j => j.id === chamadaGameSelected) || null;
  abrirScannerOverlay();
}

function abrirScannerOverlay(){
  const overlay = document.getElementById("scannerOverlay");
  overlay.style.display = "flex";
  startHtml5QrScanner();
}

function fecharScannerOverlay(){
  stopHtml5QrScanner();
  const overlay = document.getElementById("scannerOverlay");
  overlay.style.display = "none";
  document.getElementById("scannerResult").style.display = "none";
}

/* Start scanner using html5-qrcode */
function startHtml5QrScanner(){
  const regionId = "html5qr-inline-full-region";
  if (html5QrScannerInstance){
    try { html5QrScannerInstance.start({ facingMode: "environment" }, {}, qrSuccessCallback, qrErrorCallback); return; } catch(e) { /* ignore */ }
  }
  // create instance
  html5QrScannerInstance = new Html5Qrcode(regionId);
  // try to start camera
  Html5Qrcode.getCameras().then(cameras => {
    let camId = (cameras && cameras.length) ? cameras[0].id : null;
    // choose back camera if available
    for (const c of cameras){ if (c.label && /back|rear|environment|traseira/i.test(c.label)){ camId = c.id; break; } }
    html5QrScannerInstance.start(camId ? { deviceId: { exact: camId } } : { facingMode: "environment" }, { fps: 10, qrbox: 250 }, qrSuccessCallback, qrErrorCallback)
    .catch(err => {
      console.error("N√£o foi poss√≠vel iniciar a c√¢mera:", err);
      alert("Erro ao acessar a c√¢mera. Verifique permiss√µes.");
    });
  }).catch(err => {
    console.error("Erro ao listar c√¢meras:", err);
    alert("Nenhuma c√¢mera dispon√≠vel.");
  });
}

function stopHtml5QrScanner(){
  if (html5QrScannerInstance){
    html5QrScannerInstance.stop().then(() => {
      // cleared
    }).catch(e => { /* ignore */ });
    // optional: clear UI
    try { html5QrScannerInstance.clear(); } catch(e) {}
    html5QrScannerInstance = null;
  }
}

/* callbacks for qr scanning */
let lastScanned = null;
function qrSuccessCallback(decodedText, decodedResult){
  if (!decodedText) return;
  // avoid duplicate multiple detections in short time
  const now = Date.now();
  if (lastScanned && (now - lastScanned) < 900) return;
  lastScanned = now;
  handleScannedId(decodedText);
}
function qrErrorCallback(err){
  // ignore noisy errors
}

/* handle scanned qr payload (we expect the inscription id) */
async function handleScannedId(payload){
  const id = String(payload).trim();
  const resultPanel = document.getElementById("scannerResult");
  resultPanel.style.display = "none";
  // find inscription
  const ins = todasInscricoes.find(i => i.id === id);
  if (!ins){
    // show invalid
    resultPanel.className = "invalid";
    resultPanel.innerHTML = `<div style="flex:1;"><strong>Inscri√ß√£o inv√°lida</strong><br>ID: ${id}</div>`;
    resultPanel.style.display = "flex";
    // after short delay, hide and continue scanning
    setTimeout(()=>{ resultPanel.style.display="none"; }, 1400);
    return;
  }

  // determine game to mark presence: If scanningMode === "CHAMADA" and chamadaGameSelected set -> use it.
  // Else if scanningMode === "CHAMADA" and no selected -> try to guess based on jogos
  // If scanningMode === "VALIDACAO" -> try auto-find a relevant game (today + modalidade in inscricao and turma match)
  let targetGame = null;
  if (scanningMode === "CHAMADA" && chamadaGameSelected){
    targetGame = todosJogos.find(j => j.id === chamadaGameSelected) || null;
  } else {
    // try to auto-detect: look for jogos where (dataJogo === hoje OR status PRESTES/EM_ANDAMENTO) and modalidade in inscricao.modalidades and inscricao.turma === turma1 or turma2
    const hoje = new Date(); const yyyy = hoje.getFullYear(); const mm = String(hoje.getMonth()+1).padStart(2,"0"); const dd = String(hoje.getDate()).padStart(2,"0");
    const hojeStr = `${yyyy}-${mm}-${dd}`;
    // priority: EM_ANDAMENTO > PRESTES > AGENDADO (today)
    const ordering = { "EM_ANDAMENTO":1, "PRESTES":2, "AGENDADO":3, "FINALIZADO":4 };
    const possiveis = todosJogos.filter(j => {
      if (!(ins.modalidades || []).includes(j.modalidade)) return false;
      if (!(j.turma1 === ins.turma || j.turma2 === ins.turma)) return false;
      // prefer today / in progress
      if (j.dataJogo === hojeStr) return true;
      // also include EM_ANDAMENTO or PRESTES even if date differs
      if (j.status === "EM_ANDAMENTO" || j.status === "PRESTES") return true;
      return false;
    });
    possiveis.sort((a,b) => (ordering[a.status]||99) - (ordering[b.status]||99));
    targetGame = possiveis.length ? possiveis[0] : null;
  }

  // prepare UI preview of crach√° digital e persisting a presenca por jogo
  const content = document.createElement("div");
  content.style.display = "flex";
  content.style.gap = "10px";
  content.style.alignItems = "center";

  const info = document.createElement("div");
  info.innerHTML = `<div style="font-weight:700; font-size:1rem;">${ins.nome}</div>
    <div style="font-size:0.9rem;">${ins.turma} ‚Ä¢ ${ins.turno}</div>
    <div style="font-size:0.85rem; margin-top:6px;">Modalidades: ${(ins.modalidades||[]).join(", ")}</div>
    <div style="font-size:0.8rem; color:#555; margin-top:6px;">ID: ${ins.id}</div>`;

  // QR small preview
  const img = document.createElement("img"); img.width = 80; img.height = 80;
  try { img.src = await QRCode.toDataURL(ins.id, { width:160, margin:1 }); } catch(e){ img.alt = ""; }

  content.appendChild(img); content.appendChild(info);

  resultPanel.className = "valid";
  resultPanel.innerHTML = "";
  resultPanel.appendChild(content);

  // Save presence if we found a game
  if (targetGame){
    const gameId = targetGame.id;
    try{
      // update inscription doc: presencas.gameId = { present: true, timestamp: serverTimestamp() }
      const updateObj = {};
      updateObj[`presencas.${gameId}`] = { present: true, timestamp: firebase.firestore.FieldValue.serverTimestamp(), jogoId: gameId, jogoModalidade: targetGame.modalidade };
      await db.collection("inscricoes").doc(ins.id).update(updateObj);

      // also optionally record a "registro de chamada" em cole√ß√£o separada (opcional)
      await db.collection("presencas_por_jogo").add({
        inscricaoId: ins.id,
        jogoId: gameId,
        nome: ins.nome,
        turma: ins.turma,
        turno: ins.turno,
        modalidade: targetGame.modalidade,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // show feedback com "VALIDADO" e jogo
      const info2 = document.createElement("div");
      info2.style.marginLeft = "8px";
      info2.innerHTML = `<div style="font-weight:700; color:var(--verde);">VALIDADO ‚úÖ</div>
        <div style="font-size:0.9rem;">Jogo: ${targetGame.turma1} x ${targetGame.turma2} ‚Äî ${targetGame.modalidade}</div>
        <div style="font-size:0.8rem; color:#555;">Data: ${formatarDataBR(targetGame.dataJogo)} ${targetGame.horarioJogo ? "‚Ä¢ "+targetGame.horarioJogo : ""}</div>`;
      // append info2
      resultPanel.appendChild(info2);
    }catch(e){
      console.error(e);
      // show partial success
      const errDiv = document.createElement("div"); errDiv.style.color="red"; errDiv.style.marginLeft="8px"; errDiv.textContent = "Erro ao registrar presen√ßa.";
      resultPanel.appendChild(errDiv);
    }
  } else {
    // no game found -> present but not marked in a game
    const info2 = document.createElement("div");
    info2.style.marginLeft = "8px";
    info2.innerHTML = `<div style="font-weight:700; color:var(--verde);">VALIDADO (SEM JOGO)</div>
      <div style="font-size:0.9rem;">Nenhum jogo detectado para marcar presen√ßa automaticamente.</div>`;
    resultPanel.appendChild(info2);
  }

  resultPanel.style.display = "flex";

  // After short delay auto-hide and continue scanning
  setTimeout(() => {
    resultPanel.style.display = "none";
    // continue scanning (html5-qrcode continues automatically)
  }, 1400);
}

/* ========== CHAMADA: gerar lista de alunos para um jogo selecionado ========== */

function preencherSelectsJogos(){
  // fill selectJogoChamada with upcoming games (ordered)
  const sel = document.getElementById("selectJogoChamada");
  if (!sel) return;
  sel.innerHTML = '<option value="">Escolha um jogo...</option>';
  todosJogos.forEach(j => {
    const label = `${j.modalidade} ‚Äî ${formatarDataBR(j.dataJogo)} ${j.horarioJogo || ""} ‚Äî ${j.turma1} x ${j.turma2}`;
    const opt = document.createElement("option"); opt.value = j.id; opt.textContent = label; sel.appendChild(opt);
  });
}

function atualizarChamadaTurmas(){
  const turno = document.getElementById("chamadaFiltroTurno").value;
  const turmaSel = document.getElementById("chamadaFiltroTurma");
  turmaSel.innerHTML = "";
  const optDefault = document.createElement("option");
  if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; turmaSel.appendChild(optDefault); }
  else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault); const turmas=getTurmasPorTurno(turno); turmas.forEach(t => { const opt=document.createElement("option"); opt.value=t; opt.textContent=t; turmaSel.appendChild(opt); }); }
  atualizarListaJogosChamada();
}

function atualizarListaJogosChamada(){
  const turno = document.getElementById("chamadaFiltroTurno").value;
  const turma = document.getElementById("chamadaFiltroTurma").value;
  const modalidade = document.getElementById("chamadaFiltroModalidade").value;
  const sel = document.getElementById("selectJogoChamada");
  if (!sel) return;
  sel.innerHTML = '<option value="">Escolha um jogo...</option>';
  let lista = todosJogos.slice();
  if (modalidade) lista = lista.filter(j => j.modalidade === modalidade);
  if (turma) lista = lista.filter(j => j.turma1 === turma || j.turma2 === turma);
  if (turno){ /* no direct field, but we can filter by turmas of the turno */ const turmasTurno = getTurmasPorTurno(turno); lista = lista.filter(j => turmasTurno.includes(j.turma1) || turmasTurno.includes(j.turma2)); }
  lista.forEach(j => {
    const opt = document.createElement("option");
    opt.value = j.id;
    opt.textContent = `${j.modalidade} ‚Äî ${formatarDataBR(j.dataJogo)} ${j.horarioJogo || ""} ‚Äî ${j.turma1} x ${j.turma2}`;
    sel.appendChild(opt);
  });
}

/* gerar lista de chamada por jogo; se jogo vazio, gere por filtros (turma+modalidade) */
function gerarListaChamada(){
  const jogoId = document.getElementById("selectJogoChamada").value;
  const container = document.getElementById("chamadaList");
  container.innerHTML = "";
  let lista = [];
  if (jogoId){
    const jogo = todosJogos.find(j => j.id === jogoId);
    if (!jogo){ container.textContent = "Jogo inv√°lido."; return; }
    lista = todasInscricoes.filter(ins => ins.modalidades && ins.modalidades.includes(jogo.modalidade) && (ins.turma === jogo.turma1 || ins.turma === jogo.turma2));
  } else {
    const turno = document.getElementById("chamadaFiltroTurno").value;
    const turma = document.getElementById("chamadaFiltroTurma").value;
    const modalidade = document.getElementById("chamadaFiltroModalidade").value;
    lista = todasInscricoes.slice();
    if (turno) lista = lista.filter(i => i.turno === turno);
    if (turma) lista = lista.filter(i => i.turma === turma);
    if (modalidade) lista = lista.filter(i => i.modalidades && i.modalidades.includes(modalidade));
  }
  // order by name
  lista = lista.slice().sort((a,b) => (a.nome||"").localeCompare(b.nome||"","pt-BR"));

  if (!lista.length){ container.textContent = "Nenhum inscrito para os filtros/jogo."; return; }
  lista.forEach(ins => {
    const item = document.createElement("div"); item.className = "chamada-item";
    const left = document.createElement("div"); left.innerHTML = `<div style="font-weight:700">${ins.nome}</div><div style="font-size:0.85rem">${ins.turma} ‚Ä¢ ${ins.turno}</div>`;
    const right = document.createElement("div");
    // presen√ßa por jogoId if selected, else show if any presence for matching games
    let present = false;
    if (jogoId){
      present = !!(ins.presencas && ins.presencas[jogoId] && ins.presencas[jogoId].present);
    } else {
      // if any presenca object exists for that turma's games filtered by modalidade(s)
      present = false;
      if (ins.presencas){
        const keys = Object.keys(ins.presencas || {});
        if (keys.length){
          // check if any presencas correspond to jogos where jogador's turma played
          for (const gId of keys){
            const j = todosJogos.find(jg => jg.id === gId);
            if (!j) continue;
            if (ins.turma === j.turma1 || ins.turma === j.turma2) { present = true; break; }
          }
        }
      }
    }
    right.innerHTML = `<div class="${present ? 'presente' : 'ausente'}">${present ? 'PRESENTE' : 'AUSENTE'}</div>`;
    item.appendChild(left); item.appendChild(right); container.appendChild(item);
  });
}

/* Helper to fill modalidade selects in credentials area */
function preencherModalidadesSelectsCred(){
  const sel = document.getElementById("credFiltroModalidade");
  if (!sel) return;
  sel.innerHTML = '<option value="">Todas</option>';
  MODALIDADES.forEach(m => { const opt=document.createElement("option"); opt.value=m; opt.textContent=m; sel.appendChild(opt); });
}

/* fill turma select in credentials area */
function preencherCredSelects(){
  const turno = document.getElementById("credFiltroTurno").value;
  const turmaSel = document.getElementById("credFiltroTurma");
  if (!turmaSel) return;
  turmaSel.innerHTML = "";
  const optDefault = document.createElement("option");
  if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; turmaSel.appendChild(optDefault); }
  else { optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault); getTurmasPorTurno(turno).forEach(t => { const opt=document.createElement("option"); opt.value=t; opt.textContent=t; turmaSel.appendChild(opt); }); }
}

/* ========== preencher selects globais de modalidades e turmas para admin/credenciais ========== */
function preencherCredenciaisAuxiliares(){
  // relatorioModalidade etc already filled earlier
  preencherModalidadesSelectsCred();
  preencherSelectsJogos();
  preencherCredSelects();
  // chamada area modalidade select:
  const selCh = document.getElementById("chamadaFiltroModalidade");
  if (selCh){ selCh.innerHTML = '<option value="">Todas</option>'; MODALIDADES.forEach(m => { const opt = document.createElement("option"); opt.value = m; opt.textContent = m; selCh.appendChild(opt); }); }
}

/* ========== preencher select de jogos no admin (ap√≥s listeners atualizarem todosJogos) ========== */
function preencherSelectsJogos(){
  // called on jogos snapshot changes
  const jogoModalidade = document.getElementById("jogoModalidade");
  if (jogoModalidade) { /* j√° preenchido em init */ }
  // chamada select:
  const sel = document.getElementById("selectJogoChamada");
  if (sel){
    sel.innerHTML = '<option value="">Escolha um jogo...</option>';
    todosJogos.forEach(j => {
      const opt = document.createElement("option");
      opt.value = j.id;
      opt.textContent = `${j.modalidade} ‚Äî ${formatarDataBR(j.dataJogo)} ${j.horarioJogo || ""} ‚Äî ${j.turma1} x ${j.turma2}`;
      sel.appendChild(opt);
    });
  }
}

/* ========== Inicializa√ß√£o DOM ready ========== */
if (document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", init); } else { init(); }
</script>

</body>
</html>
