<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f0f4fb; color: var(--texto); }

    header {
      background: linear-gradient(90deg, var(--azul), #007bff);
      color: #fff; padding: 14px 18px; display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; align-items: center;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    header small { display: block; font-size: 0.8rem; opacity: .9; }
    .header-right { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { border: none; border-radius: 999px; padding: 7px 14px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primaria { background: #fff; color: var(--azul); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .btn-admin { background: transparent; border: 1px solid rgba(255,255,255,0.6); color: #fff; }

    main { max-width: 1100px; margin: 18px auto 30px; padding: 0 10px; }
    .card { background: #fff; border-radius: 12px; border: 1px solid var(--borda); padding: 15px; margin-bottom: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .card h2 { margin: 0 0 8px; font-size: 1.05rem; color: var(--azul); }
    .card small { font-size: 0.8rem; color: #555; }
    .grid-2 { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 10px; }
    @media (max-width: 768px){ .grid-2{ grid-template-columns:1fr; } }

    /* --- (mantive todo o CSS anterior) --- */
    label { display:block; font-size:0.85rem; margin-bottom:3px; font-weight:500; }
    input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea { width:100%; padding:7px 8px; border-radius:8px; border:1px solid var(--borda); background:#fafbff; font-size:0.9rem; }
    textarea { resize:vertical; min-height:60px; }
    .modalidades-lista { margin-top:6px; display:grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap:6px; }
    .modalidade-item { display:flex; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--borda); background:var(--azul-claro); font-size:0.8rem; }
    .modalidade-item input { margin-top:3px; }
    .modalidade-label { font-weight:600; font-size:0.85rem; }
    .modalidade-vagas { display:block; font-size:0.75rem; color:#333; }
    .modalidade-lotado { color:var(--vermelho); font-weight:600; }
    .alerta { margin-top:4px; font-size:0.8rem; color:#555; }
    .msg-erro { background:#ffe5e5; color:#b30000; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    .msg-sucesso { background:#e5ffe9; color:#0c7a2a; padding:6px 8px; border-radius:8px; font-size:0.8rem; margin-bottom:6px; }
    table { width:100%; border-collapse:collapse; margin-top:6px; font-size:0.8rem; }
    th,td { padding:5px 6px; border-bottom:1px solid #e1e4eb; text-align:left; }
    th { background:#f2f5ff; font-weight:600; }
    tr:hover td { background:#f9fbff; }
    .filtros { margin-top:6px; display:flex; flex-wrap:wrap; gap:8px; }
    .filtros > div { min-width:150px; }
    #tab-inscricoes { overflow-x: auto; } #tab-inscricoes table { min-width: 700px; }
    #adminSection { display:none; } .admin-header { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px; }
    .admin-header h2 { margin:0; font-size:1rem; color:var(--azul); } .admin-sub { font-size:0.8rem; color:#555; }
    .admin-status { font-size:0.75rem; padding:3px 8px; border-radius:999px; background:#e5ffe9; color:#0c7a2a; } .admin-status.fechado { background:#ffe5e5; color:#b30000; }
    .admin-tabs { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; border-bottom:1px solid #e1e4eb; padding-bottom:4px; }
    .admin-tab-btn { border:none; border-radius:999px; padding:5px 10px; font-size:0.8rem; background:#f1f3fb; cursor:pointer; } .admin-tab-btn.ativo { background:var(--azul); color:#fff; }
    .admin-tab-content { display:none; } .admin-tab-content.ativo { display:block; } .admin-bloco { background:#f9fbff; border-radius:10px; border:1px dashed #c5cde0; padding:8px; margin-bottom:8px; font-size:0.82rem; }
    #secInscritos, #secJogos, #secPlacarAoVivo, #secClassificados { display:none; }
    .jogo-bloco { border-radius:10px; border:1px solid var(--borda); padding:6px 8px; margin-top:6px; background:#f9fbff; }
    .placar-card { border-radius:10px; border:1px solid var(--borda); padding:8px 10px; margin-top:6px; background:#f9fbff; font-size:0.85rem; }
    .placar-linha-principal { font-weight:600; margin-bottom:4px; } .placar-status { display:inline-block; padding:2px 8px; border-radius:999px; font-size:0.75rem; margin-top:2px; }
    .placar-status.andamento { background:#e5ffe9; color:#0c7a2a; } .placar-status.prestes { background:#fff4d6; color:#8a6d3b; }
    .linha-classificado { display:flex; align-items:center; gap:4px; font-size:0.85rem; margin-top:2px; }
    .bolinha-resultado { width:10px; height:10px; border-radius:50%; display:inline-block; } .bolinha-verde { background: var(--verde); } .bolinha-vermelha { background: var(--vermelho); } .bolinha-neutra { background:#ccc; }
    #emailOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999; }
    #emailOverlayCard { background:#fff; border-radius:10px; padding:15px; max-width:360px; width:90%; box-shadow:0 8px 20px rgba(0,0,0,0.3); }
    #relatorioCabecalhoImpressao { margin-top:4px; margin-bottom:4px; } #relatorioCabecalhoImpressao h3 { margin:0; font-size:0.95rem; color:var(--azul); } #relatorioCabecalhoImpressao small { font-size:0.8rem; color:#555; }
    #professoresSection { display:none; } #profListaAlunos .jogo-bloco { margin-top:8px; }

    /* --- NOVO: Modal TOP10 e player ao vivo --- */
    .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .modal-card { width: 96%; max-width: 900px; background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; overflow:auto; }
    .top10-list { display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px; }
    .top10-item { display:flex; justify-content:space-between; padding:8px; border-radius:8px; border:1px solid #e6ebf5; background:#fbfdff; align-items:center; }
    .live-player { width:100%; background:#000; border-radius:10px; overflow:hidden; position:relative; }
    .overlay-placar { position:absolute; left:0; right:0; top:6px; display:flex; justify-content:center; gap:12px; z-index:2; pointer-events:none; }
    .overlay-placar .box { background: rgba(255,255,255,0.95); padding:6px 10px; border-radius:8px; font-weight:700; color: var(--azul); pointer-events:auto; }
    .video-wrapper { padding-top:56.25%; position:relative; } /* 16:9 */
    .video-wrapper iframe, .video-wrapper video { position:absolute; top:0; left:0; width:100%; height:100%; border:0; background:#000; }
    .camera-controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .camera-card { padding:8px; border-radius:8px; border:1px solid #e1e6f3; background:#fff; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>

<!-- OVERLAY E-MAIL -->
<div id="emailOverlay">
  <div id="emailOverlayCard">
    <h2>Antes de continuar...</h2>
    <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o.</p>
    <div id="msgEmailOverlay"></div>
    <input type="text" id="emailAluno" placeholder="seuemail@exemplo.com" />
    <button class="btn btn-primaria" id="btnEntrarEmail">Entrar</button>
  </div>
</div>

<header>
  <div>
    <h1 id="tituloEvento">Inscri√ß√µes Movimenta Odisseia</h1>
    <small id="subEvento">Inscri√ß√µes para o Movimenta Odisseia</small>
  </div>
  <div class="header-right">
    <button class="btn btn-primaria" id="btnToggleInscritos">üëÄ Ver inscritos</button>
    <button class="btn btn-primaria" id="btnVerJogos">üèÜ Ver jogos</button>
    <button class="btn btn-primaria" id="btnClassificados">‚úÖ Classificados</button>
    <button class="btn btn-primaria" id="btnPlacarAoVivo">‚ö° Placar ao vivo</button>

    <!-- NOVO: Bot√£o TOP10 p√∫blico -->
    <button class="btn btn-primaria" id="btnTop10">üèÖ TOP 10</button>

    <button class="btn btn-admin" id="btnAdminArea">üîê √Årea administrativa</button>
  </div>
</header>

<main>
  <!-- (TODO: todo o conte√∫do existente foi mantido ‚Äî abaixo repito as se√ß√µes originais) -->

  <!-- INSCRI√á√ÉO -->
  <section class="card" id="secInscricao">
    <h2>Formul√°rio de inscri√ß√£o</h2>
    <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>

    <div id="msgForm"></div>

    <form id="formInscricao">
      <div class="grid-2">
        <div>
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione...</option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="turno">Turno</label>
          <select id="turno" required>
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="turma">Turma</label>
          <select id="turma" required>
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
          <input type="text" id="camisaNumero" />
        </div>
        <div>
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" placeholder="Posi√ß√£o, alguma observa√ß√£o..."></textarea>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Modalidades (m√°ximo 2 por aluno)</label>
        <p class="alerta">
          ‚Ä¢ LIMITE padr√£o por turma: FUTSAL (8), DOMIN√ì/FUTMESA/T√äNIS/XADREZ (2), VOLEI (6), QUEIMADA MISTA (10 ‚Äì 5 meninos / 5 meninas).  
          ‚Ä¢ Esses limites podem ser ajustados na √°rea administrativa.
        </p>
        <div class="modalidades-lista" id="modalidadesContainer"></div>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:0.8rem;">Use o bot√£o <strong>Ver inscritos</strong> para ver quem j√° est√° em cada turma.</span>
        <button type="submit" class="btn btn-primaria">‚úÖ Enviar inscri√ß√£o</button>
      </div>
    </form>
  </section>

  <!-- PAINEL INSCRITOS (ALUNO) -->
  <section class="card" id="secInscritos">
    <h2>Painel de inscritos</h2>
    <small>Visualiza√ß√£o simples para os alunos (apenas nome e turma).</small>

    <div class="filtros">
      <div>
        <label for="filtroTurno">Turno</label>
        <select id="filtroTurno">
          <option value="">Selecione...</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
          <option value="Noturno">Noturno</option>
        </select>
      </div>
      <div>
        <label for="filtroTurma">Turma</label>
        <select id="filtroTurma">
          <option value="">Selecione o turno primeiro...</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidade">Modalidade</label>
        <select id="filtroModalidade">
          <option value="">Selecione a modalidade...</option>
        </select>
      </div>
    </div>

    <table id="tabelaPublica">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Turma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- JOGOS (ALUNO) -->
  <section class="card" id="secJogos">
    <h2>Jogos</h2>
    <small>Selecione a <strong>s√©rie</strong> e a <strong>modalidade</strong>. A data √© opcional.</small>

    <div class="filtros">
      <div>
        <label for="filtroSerieJogo">S√©rie</label>
        <select id="filtroSerieJogo">
          <option value="">Selecione...</option>
          <option value="6">6¬∫ ano</option>
          <option value="7">7¬∫ ano</option>
          <option value="8">8¬∫ ano</option>
          <option value="9">9¬∫ ano</option>
          <option value="1">1¬∫ ano</option>
          <option value="2">2¬∫ ano</option>
          <option value="3">3¬∫ ano</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidadeJogo">Modalidade</label>
        <select id="filtroModalidadeJogo">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div>
        <label for="filtroDataJogo">Data (opcional)</label>
        <input type="date" id="filtroDataJogo">
      </div>
    </div>

    <div id="listaJogosContainer"></div>
  </section>

  <!-- CLASSIFICA√á√ÉO / CLASSIFICADOS (ALUNO) -->
  <section class="card" id="secClassificados">
    <h2>Classificados</h2>
    <small>Veja, jogo por jogo, qual turma foi classificada (apenas jogos finalizados).</small>
    <div id="classificacaoContainer"></div>
  </section>

  <!-- PLACAR AO VIVO (ALUNO) -->
  <section class="card" id="secPlacarAoVivo">
    <h2>Placar ao vivo</h2>
    <small>Veja os jogos que est√£o em andamento ou prestes a come√ßar. Caso o ADM ative a transmiss√£o, voc√™ ver√° o placar e a transmiss√£o aqui.</small>

    <div id="placarAoVivoContainer"></div>
  </section>

  <!-- ADMIN -->
  <section class="card" id="adminSection">
    <div class="admin-header">
      <div>
        <h2>√Årea administrativa</h2>
        <div class="admin-sub">Gerencie inscri√ß√µes, jogos, c√¢meras e configura√ß√µes.</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span id="adminStatus" class="admin-status">Verificando...</span>
        <button class="btn btn-primaria" id="btnFecharAdmin">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab-btn ativo" data-tab="inscricoes">üßë‚Äçüéì Inscri√ß√µes</button>
      <button class="admin-tab-btn" data-tab="jogos">üèÜ Jogos</button>
      <button class="admin-tab-btn" data-tab="relatorio">üñ®Ô∏è Imprimir relat√≥rio</button>
      <button class="admin-tab-btn" data-tab="professores">üë©‚Äçüè´ Professores</button>
      <button class="admin-tab-btn" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <!-- TAB INSCRI√á√ïES -->
    <div class="admin-tab-content ativo" id="tab-inscricoes">
      <!-- (conte√∫do original das inscri√ß√µes) -->
      <div class="admin-bloco"> ... (mesmo conte√∫do do seu HTML original para esta aba) ... </div>

      <table id="tabelaAdmin">
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>N¬∫ camisa</th>
            <th>Modalidades</th>
            <th>Obs</th>
            <th>Data/Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TAB JOGOS (com controles de c√¢mera adicionados) -->
    <div class="admin-tab-content" id="tab-jogos">
      <div class="admin-bloco">
        <strong>Cadastrar jogo</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoData">Data</label>
            <input type="date" id="jogoData">
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoTurma1">Turma 1</label>
            <select id="jogoTurma1">
              <option value="">Selecione a turma 1...</option>
            </select>
          </div>
          <div>
            <label for="jogoTurma2">Turma 2</label>
            <select id="jogoTurma2">
              <option value="">Selecione a turma 2...</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="jogoModalidade">Modalidade</label>
            <select id="jogoModalidade">
              <option value="">Selecione...</option>
            </select>
          </div>
          <div>
            <label for="jogoHorario">Hor√°rio</label>
            <input type="time" id="jogoHorario">
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="jogoLocal">Local</label>
          <input type="text" id="jogoLocal" placeholder="Ex: Quadra principal">
        </div>
        <button class="btn btn-primaria" style="margin-top:6px;" id="btnCadastrarJogo">Cadastrar jogo</button>
      </div>

      <div class="admin-bloco">
        <strong>Jogos cadastrados</strong>
        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
          <input type="text" id="filtroExcluirJogo" placeholder="Pesquisar jogo (turma, modalidade, data...)" style="flex:1; min-width:200px;">
          <select id="selectExcluirJogo" style="min-width:220px; flex:1;">
            <option value="">Selecione um jogo...</option>
          </select>
          <button class="btn btn-primaria" id="btnExcluirJogo">Excluir</button>
        </div>
      </div>

      <div class="admin-bloco" id="adminPainelJogos">
        <strong>Placar ao vivo / Status dos jogos</strong>
        <small style="display:block;margin-top:2px;">Atualize o status e o placar. As mudan√ßas aparecem em tempo real no site p√∫blico. Aqui voc√™ tamb√©m pode ativar transmiss√£o e selecionar qual c√¢mera ser√° exibida.</small>
        <div id="listaAdminJogos" style="margin-top:6px;"></div>
      </div>

      <!-- NOVO: Gerenciar C√¢meras (cole√ß√£o 'cameras') -->
      <div class="admin-bloco">
        <strong>Gerenciar C√¢meras / Streams</strong>
        <small style="display:block;margin-top:2px;">Adicione URLs de stream (YouTube, Twitch, HLS .m3u8, ou iframe embed). No painel de jogos voc√™ pode atribuir uma c√¢mera a um jogo e ativar a transmiss√£o.</small>

        <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
          <input type="text" id="camNome" placeholder="Nome da c√¢mera (ex: Cam A - Quadra)" style="flex:1; min-width:180px;">
          <input type="text" id="camUrl" placeholder="URL do stream / embed" style="flex:2; min-width:220px;">
          <button class="btn btn-primaria" id="btnAdicionarCamera">‚ûï Adicionar c√¢mera</button>
        </div>

        <div id="listaCamerasAdmin" style="margin-top:8px;"></div>
      </div>

    </div>

    <!-- TAB RELAT√ìRIO -->
    <div class="admin-tab-content" id="tab-relatorio">
      <div class="admin-bloco">
        <strong>Filtros para relat√≥rio</strong>
        <div class="filtros" style="margin-top:4px;">
          <div>
            <label for="relatorioTurno">Turno</label>
            <select id="relatorioTurno">
              <option value="">Selecione...</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Noturno">Noturno</option>
            </select>
          </div>
          <div>
            <label for="relatorioTurma">Turma</label>
            <select id="relatorioTurma">
              <option value="">Selecione o turno primeiro...</option>
            </select>
          </div>
          <div>
            <label for="relatorioModalidade">Modalidade</label>
            <select id="relatorioModalidade">
              <option value="">Selecione a modalidade...</option>
            </select>
          </div>
        </div>
        <div id="relatorioCabecalhoImpressao">
          <h3 id="relatorioTituloLinha1">Relat√≥rio de inscritos ‚Äì Movimenta Odisseia</h3>
          <small id="relatorioTituloLinha2">Selecione turno, turma e modalidade para gerar o relat√≥rio.</small>
        </div>
        <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn btn-primaria" id="btnImprimirRelatorio">üñ®Ô∏è Imprimir</button>
          <button class="btn btn-primaria" id="btnImprimirTodaTurma">üñ®Ô∏è Imprimir Toda Turma</button>
        </div>
      </div>

      <table id="tabelaRelatorio">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Sexo</th>
            <th>Turma</th>
            <th>Turno</th>
            <th>Modalidades</th>
            <th>E-mail</th>
            <th>N¬∫ camisa</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TAB PROFESSORES (ADMIN GERENCIA SENHAS) -->
    <div class="admin-tab-content" id="tab-professores">
      <div class="admin-bloco">
        <strong>Cadastrar acesso de professor / coordenador / gestor</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="profNomeCadastro">Nome</label>
            <input type="text" id="profNomeCadastro" placeholder="Ex: Jean">
          </div>
          <div>
            <label for="profTipoCadastro">Tipo de acesso</label>
            <select id="profTipoCadastro">
              <option value="Professor">Professor</option>
              <option value="Coordenador">Coordenador</option>
              <option value="Gestor">Gestor</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="profSenhaCadastro">Senha</label>
            <div style="display:flex; gap:6px; align-items:center;">
              <input type="text" id="profSenhaCadastro" placeholder="Senha que ele vai usar" style="flex:1;">
              <button type="button" class="btn btn-primaria" id="btnGerarSenhaProfessor">Gerar senha</button>
            </div>
          </div>
        </div>
        <button class="btn btn-primaria" style="margin-top:6px;" id="btnAdicionarProfessor">‚ûï Adicionar acesso</button>
      </div>

      <div class="admin-bloco">
        <strong>Acessos cadastrados</strong>
        <small style="display:block;margin-top:2px;">Use para controlar quem pode entrar no painel de professores.</small>
        <table style="margin-top:4px; width:100%; border-collapse:collapse; font-size:0.8rem;">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Senha</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaProfessoresAdmin"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB CONFIG -->
    <div class="admin-tab-content" id="tab-config">
      <div class="admin-bloco">
        <strong>Datas e bloqueio</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgDataLimite">Data de encerramento</label>
            <input type="date" id="cfgDataLimite">
          </div>
          <div>
            <label><input type="checkbox" id="cfgBloquearAgora"> Bloquear inscri√ß√µes agora</label>
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="cfgMsgEncerradas">Mensagem quando estiver encerrado</label>
          <textarea id="cfgMsgEncerradas" placeholder="Ex: As inscri√ß√µes foram encerradas."></textarea>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Limites</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgLimitePorAluno">M√°x. modalidades por aluno</label>
            <input type="number" id="cfgLimitePorAluno" min="1">
          </div>
          <div>
            <label for="cfgQueimadaTotal">Queimada total (por turma)</label>
            <input type="number" id="cfgQueimadaTotal" min="1">
          </div>
          <div>
            <label for="cfgQueimadaSexo">Queimada por sexo</label>
            <input type="number" id="cfgQueimadaSexo" min="1">
          </div>
        </div>
        <p style="margin:6px 0 4px; font-size:0.8rem;"><strong>Limite por modalidade / turma</strong></p>
        <div class="grid-2">
          <div><label for="cfgFutsal">FUTSAL</label><input type="number" id="cfgFutsal" min="1"></div>
          <div><label for="cfgDomino">DOMIN√ì</label><input type="number" id="cfgDomino" min="1"></div>
          <div><label for="cfgFutmesa">FUTMESA</label><input type="number" id="cfgFutmesa" min="1"></div>
          <div><label for="cfgTenis">T√äNIS DE MESA</label><input type="number" id="cfgTenis" min="1"></div>
          <div><label for="cfgXadrez">XADREZ</label><input type="number" id="cfgXadrez" min="1"></div>
          <div><label for="cfgVolei">VOLEI</label><input type="number" id="cfgVolei" min="1"></div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Autoriza√ß√µes (ignorar limites por turma)</strong>
        <small style="display:block;margin-top:2px;">Selecione a turma e marque as modalidades que devem ser autorizadas ‚Äî quando marcada, a modalidade ser√° aceita mesmo que os limites estejam preenchidos (aplica-se √† QUEIMADA tamb√©m).</small>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
          <select id="cfgAutTurma" style="min-width:220px;">
            <option value="">Selecione a turma...</option>
          </select>
          <div id="cfgAutModalidadesContainer" style="flex:1;"></div>
        </div>
      </div>

      <div class="admin-bloco">
        <strong>Texto do evento</strong>
        <div class="grid-2" style="margin-top:4px;">
          <div>
            <label for="cfgNomeEvento">Nome do evento</label>
            <input type="text" id="cfgNomeEvento" placeholder="Movimenta Odisseia">
          </div>
          <div>
            <label for="cfgAnoEvento">Ano</label>
            <input type="text" id="cfgAnoEvento" placeholder="2025">
          </div>
        </div>
        <div style="margin-top:4px;">
          <label for="cfgTextoInicial">Texto abaixo do t√≠tulo</label>
          <textarea id="cfgTextoInicial"></textarea>
        </div>
      </div>

      <button class="btn btn-primaria" id="btnSalvarConfig">üíæ Salvar configura√ß√µes</button>
    </div>
  </section>

  <!-- PAINEL PARA PROFESSORES / COORDENADORES / GESTORES -->
  <section class="card" id="professoresSection">
    <div class="admin-header">
      <div>
        <h2>Painel de professores</h2>
        <div class="admin-sub">
          Selecione turno e turma para indicar alunos que <strong>n√£o podem participar</strong>.
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span style="font-size:0.8rem;" id="profUsuarioAtivo">Professor logado</span>
        <button class="btn btn-primaria" id="btnFecharProfessores">‚¨Ö Voltar</button>
      </div>
    </div>

    <div class="admin-bloco">
      <strong>Filtrar turma</strong>
      <div class="filtros" style="margin-top:4px;">
        <div>
          <label for="profTurnoSelect">Turno</label>
          <select id="profTurnoSelect">
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="profTurmaSelect">Turma</label>
          <select id="profTurmaSelect">
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>
    </div>

    <div class="admin-bloco">
      <strong>Alunos inscritos na turma</strong>
      <small style="display:block;margin-top:2px;">
        Clique para indicar que o aluno <strong>n√£o deve participar</strong>. Quando dois professores diferentes indicarem o mesmo aluno, a inscri√ß√£o ser√° cancelada automaticamente.
      </small>
      <div id="profListaAlunos" style="margin-top:6px;"></div>
    </div>
  </section>

</main>

<!-- NOVO: Modal TOP10 -->
<div id="modalTop10" style="display:none;"></div>

<script>
"use strict";

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== CONSTANTES E VARIAVEIS (mantidas do seu HTML) ========== */
const MODALIDADES = ["FUTSAL","QUEIMADA MISTA","DOMIN√ì","FUTMESA","T√äNIS DE MESA","XADREZ","VOLEI"];
const TURMAS_MATUTINO = ["7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F","8¬∫F","9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"];
const TURMAS_VESPERTINO = ["6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G","8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"];
const TURMAS_NOTURNO = ["1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F","2¬∫A","2¬∫B","2¬∫C","3¬∫A","3¬∫B","3¬∫C"];
const TODAS_TURMAS = [...TURMAS_MATUTINO, ...TURMAS_VESPERTINO, ...TURMAS_NOTURNO];
function getTurmasPorTurno(turno){ if (turno==="Matutino") return TURMAS_MATUTINO; if (turno==="Vespertino") return TURMAS_VESPERTINO; if (turno==="Noturno") return TURMAS_NOTURNO; return []; }
function getSerieFromTurma(t){ if (!t) return ""; return t.charAt(0); }

/* limites */
let LIMITE_MODALIDADES_POR_ALUNO = 2;
let LIMITE_MODALIDADE_TURMA = {"FUTSAL":8,"DOMIN√ì":2,"FUTMESA":2,"T√äNIS DE MESA":2,"XADREZ":2,"VOLEI":6};
let LIMITE_QUEIMADA_TOTAL = 10;
let LIMITE_QUEIMADA_POR_SEXO = 5;

/* dados locais */
let countsPorTurmaModalidade = {};
let countsQueimadaGenero = {};
let todasInscricoes = [];
let todosJogos = [];
let todosProfessores = [];
let todosCameras = []; // NOVO: lista local de c√¢meras
let currentRole = null;
let currentProfessor = null;
let emailAtual = null;
let isAdmin = false;
const ADMIN_PASSWORD = "52090949";

/* configEvento */
let configEvento = { dataLimite: null, msgEncerradas: "", bloquearAgora: false, nomeEvento:"Movimenta Odisseia", anoEvento:"", textoInicial:"", autorizacoes:{} };
let inscricoesEncerradas = false;

/* ========== FUN√á√ïES AUXILIARES (mantidas) ========== */
function normalizarNome(str){ return (str||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," "); }
function validarEmail(email){ return email && email.includes("@") && email.includes("."); }
function msgForm(texto, ok){ const box = document.getElementById("msgForm"); box.innerHTML=""; const div = document.createElement("div"); div.className = ok ? "msg-sucesso":"msg-erro"; div.textContent = texto; box.appendChild(div); }
function formatarDataBR(yyyyMMdd){ if(!yyyyMMdd) return "-"; const p = yyyyMMdd.split("-"); if(p.length!==3) return yyyyMMdd; return p[2]+"/"+p[1]+"/"+p[0]; }

/* ========== ATUALIZAR STATUS/CONFIG (mantidas) ========== */
function atualizarStatusInscricoes(){
  const hoje = new Date(); const hojeDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  let fechado = false;
  if (configEvento.bloquearAgora) fechado = true;
  else if (configEvento.dataLimite){
    const p = configEvento.dataLimite.split("-");
    if (p.length===3){ const limiteDia = new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2])); if (hojeDia.getTime() >= limiteDia.getTime()) fechado = true; }
  }
  inscricoesEncerradas = fechado;
  const form = document.getElementById("formInscricao");
  const adminStatus = document.getElementById("adminStatus");
  if (form){ const campos = form.querySelectorAll("input,select,textarea,button[type='submit']"); campos.forEach(el => { el.disabled = fechado; }); }
  if (fechado){
    msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false);
    if (adminStatus){ adminStatus.textContent = "Inscri√ß√µes ENCERRADAS"; adminStatus.classList.add("fechado"); }
  } else {
    document.getElementById("msgForm").innerHTML = "";
    if (adminStatus){ adminStatus.textContent = "Inscri√ß√µes ABERTAS"; adminStatus.classList.remove("fechado"); }
  }
}

/* ========== CARREGAR/SALVAR CONFIG (mantidas) ========== */
async function carregarConfiguracoes(){
  try{
    const docSnap = await db.collection("config").doc("geral").get();
    if (docSnap.exists){
      const d = docSnap.data();
      if (d.dataLimiteInscricao) configEvento.dataLimite = d.dataLimiteInscricao;
      if (typeof d.bloquearInscricoesAgora === "boolean") configEvento.bloquearAgora = d.bloquearInscricoesAgora;
      if (d.mensagemEncerradas) configEvento.msgEncerradas = d.mensagemEncerradas;
      if (typeof d.limiteModalidadesPorAluno === "number") LIMITE_MODALIDADES_POR_ALUNO = d.limiteModalidadesPorAluno;
      if (typeof d.limiteQueimadaTotal === "number") LIMITE_QUEIMADA_TOTAL = d.limiteQueimadaTotal;
      if (typeof d.limiteQueimadaPorSexo === "number") LIMITE_QUEIMADA_POR_SEXO = d.limiteQueimadaPorSexo;
      if (d.limitesModalidadeTurma){ Object.keys(d.limitesModalidadeTurma).forEach(m => { const val = d.limitesModalidadeTurma[m]; if (typeof val === "number") LIMITE_MODALIDADE_TURMA[m] = val; }); }
      if (d.nomeEvento) configEvento.nomeEvento = d.nomeEvento;
      if (d.anoEdicao) configEvento.anoEvento = d.anoEdicao;
      if (d.textoInicial) configEvento.textoInicial = d.textoInicial;
      if (d.autorizacoes) configEvento.autorizacoes = d.autorizacoes || {};
    }
  }catch(e){ console.error("Erro ao carregar configura√ß√µes:",e); }

  // atualizar UI
  try{
    document.getElementById("cfgDataLimite").value = configEvento.dataLimite || "";
    document.getElementById("cfgMsgEncerradas").value = configEvento.msgEncerradas || "";
    document.getElementById("cfgBloquearAgora").checked = !!configEvento.bloquearAgora;
    document.getElementById("cfgLimitePorAluno").value = LIMITE_MODALIDADES_POR_ALUNO;
    document.getElementById("cfgQueimadaTotal").value = LIMITE_QUEIMADA_TOTAL;
    document.getElementById("cfgQueimadaSexo").value = LIMITE_QUEIMADA_POR_SEXO;
    document.getElementById("cfgFutsal").value = LIMITE_MODALIDADE_TURMA["FUTSAL"];
    document.getElementById("cfgDomino").value = LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
    document.getElementById("cfgFutmesa").value = LIMITE_MODALIDADE_TURMA["FUTMESA"];
    document.getElementById("cfgTenis").value = LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
    document.getElementById("cfgXadrez").value = LIMITE_MODALIDADE_TURMA["XADREZ"];
    document.getElementById("cfgVolei").value = LIMITE_MODALIDADE_TURMA["VOLEI"];
    document.getElementById("cfgNomeEvento").value = configEvento.nomeEvento || "";
    document.getElementById("cfgAnoEvento").value = configEvento.anoEvento || "";
    document.getElementById("cfgTextoInicial").value = configEvento.textoInicial || "";
    document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
    if (configEvento.textoInicial) document.getElementById("subEvento").textContent = configEvento.textoInicial;
  }catch(e){}
  atualizarAutorizacoesUI();
  atualizarStatusInscricoes();
  atualizarDisponibilidadeModalidades();
}

async function salvarConfiguracoes(){
  if (!isAdmin){ alert("Apenas o administrador pode salvar as configura√ß√µes."); return; }
  const dataLimite = (document.getElementById("cfgDataLimite").value || "").trim();
  const msgEnc = (document.getElementById("cfgMsgEncerradas").value || "").trim();
  const bloquearAgora = document.getElementById("cfgBloquearAgora").checked;
  const limAluno = parseInt(document.getElementById("cfgLimitePorAluno").value,10) || LIMITE_MODALIDADES_POR_ALUNO;
  const limQueimadaTot = parseInt(document.getElementById("cfgQueimadaTotal").value,10) || LIMITE_QUEIMADA_TOTAL;
  const limQueimadaSex = parseInt(document.getElementById("cfgQueimadaSexo").value,10) || LIMITE_QUEIMADA_POR_SEXO;
  const limFutsal = parseInt(document.getElementById("cfgFutsal").value,10) || LIMITE_MODALIDADE_TURMA["FUTSAL"];
  const limDomino = parseInt(document.getElementById("cfgDomino").value,10) || LIMITE_MODALIDADE_TURMA["DOMIN√ì"];
  const limFutmesa = parseInt(document.getElementById("cfgFutmesa").value,10) || LIMITE_MODALIDADE_TURMA["FUTMESA"];
  const limTenis = parseInt(document.getElementById("cfgTenis").value,10) || LIMITE_MODALIDADE_TURMA["T√äNIS DE MESA"];
  const limXadrez = parseInt(document.getElementById("cfgXadrez").value,10) || LIMITE_MODALIDADE_TURMA["XADREZ"];
  const limVolei = parseInt(document.getElementById("cfgVolei").value,10) || LIMITE_MODALIDADE_TURMA["VOLEI"];
  const nomeEvento = (document.getElementById("cfgNomeEvento").value || "").trim();
  const anoEvento = (document.getElementById("cfgAnoEvento").value || "").trim();
  const textoInicial = (document.getElementById("cfgTextoInicial").value || "").trim();

  const limitesModalidadeTurma = { "FUTSAL": limFutsal, "DOMIN√ì": limDomino, "FUTMESA": limFutmesa, "T√äNIS DE MESA": limTenis, "XADREZ": limXadrez, "VOLEI": limVolei };

  try{
    await db.collection("config").doc("geral").set({
      dataLimiteInscricao: dataLimite || null,
      mensagemEncerradas: msgEnc,
      bloquearInscricoesAgora: bloquearAgora,
      limiteModalidadesPorAluno: limAluno,
      limiteQueimadaTotal: limQueimadaTot,
      limiteQueimadaPorSexo: limQueimadaSex,
      limitesModalidadeTurma: limitesModalidadeTurma,
      nomeEvento: nomeEvento,
      anoEdicao: anoEvento,
      textoInicial: textoInicial,
      autorizacoes: configEvento.autorizacoes || {}
    }, { merge:true });

    configEvento.dataLimite = dataLimite || null; configEvento.msgEncerradas = msgEnc; configEvento.bloquearAgora = bloquearAgora;
    LIMITE_MODALIDADES_POR_ALUNO = limAluno; LIMITE_QUEIMADA_TOTAL = limQueimadaTot; LIMITE_QUEIMADA_POR_SEXO = limQueimadaSex;
    LIMITE_MODALIDADE_TURMA = limitesModalidadeTurma; configEvento.nomeEvento = nomeEvento; configEvento.anoEvento = anoEvento; configEvento.textoInicial = textoInicial;
    document.getElementById("tituloEvento").textContent = "Inscri√ß√µes " + (configEvento.nomeEvento || "Movimenta Odisseia");
    if (configEvento.textoInicial) document.getElementById("subEvento").textContent = configEvento.textoInicial;
    atualizarStatusInscricoes(); atualizarDisponibilidadeModalidades();
    alert("Configura√ß√µes salvas com sucesso.");
  }catch(e){ console.error(e); alert("Erro ao salvar configura√ß√µes."); }
}

/* ========== AUTORIZA√á√ïES UI (mantida) ========== */
function atualizarAutorizacoesUI(){
  const sel = document.getElementById("cfgAutTurma");
  const cont = document.getElementById("cfgAutModalidadesContainer");
  if (!sel || !cont) return;
  sel.innerHTML = '<option value=\"\">Selecione a turma...</option>';
  TODAS_TURMAS.forEach(t => { const o = document.createElement("option"); o.value=t; o.textContent=t; sel.appendChild(o); });
  cont.innerHTML = "";
  MODALIDADES.forEach(m => {
    const id = "cfgAutChk_" + m.replace(/\s+/g,"_");
    const wrapper = document.createElement("label");
    wrapper.style.marginRight = "10px"; wrapper.style.fontSize = "0.9rem"; wrapper.style.display = "inline-flex"; wrapper.style.alignItems = "center"; wrapper.style.gap = "6px";
    const chk = document.createElement("input"); chk.type="checkbox"; chk.id=id; chk.dataset.mod=m; chk.className="cfgAutChk";
    wrapper.appendChild(chk); const span = document.createElement("span"); span.textContent = "Permitir " + m; wrapper.appendChild(span); cont.appendChild(wrapper);
  });
  sel.addEventListener("change", () => {
    const turma = sel.value;
    const autorz = (configEvento.autorizacoes && configEvento.autorizacoes[turma]) || {};
    const chks = document.querySelectorAll(".cfgAutChk");
    chks.forEach(chk => { const mod = chk.dataset.mod; chk.checked = !!autorz[mod]; chk.onchange = () => {
        if (!configEvento.autorizacoes) configEvento.autorizacoes = {};
        if (!configEvento.autorizacoes[turma]) configEvento.autorizacoes[turma] = {};
        configEvento.autorizacoes[turma][mod] = chk.checked ? true : false;
    }; });
  });
}

/* ========== DISPONIBILIDADE MODALIDADES (mantida) ========== */
function atualizarDisponibilidadeModalidades(){
  const turma = document.getElementById("turma") ? document.getElementById("turma").value : null;
  const sexo = document.getElementById("sexo") ? document.getElementById("sexo").value : null;
  const spans = document.querySelectorAll(".modalidade-vagas");
  const chks = document.querySelectorAll(".chkModalidade");

  spans.forEach(span => {
    const mod = span.dataset.mod;
    if (!turma){ span.textContent = mod + " (selecione turno e turma)"; span.classList.remove("modalidade-lotado"); return; }
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0, Feminino:0};
      span.textContent = mod + " ("+tot+"/"+LIMITE_QUEIMADA_TOTAL+" / Meninos: "+gen.Masculino+"/"+LIMITE_QUEIMADA_POR_SEXO+" / Meninas: "+gen.Feminino+"/"+LIMITE_QUEIMADA_POR_SEXO+")" + (autorizada ? " ‚Äî AUTORIZADO" : "");
      if (tot >= LIMITE_QUEIMADA_TOTAL && !autorizada) span.classList.add("modalidade-lotado"); else span.classList.remove("modalidade-lotado");
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      span.textContent = mod + " ("+qtd+"/"+lim+" vagas)" + (autorizada ? " ‚Äî AUTORIZADO" : "");
      if (qtd >= lim && !autorizada) span.classList.add("modalidade-lotado"); else span.classList.remove("modalidade-lotado");
    }
  });

  chks.forEach(chk => {
    const mod = chk.value;
    if (!turma){ chk.disabled = true; chk.checked = false; return; }
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0, Feminino:0};
      if (!sexo || (tot >= LIMITE_QUEIMADA_TOTAL && !autorizada)){ chk.disabled = true; chk.checked = false; return; }
      if (sexo === "Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO && !autorizada){ chk.disabled = true; chk.checked = false; return; }
      if (sexo === "Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO && !autorizada){ chk.disabled = true; chk.checked = false; return; }
      chk.disabled = false;
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim && !autorizada){ chk.disabled = true; chk.checked = false; } else { chk.disabled = false; }
    }
  });
}

/* ========== INSCRI√á√ÉO (mantida) ========== */
async function handleSubmitInscricao(e){
  e.preventDefault();
  if (inscricoesEncerradas){ msgForm(configEvento.msgEncerradas || "As inscri√ß√µes foram encerradas.", false); return; }
  if (!emailAtual){ try{ const fromStorage = localStorage.getItem('insc_email'); if (validarEmail(fromStorage)) emailAtual = fromStorage; }catch(e){} }
  if (!emailAtual || !validarEmail(emailAtual)){ alert("Informe um e-mail v√°lido antes de se inscrever."); return; }

  const nome = document.getElementById("nome").value.trim();
  const sexo = document.getElementById("sexo").value;
  const turno = document.getElementById("turno").value;
  const turma = document.getElementById("turma").value;
  const camisaNumero = document.getElementById("camisaNumero").value.trim();
  const observacoes = document.getElementById("observacoes").value.trim();
  const nomeNorm = normalizarNome(nome);
  if (!nome || !sexo || !turno || !turma){ msgForm("Preencha nome, sexo, turno e turma.", false); return; }

  const chks = document.querySelectorAll(".chkModalidade:checked");
  const mods = []; chks.forEach(chk => mods.push(chk.value));
  if (!mods.length){ msgForm("Escolha pelo menos 1 modalidade.", false); return; }
  if (mods.length > LIMITE_MODALIDADES_POR_ALUNO){ msgForm("Voc√™ s√≥ pode escolher at√© "+LIMITE_MODALIDADES_POR_ALUNO+" modalidades.", false); return; }

  for (const ins of todasInscricoes){ if (ins.nomeNormalizado === nomeNorm && ins.turma === turma){ msgForm("J√° existe inscri√ß√£o para este nome nesta turma.", false); return; } }

  for (const mod of mods){
    const autorizada = !!(configEvento.autorizacoes && configEvento.autorizacoes[turma] && configEvento.autorizacoes[turma][mod]);
    if (autorizada) continue;
    if (mod === "QUEIMADA MISTA"){
      const tot = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      const gen = countsQueimadaGenero[turma] || {Masculino:0,Feminino:0};
      if (tot >= LIMITE_QUEIMADA_TOTAL){ msgForm("QUEIMADA MISTA est√° lotada para a turma "+turma+".", false); return; }
      if (sexo === "Masculino" && gen.Masculino >= LIMITE_QUEIMADA_POR_SEXO){ msgForm("Limite de meninos na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return; }
      if (sexo === "Feminino" && gen.Feminino >= LIMITE_QUEIMADA_POR_SEXO){ msgForm("Limite de meninas na QUEIMADA MISTA da turma "+turma+" j√° foi atingido.", false); return; }
    } else {
      const lim = LIMITE_MODALIDADE_TURMA[mod] || 0;
      const qtd = (countsPorTurmaModalidade[turma] && countsPorTurmaModalidade[turma][mod]) || 0;
      if (qtd >= lim){ msgForm('A modalidade "'+mod+'" est√° lotada para a turma '+turma+".", false); return; }
    }
  }

  try{
    await db.collection("inscricoes").add({
      nome: nome,
      nomeNormalizado: nomeNorm,
      email: emailAtual,
      sexo: sexo,
      turno: turno,
      turma: turma,
      camisaNumero: camisaNumero || null,
      modalidades: mods,
      observacoes: observacoes || null,
      naoAutorizadoPor: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgForm("Inscri√ß√£o realizada com sucesso! ‚úÖ", true);
    document.getElementById("formInscricao").reset();
    document.getElementById("turma").innerHTML = '<option value=\"\">Selecione o turno primeiro...</option>';
    document.getElementById("turma").disabled = true;
    atualizarDisponibilidadeModalidades();
  }catch(err){ console.error(err); msgForm("Erro ao salvar inscri√ß√£o. Tente novamente.", false); }
}

/* ========== CANCELAR INSCRI√á√ÉO (mantida) ========== */
async function cancelarInscricao(){
  if (!isAdmin){ alert("Apenas o administrador pode cancelar inscri√ß√µes."); return; }
  const sel = document.getElementById("selectCancelar");
  const raw = sel.value;
  if (!raw){ alert("Selecione uma inscri√ß√£o."); return; }
  const partes = raw.split("|||");
  const id = partes[0];
  const modalidadeSelecionada = partes[1] || null;
  const ins = todasInscricoes.find(i => i.id === id);
  if (!ins){ alert("Inscri√ß√£o n√£o encontrada."); return; }
  if (!modalidadeSelecionada){ alert("Modalidade inv√°lida."); return; }
  const mensagemConfirm = 'Cancelar a modalidade "'+modalidadeSelecionada+'" do aluno "'+ins.nome+'" da turma '+ins.turma+'?\n\nSe esta for a √∫nica modalidade, a inscri√ß√£o inteira ser√° removida.';
  if (!confirm(mensagemConfirm)) return;
  try{
    const modalidadesAtuais = Array.isArray(ins.modalidades) ? ins.modalidades.slice() : [];
    const filtradas = modalidadesAtuais.filter(m => m !== modalidadeSelecionada);
    if (filtradas.length === 0){
      await db.collection("inscricoes").doc(id).delete();
      alert("Inscri√ß√£o completa cancelada.");
    } else {
      await db.collection("inscricoes").doc(id).update({ modalidades: filtradas });
      alert("Modalidade cancelada com sucesso.");
    }
  }catch(e){ console.error(e); alert("Erro ao cancelar inscri√ß√£o."); }
}

/* ========== RENDERIZA√á√ÉO / TABELAS (mantidas) ========== */
function renderPublico(){
  const corpo = document.querySelector("#tabelaPublica tbody");
  const filtroTurnoEl = document.getElementById("filtroTurno");
  const filtroTurmaEl = document.getElementById("filtroTurma");
  const filtroModEl = document.getElementById("filtroModalidade");
  if (!corpo || !filtroTurnoEl || !filtroTurmaEl || !filtroModEl) return;
  const turno = filtroTurnoEl.value; const turma = filtroTurmaEl.value; const mod = filtroModEl.value;
  corpo.innerHTML = "";
  if (!turno || !turma || !mod){
    const tr = document.createElement("tr"); const td = document.createElement("td"); td.colSpan = 2; td.textContent = "Selecione turno, turma e modalidade para ver os inscritos."; tr.appendChild(td); corpo.appendChild(tr); return;
  }
  const lista = todasInscricoes.filter(ins => ins.turno===turno && ins.turma===turma && ins.modalidades && ins.modalidades.includes(mod));
  if (!lista.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=2; td.textContent="Nenhum inscrito para esses filtros."; tr.appendChild(td); corpo.appendChild(tr); return; }
  lista.forEach(ins => { const tr=document.createElement("tr"); const tdN=document.createElement("td"); const tdT=document.createElement("td"); tdN.textContent=ins.nome; tdT.textContent=ins.turma; tr.appendChild(tdN); tr.appendChild(tdT); corpo.appendChild(tr); });
}

function renderAdmin(){ if (!isAdmin) return; const corpo = document.querySelector("#tabelaAdmin tbody"); corpo.innerHTML = ""; const nomeFiltro = (document.getElementById("adminFiltroNome").value || "").toLowerCase(); const turmaFiltro = document.getElementById("adminFiltroTurma").
