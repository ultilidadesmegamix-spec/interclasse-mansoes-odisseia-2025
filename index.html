<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√µes Movimenta Odisseia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- jsQR (para leitura de QR via c√¢mera) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <!-- Biblioteca para gerar QR client-side (gera data:URL) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    :root {
      --azul: #0056b3;
      --azul-claro: #e3f1ff;
      --cinza: #f5f5f5;
      --borda: #d0d7e2;
      --vermelho: #d9534f;
      --verde: #28a745;
      --texto: #222;
    }
    * { box-sizing:border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin:0; background:#f0f4fb; color:var(--texto); }
    header { background: linear-gradient(90deg, var(--azul), #007bff); color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    header h1 { margin:0; font-size:1.1rem; }
    header small { display:block; font-size:0.8rem; opacity:.9; }
    .header-right { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { border:none; border-radius:999px; padding:7px 14px; cursor:pointer; font-size:0.9rem; display:inline-flex; align-items:center; gap:6px; }
    .btn-primaria { background:#fff; color:var(--azul); box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    .btn-admin { background:transparent; border:1px solid rgba(255,255,255,0.6); color:#fff; }

    main { max-width:1100px; margin:18px auto 30px; padding:0 10px; }
    .card { background:#fff; border-radius:12px; border:1px solid var(--borda); padding:15px; margin-bottom:14px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .card h2 { margin:0 0 8px; font-size:1.05rem; color:var(--azul); }
    .grid-2 { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; }
    @media (max-width:768px){ .grid-2{grid-template-columns:1fr;} }

    label { display:block; font-size:0.85rem; margin-bottom:3px; font-weight:500; }
    input[type="text"], select, textarea { width:100%; padding:7px 8px; border-radius:8px; border:1px solid var(--borda); background:#fafbff; font-size:0.9rem; }
    textarea{ resize:vertical; min-height:60px; }

    .modalidades-lista { margin-top:6px; display:grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap:6px; }
    .modalidade-item { display:flex; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--borda); background:var(--azul-claro); font-size:0.8rem; }
    .modalidade-label{ font-weight:600; font-size:0.85rem; }
    .modalidade-vagas{ display:block; font-size:0.75rem; color:#333; }

    .cred-lista { margin-top:8px; display:grid; gap:8px; }
    .cred-card { border:1px solid #e1e6f5; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .cred-dados { font-size:0.9rem; }
    .cred-actions { display:flex; gap:8px; flex-wrap:wrap; }

    /* scanner UI */
    #scannerOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; z-index:10000; align-items:center; justify-content:center; flex-direction:column; }
    #scannerCard { width:90%; max-width:900px; background:#fff; border-radius:10px; padding:10px; }
    #scannerVideo { width:100%; max-height:420px; background:#000; }
    #scannerResult { margin-top:8px; min-height:120px; color:#222; }
    #scannerError { margin-top:8px; color:#fff; background:var(--vermelho); padding:8px; border-radius:6px; display:none; }

    /* chamada panel */
    #chamadaPanel { margin-top:10px; border:1px dashed #c5cde0; padding:10px; border-radius:8px; background:#fbfeff; display:none; }
    #chamadaLista { margin-top:10px; max-height:320px; overflow:auto; border-top:1px solid #e6ecf8; padding-top:8px; }
    .chamada-row { display:flex; justify-content:space-between; gap:8px; padding:8px 6px; border-radius:6px; align-items:center; }
    .status-badge { padding:4px 8px; border-radius:999px; font-weight:700; font-size:0.85rem; color:#fff; }
    .status-validado { background:var(--verde); }
    .status-nao { background:#777; }

    /* overlay email */
    #emailOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999; }
    #emailOverlayCard { background:#fff; border-radius:10px; padding:15px; max-width:360px; width:90%; box-shadow:0 8px 20px rgba(0,0,0,0.3); }
    #emailOverlayCard h2 { margin:0 0 6px; font-size:1rem; color:var(--azul); }
  </style>
</head>
<body>

<!-- OVERLAY E-MAIL -->
<div id="emailOverlay">
  <div id="emailOverlayCard">
    <h2>Antes de continuar...</h2>
    <p>Informe seu <strong>e-mail</strong> para registrar sua inscri√ß√£o.</p>
    <div id="msgEmailOverlay"></div>
    <input type="text" id="emailAluno" placeholder="seuemail@exemplo.com" />
    <button class="btn btn-primaria" id="btnEntrarEmail">Entrar</button>
  </div>
</div>

<header>
  <div>
    <h1 id="tituloEvento">Inscri√ß√µes Movimenta Odisseia</h1>
    <small id="subEvento">Inscri√ß√µes para o Movimenta Odisseia</small>
  </div>
  <div class="header-right">
    <button class="btn btn-primaria" id="btnToggleInscritos">üëÄ Ver inscritos</button>
    <button class="btn btn-primaria" id="btnVerJogos">üèÜ Ver jogos</button>
    <button class="btn btn-primaria" id="btnClassificados">‚úÖ Classificados</button>
    <button class="btn btn-primaria" id="btnPlacarAoVivo">‚ö° Placar ao vivo</button>
    <button class="btn btn-admin" id="btnAdminArea">üîê √Årea administrativa</button>
  </div>
</header>

<main>
  <!-- INSCRI√á√ÉO -->
  <section class="card" id="secInscricao">
    <h2>Formul√°rio de inscri√ß√£o</h2>
    <small>Preencha seus dados e escolha at√© <strong>2 modalidades</strong>.</small>
    <div id="msgForm"></div>

    <form id="formInscricao">
      <div class="grid-2">
        <div>
          <label for="nome">Nome completo</label>
          <input type="text" id="nome" required />
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione...</option>
            <option value="Feminino">Feminino</option>
            <option value="Masculino">Masculino</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="turno">Turno</label>
          <select id="turno" required>
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="turma">Turma</label>
          <select id="turma" required>
            <option value="">Selecione o turno primeiro...</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px;">
        <div>
          <label for="camisaNumero">N√∫mero da camisa (opcional)</label>
          <input type="text" id="camisaNumero" />
        </div>
        <div>
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" placeholder="Posi√ß√£o, alguma observa√ß√£o..."></textarea>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Modalidades (m√°ximo 2 por aluno)</label>
        <p class="alerta">
          ‚Ä¢ LIMITE padr√£o por turma: FUTSAL (8), DOMIN√ì/FUTMESA/T√äNIS/XADREZ (2), VOLEI (6), QUEIMADA MISTA (10 ‚Äì 5 meninos / 5 meninas).  
          ‚Ä¢ Esses limites podem ser ajustados na √°rea administrativa.
        </p>
        <div class="modalidades-lista" id="modalidadesContainer"></div>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:0.8rem;">Use o bot√£o <strong>Ver inscritos</strong> para ver quem j√° est√° em cada turma.</span>
        <button type="submit" class="btn btn-primaria">‚úÖ Enviar inscri√ß√£o</button>
      </div>
    </form>
  </section>

  <!-- PAINEL INSCRITOS (ALUNO) -->
  <section class="card" id="secInscritos">
    <h2>Painel de inscritos</h2>
    <small>Visualiza√ß√£o simples para os alunos (apenas nome e turma).</small>

    <div class="filtros">
      <div>
        <label for="filtroTurno">Turno</label>
        <select id="filtroTurno">
          <option value="">Selecione...</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
          <option value="Noturno">Noturno</option>
        </select>
      </div>
      <div>
        <label for="filtroTurma">Turma</label>
        <select id="filtroTurma">
          <option value="">Selecione o turno primeiro...</option>
        </select>
      </div>
      <div>
        <label for="filtroModalidade">Modalidade</label>
        <select id="filtroModalidade">
          <option value="">Selecione a modalidade...</option>
        </select>
      </div>
    </div>

    <table id="tabelaPublica">
      <thead>
        <tr><th>Nome</th><th>Turma</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CREDENCIAIS (inclui Chamada) -->
  <section class="card" id="credenciaisSection">
    <h2>Credenciais</h2>
    <small>Gerar e imprimir credenciais. Tamb√©m iniciar chamada para validar presen√ßa dos jogadores.</small>

    <div class="filtros" style="margin-top:8px;">
      <div>
        <label for="credFiltroTurno">Turno</label>
        <select id="credFiltroTurno">
          <option value="">Selecione...</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
          <option value="Noturno">Noturno</option>
        </select>
      </div>
      <div>
        <label for="credFiltroTurma">Turma</label>
        <select id="credFiltroTurma">
          <option value="">Selecione o turno primeiro...</option>
        </select>
      </div>
      <div>
        <label for="credFiltroModalidade">Modalidade</label>
        <select id="credFiltroModalidade">
          <option value="">Todas</option>
        </select>
      </div>
    </div>

    <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primaria" id="btnAbrirCredenciais">üîç Atualizar lista</button>
        <button class="btn" id="btnAbrirEscaneador">üì∑ Escaneador</button>
      </div>
      <!-- Bot√£o de Chamada -->
      <div>
        <button class="btn btn-primaria" id="btnAbrirChamada">üìã Chamada</button>
      </div>
    </div>

    <div class="cred-lista" id="credLista" style="margin-top:12px;"></div>

    <!-- Painel de CHAMADA -->
    <div id="chamadaPanel">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div>
          <label for="chTurno">Turno</label>
          <select id="chTurno">
            <option value="">Selecione...</option>
            <option value="Matutino">Matutino</option>
            <option value="Vespertino">Vespertino</option>
            <option value="Noturno">Noturno</option>
          </select>
        </div>
        <div>
          <label for="chTurma">Turma</label>
          <select id="chTurma"><option value="">Selecione o turno primeiro...</option></select>
        </div>
        <div>
          <label for="chModalidade">Modalidade</label>
          <select id="chModalidade"><option value="">Selecione a modalidade...</option></select>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-left:auto;">
          <button class="btn btn-primaria" id="btnIniciarChamada">‚ñ∂Ô∏è Iniciar chamada</button>
          <button class="btn" id="btnEncerrarChamada">‚èπÔ∏è Encerrar sess√£o</button>
          <span id="chSessionLabel" style="font-size:0.85rem; color:#333; margin-left:6px;"></span>
        </div>
      </div>

      <div id="chamadaLista"></div>
    </div>
  </section>

  <!-- pequenas se√ß√µes mantidas (jogos/classificados/placar/admin...) -->
  <section class="card" id="secJogos" style="display:none;">
    <h2>Jogos</h2>
    <small>Lista de jogos.</small>
    <div id="listaJogosContainer"></div>
  </section>

  <section class="card" id="secClassificados" style="display:none;">
    <h2>Classificados</h2>
    <div id="classificacaoContainer"></div>
  </section>

  <section class="card" id="secPlacarAoVivo" style="display:none;">
    <h2>Placar ao vivo</h2>
    <div id="placarAoVivoContainer"></div>
  </section>

  <!-- ADMIN (mantido) -->
  <section class="card" id="adminSection" style="display:none;">
    <div class="admin-header">
      <div>
        <h2>√Årea administrativa</h2>
        <div class="admin-sub">Gerencie inscri√ß√µes, jogos e configura√ß√µes.</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span id="adminStatus" class="admin-status">Verificando...</span>
        <button class="btn btn-primaria" id="btnFecharAdmin">‚¨Ö Voltar</button>
      </div>
    </div>
    <!-- conte√∫do simplificado para este exemplo (o restante do admin j√° est√° no outro arquivo) -->
    <div id="tab-inscricoes"></div>
  </section>

  <!-- Painel para Professores (mantido) -->
  <section class="card" id="professoresSection" style="display:none;">
    <h2>Painel de professores</h2>
    <div id="profListaAlunos"></div>
  </section>
</main>

<!-- Scanner overlay -->
<div id="scannerOverlay">
  <div id="scannerCard">
    <h3 style="margin:0 0 8px 0;">Escaneador de Credenciais</h3>
    <video id="scannerVideo" autoplay muted playsinline></video>
    <canvas id="scannerCanvas" style="display:none;"></canvas>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="btn btn-primaria" id="btnStopScanner">Parar</button>
      <button class="btn" id="btnCloseScanner" style="background:#eee;">Fechar</button>
    </div>
    <div id="scannerResult"></div>
    <div id="scannerError"></div>
  </div>
</div>

<script>
"use strict";

/* ========== FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAxB-FrZNQ7DE-e_YJOvNkkwAaCToH9nd8",
  authDomain: "inscricoes-movimenta.firebaseapp.com",
  projectId: "inscricoes-movimenta",
  storageBucket: "inscricoes-movimenta.firebasestorage.app",
  messagingSenderId: "383820865072",
  appId: "1:383820865072:web:c8602b5c2cbcd5884057f5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== CONSTANTES & ESTADO ========== */
const MODALIDADES = ["FUTSAL","QUEIMADA MISTA","DOMIN√ì","FUTMESA","T√äNIS DE MESA","XADREZ","VOLEI"];
const TURMAS_MATUTINO = ["7¬∫A","7¬∫B","7¬∫C","7¬∫D","7¬∫E","7¬∫F","8¬∫F","9¬∫A","9¬∫B","9¬∫C","9¬∫D","9¬∫E"];
const TURMAS_VESPERTINO = ["6¬∫A","6¬∫B","6¬∫C","6¬∫D","6¬∫E","6¬∫F","6¬∫G","8¬∫A","8¬∫B","8¬∫C","8¬∫D","8¬∫E"];
const TURMAS_NOTURNO = ["1¬∫A","1¬∫B","1¬∫C","1¬∫D","1¬∫E","1¬∫F","2¬∫A","2¬∫B","2¬∫C","3¬∫A","3¬∫B","3¬∫C"];
const TODAS_TURMAS = [...TURMAS_MATUTINO,...TURMAS_VESPERTINO,...TURMAS_NOTURNO];

function getTurmasPorTurno(turno){
  if (turno==="Matutino") return TURMAS_MATUTINO;
  if (turno==="Vespertino") return TURMAS_VESPERTINO;
  if (turno==="Noturno") return TURMAS_NOTURNO;
  return [];
}

let LIMITE_MODALIDADES_POR_ALUNO = 2;
let LIMITE_MODALIDADE_TURMA = {"FUTSAL":8,"DOMIN√ì":2,"FUTMESA":2,"T√äNIS DE MESA":2,"XADREZ":2,"VOLEI":6};
let LIMITE_QUEIMADA_TOTAL = 10;
let LIMITE_QUEIMADA_POR_SEXO = 5;

let todasInscricoes = [];
let todosJogos = [];
let todosProfessores = [];

let emailAtual = null;
let isAdmin = false;
const ADMIN_PASSWORD = "52090949";

/* Scanner */
let scannerStream = null;
let scannerAnimationFrame = null;
let scannerPaused = false;

/* Chamada (novo) */
let chamadaSessionId = null;
let chamadaPresencasMap = {}; // { inscricaoId: {timestamp, valido:true} }

/* ========== UTILIT√ÅRIOS ========== */
function normalizarNome(str){
  return (str||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ");
}
function validarEmail(e){ return typeof e==='string' && e.includes('@') && e.includes('.'); }
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ========== INICIALIZA√á√ÉO UI (credenciais, chamada, scanner) ========== */

function initUI(){
  // popular selects de credenciais/modalidades
  const credModal = document.getElementById("credFiltroModalidade");
  credModal.innerHTML = '<option value="">Todas</option>';
  MODALIDADES.forEach(m => { const o=document.createElement("option"); o.value=m; o.textContent=m; credModal.appendChild(o); });

  // evento bot√£o atualizar credenciais
  document.getElementById("btnAbrirCredenciais").addEventListener("click", renderCredenciaisLista);
  document.getElementById("btnAbrirEscaneador").addEventListener("click", abrirEscaneadorComSenha);
  document.getElementById("btnAbrirChamada").addEventListener("click", toggleChamadaPanel);

  // cred filtros
  document.getElementById("credFiltroTurno").addEventListener("change", credTurnoChange);
  document.getElementById("credFiltroTurma").addEventListener("change", renderCredenciaisLista);
  document.getElementById("credFiltroModalidade").addEventListener("change", renderCredenciaisLista);

  // chamada panel
  document.getElementById("chTurno").addEventListener("change", chTurnoChange);
  document.getElementById("chTurma").addEventListener("change", renderChamadaLista);
  document.getElementById("chModalidade").addEventListener("change", renderChamadaLista);
  document.getElementById("btnIniciarChamada").addEventListener("click", iniciarChamada);
  document.getElementById("btnEncerrarChamada").addEventListener("click", encerrarChamada);

  // scanner buttons
  document.getElementById("btnStopScanner").addEventListener("click", stopScanner);
  document.getElementById("btnCloseScanner").addEventListener("click", () => { stopScanner(); document.getElementById("scannerOverlay").style.display="none"; });

  // overlay email
  configurarOverlayEmail();
}

/* ========== CREDENCIAIS: render lista e imprimir (mantido) ========== */

async function renderCredenciaisLista(){
  const turno = document.getElementById("credFiltroTurno").value;
  const turma = document.getElementById("credFiltroTurma").value;
  const modalidade = document.getElementById("credFiltroModalidade").value;
  const cont = document.getElementById("credLista");
  cont.innerHTML = "";

  let lista = todasInscricoes.slice();
  if (turno) lista = lista.filter(i => i.turno===turno);
  if (turma) lista = lista.filter(i => i.turma===turma);
  if (modalidade) lista = lista.filter(i => Array.isArray(i.modalidades) && i.modalidades.includes(modalidade));
  if (!lista.length){ cont.appendChild(document.createElement("div")).textContent = "Nenhuma inscri√ß√£o encontrada para esses filtros."; return; }

  for (const ins of lista){
    const card = document.createElement("div"); card.className="cred-card";
    const dados = document.createElement("div"); dados.className="cred-dados";
    dados.innerHTML = `<strong>${escapeHtml(ins.nome)}</strong><br>Turno: ${escapeHtml(ins.turno)} ‚Äî Turma: ${escapeHtml(ins.turma)}<br>Modalidades: ${(ins.modalidades||[]).map(m=>escapeHtml(m)).join(", ")}<br>ID: ${escapeHtml(ins.id)}`;
    const actions = document.createElement("div"); actions.className="cred-actions";
    const imgQR = document.createElement("img"); imgQR.style.width="80px"; imgQR.style.height="80px"; imgQR.style.border="1px solid #ccc"; imgQR.style.background="#fff";
    try { imgQR.src = await QRCode.toDataURL(ins.id, {width:160, margin:1}); } catch(e){ imgQR.alt="QR erro"; }
    const btnImprimir = document.createElement("button"); btnImprimir.className="btn btn-primaria"; btnImprimir.textContent="Imprimir Credenciais";
    btnImprimir.addEventListener("click", ()=> imprimirCredencial(ins));
    actions.appendChild(imgQR); actions.appendChild(btnImprimir);
    card.appendChild(dados); card.appendChild(actions);
    cont.appendChild(card);
  }
}

/* imprimir crach√° (mesma fun√ß√£o anterior) */
async function imprimirCredencial(ins){
  const nome = ins.nome || ""; const turno = ins.turno || ""; const turma = ins.turma || ""; const modalidades = (ins.modalidades||[]).join(", "); const id = ins.id || "";
  let dataUrl="";
  try { dataUrl = await QRCode.toDataURL(id, {width:300, margin:1}); } catch(e){ dataUrl=""; }
  const badgeHtml = `
  <!doctype html><html><head><meta charset="utf-8"><title>Crach√° ‚Äî ${escapeHtml(nome)}</title>
  <style>
    @media print{ @page{margin:10mm;} body{margin:0;} }
    body{font-family:system-ui;padding:10px;}
    .badge{width:320px;height:190px;border:2px solid #0056b3;border-radius:8px;padding:12px;display:flex;gap:12px;align-items:center;}
    .left{flex:1;} .right{width:120px;text-align:center;} h1{margin:0;font-size:20px;color:#0056b3;}
    .meta{margin-top:6px;font-size:14px;color:#222;} .small{font-size:12px;color:#333;margin-top:4px;}
    .qr{width:100px;height:100px;border:1px solid #ccc;padding:4px;background:#fff;} .id{font-size:12px;color:#444;margin-top:6px;}
  </style></head><body>
    <div class="badge">
      <div class="left">
        <h1>${escapeHtml(nome)}</h1>
        <div class="meta">Turno: <strong>${escapeHtml(turno)}</strong></div>
        <div class="meta">Turma: <strong>${escapeHtml(turma)}</strong></div>
        <div class="small">Modalidades: ${escapeHtml(modalidades)}</div>
        <div class="id">ID: ${escapeHtml(id)}</div>
      </div>
      <div class="right">
        ${dataUrl?`<img class="qr" src="${dataUrl}" alt="QR Code">`:`<div class="qr"></div>`}
        <div style="font-size:11px;margin-top:6px;">Apresente este crach√°</div>
      </div>
    </div>
    <script>setTimeout(function(){ window.print(); }, 400);</script>
  </body></html>`;
  const w = window.open("","_blank","width=420,height=360");
  if (!w){ alert("Bloqueador de popups impediu abrir a janela de impress√£o. Permita popups e tente novamente."); return; }
  w.document.open(); w.document.write(badgeHtml); w.document.close();
}

/* ========== CHAMADA: UI e l√≥gica ========== */

function toggleChamadaPanel(){
  const panel = document.getElementById("chamadaPanel");
  panel.style.display = panel.style.display === "block" ? "none" : "block";
  if (panel.style.display === "block") {
    // preencha selects de modalidade
    const chModal = document.getElementById("chModalidade");
    chModal.innerHTML = '<option value="">Selecione a modalidade...</option>';
    MODALIDADES.forEach(m => { const o=document.createElement("option"); o.value=m; o.textContent=m; chModal.appendChild(o); });
  }
}

function credTurnoChange(){
  const turno = document.getElementById("credFiltroTurno").value;
  const turmaSel = document.getElementById("credFiltroTurma");
  turmaSel.innerHTML = "";
  const optDefault = document.createElement("option");
  if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; turmaSel.appendChild(optDefault); return; }
  optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault);
  const turmas = getTurmasPorTurno(turno);
  turmas.forEach(t => { const o=document.createElement("option"); o.value=t; o.textContent=t; turmaSel.appendChild(o); });
  renderCredenciaisLista();
}

/* chamada painel - turno change */
function chTurnoChange(){
  const turno = document.getElementById("chTurno").value;
  const turmaSel = document.getElementById("chTurma");
  turmaSel.innerHTML = "";
  const optDefault = document.createElement("option");
  if (!turno){ optDefault.value=""; optDefault.textContent="Selecione o turno primeiro..."; turmaSel.appendChild(optDefault); return; }
  optDefault.value=""; optDefault.textContent="Selecione a turma..."; turmaSel.appendChild(optDefault);
  const turmas = getTurmasPorTurno(turno);
  turmas.forEach(t => { const o=document.createElement("option"); o.value=t; o.textContent=t; turmaSel.appendChild(o); });
}

/* iniciar chamada: cria sess√£o em Firestore e abre escaneador (apenas admin) */
async function iniciarChamada(){
  if (!isAdmin){ alert("Apenas administrador pode iniciar a chamada."); return; }
  const turno = document.getElementById("chTurno").value;
  const turma = document.getElementById("chTurma").value;
  const modalidade = document.getElementById("chModalidade").value;
  if (!turno || !turma || !modalidade){ alert("Selecione turno, turma e modalidade antes de iniciar a chamada."); return; }

  // gerar sessionId simples
  const sessionId = 'sess_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  chamadaSessionId = sessionId;
  chamadaPresencasMap = {};

  try{
    await db.collection("chamadas").doc(sessionId).set({
      turno: turno,
      turma: turma,
      modalidade: modalidade,
      startedAt: firebase.firestore.FieldValue.serverTimestamp(),
      startedBy: "ADMIN"
    });
  }catch(e){ console.error("Erro ao criar sess√£o de chamada:", e); alert("Erro ao iniciar sess√£o."); return; }

  // ouvindo presencas em tempo real para esta sess√£o
  db.collection("chamadas").doc(sessionId).collection("presencas").onSnapshot(snap => {
    chamadaPresencasMap = {};
    snap.forEach(doc => {
      const d = doc.data();
      chamadaPresencasMap[doc.id] = { ...d };
    });
    renderChamadaLista();
  });

  document.getElementById("chSessionLabel").textContent = "Sess√£o: " + sessionId;
  // abrir escaneador (modo admin)
  abrirEscaneador();
  alert("Sess√£o de chamada iniciada. Aponte os QR Codes dos alunos para registrar presen√ßa.");
  renderChamadaLista();
}

/* encerrar sess√£o de chamada */
async function encerrarChamada(){
  if (!chamadaSessionId){ alert("Nenhuma sess√£o ativa."); return; }
  if (!confirm("Encerrar a sess√£o de chamada atual?")) return;
  try{
    await db.collection("chamadas").doc(chamadaSessionId).update({ endedAt: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){ console.error("Erro ao encerrar sess√£o:", e); }
  chamadaSessionId = null;
  chamadaPresencasMap = {};
  document.getElementById("chSessionLabel").textContent = "";
  renderChamadaLista();
  alert("Sess√£o encerrada.");
  // deixar escaneador aberto caso queira mas a grava√ß√£o n√£o ocorrer√° (porque sessionId==null)
}

/* render lista de chamada (show validated / not validated) */
function renderChamadaLista(){
  const turno = document.getElementById("chTurno").value;
  const turma = document.getElementById("chTurma").value;
  const modalidade = document.getElementById("chModalidade").value;
  const cont = document.getElementById("chamadaLista");
  cont.innerHTML = "";

  if (!turno || !turma || !modalidade){
    cont.textContent = "Selecione turno, turma e modalidade e inicie a chamada.";
    return;
  }

  // filtrar inscritos
  let lista = todasInscricoes.filter(i => i.turno===turno && i.turma===turma && Array.isArray(i.modalidades) && i.modalidades.includes(modalidade));
  lista = lista.slice().sort((a,b) => (a.nome||"").localeCompare(b.nome||"","pt-BR"));

  if (!lista.length){
    cont.textContent = "Nenhum inscrito para esses filtros.";
    return;
  }

  lista.forEach(ins => {
    const row = document.createElement("div");
    row.className = "chamada-row";
    const left = document.createElement("div");
    left.innerHTML = `<strong>${escapeHtml(ins.nome)}</strong><div style="font-size:0.85rem;color:#444;">ID: ${escapeHtml(ins.id)}</div>`;
    const right = document.createElement("div");
    const pres = chamadaPresencasMap[ins.id];
    const badge = document.createElement("span");
    badge.className = "status-badge " + (pres ? "status-validado" : "status-nao");
    badge.textContent = pres ? "VALIDADO" : "N√ÉO VALIDADO";
    right.appendChild(badge);
    // bot√£o para for√ßar validar manualmente (opcional)
    const btnManual = document.createElement("button");
    btnManual.className = "btn";
    btnManual.style.marginLeft = "8px";
    btnManual.textContent = pres ? "Revalidar" : "Validar";
    btnManual.addEventListener("click", async () => {
      if (!isAdmin){ alert("Apenas admin."); return; }
      if (!chamadaSessionId){ alert("Nenhuma sess√£o ativa."); return; }
      try{
        await db.collection("chamadas").doc(chamadaSessionId).collection("presencas").doc(ins.id).set({
          inscricaoId: ins.id,
          nome: ins.nome,
          turno: ins.turno,
          turma: ins.turma,
          modalidade: modalidade,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          via: 'manual'
        });
        alert("Presen√ßa registrada (manual).");
      }catch(e){ console.error(e); alert("Erro ao registrar presen√ßa."); }
    });
    right.appendChild(btnManual);
    row.appendChild(left); row.appendChild(right);
    cont.appendChild(row);
  });
}

/* ========== ESCANEADOR (atualizado para registrar presen√ßas quando em chamada) ========== */

function abrirEscaneadorComSenha(){
  const senha = prompt("Digite a senha da √°rea administrativa para abrir o escaneador:");
  if (senha === null) return;
  if (senha !== ADMIN_PASSWORD){ alert("Senha incorreta."); return; }
  isAdmin = true; // abre como admin para permitir grava√ß√£o de chamada
  abrirEscaneador();
}

function abrirEscaneador(){
  const overlay = document.getElementById("scannerOverlay");
  const video = document.getElementById("scannerVideo");
  const canvas = document.getElementById("scannerCanvas");
  const scannerError = document.getElementById("scannerError");
  const scannerResult = document.getElementById("scannerResult");
  scannerError.style.display = "none";
  scannerResult.innerHTML = "";
  overlay.style.display = "flex";

  scannerPaused = false;
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      scannerStream = stream;
      video.srcObject = stream;
      video.play();
      scanLoop();
    })
    .catch(err => {
      console.error("Erro ao acessar c√¢mera:", err);
      scannerError.style.display = "block";
      scannerError.textContent = "Erro ao acessar a c√¢mera. Verifique permiss√µes e se a p√°gina est√° em HTTPS.";
    });

  function scanLoop(){
    if (!video) return;
    if (scannerPaused){ scannerAnimationFrame = requestAnimationFrame(scanLoop); return; }
    if (video.readyState !== video.HAVE_ENOUGH_DATA){ scannerAnimationFrame = requestAnimationFrame(scanLoop); return; }
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    try {
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imgData.data, imgData.width, imgData.height);
      if (code && code.data){
        scannerPaused = true;
        processarQR(code.data).then(() => {
          if (scannerStream){
            scannerPaused = false;
            scannerAnimationFrame = requestAnimationFrame(scanLoop);
          }
        });
        return;
      }
    } catch(e){}
    scannerAnimationFrame = requestAnimationFrame(scanLoop);
  }
}

function stopScanner(){
  if (scannerAnimationFrame) { cancelAnimationFrame(scannerAnimationFrame); scannerAnimationFrame = null; }
  if (scannerStream){ scannerStream.getTracks().forEach(t=>t.stop()); scannerStream=null; }
  scannerPaused = true;
}

/* processarQR: mostra validado/inv√°lido e grava presen√ßa se sess√£o ativa */
async function processarQR(qrData){
  const idLido = (qrData||"").trim();
  const ins = todasInscricoes.find(i => i.id === idLido);
  const scannerResult = document.getElementById("scannerResult");
  scannerResult.innerHTML = "";

  function mostrarStatusHTML(htmlContent, tempoMs){
    scannerResult.innerHTML = htmlContent;
    return new Promise(res => setTimeout(() => { if (document.getElementById("scannerResult")) document.getElementById("scannerResult").innerHTML=""; res(); }, tempoMs || 1600));
  }

  if (!ins){
    const html = `
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="flex:1;">
          <div style="font-weight:700; font-size:1.05rem; color:#fff; background:#c0392b; padding:8px; border-radius:6px; text-align:center;">INV√ÅLIDO</div>
          <div style="margin-top:8px; font-size:0.95rem; color:#fff;">QR lido: <strong>${escapeHtml(idLido)}</strong></div>
          <div style="margin-top:6px; color:#fff; opacity:0.95;">Inscri√ß√£o n√£o encontrada no banco de dados.</div>
        </div>
      </div>`;
    // se estiver em sess√£o e admin, gravar tentativa inv√°lida como registro (opcional) - N√ÉO grava por padr√£o
    return mostrarStatusHTML(html, 1600);
  }

  const bloqueios = Array.isArray(ins.naoAutorizadoPor) ? ins.naoAutorizadoPor.length : 0;
  if (bloqueios >= 2){
    const html = `
      <div style="display:flex; gap:12px; align-items:center;">
        <div style="flex:1;">
          <div style="font-weight:700; font-size:1.05rem; color:#fff; background:#c0392b; padding:8px; border-radius:6px; text-align:center;">N√ÉO VALIDADO</div>
          <div style="margin-top:8px; font-size:0.95rem; color:#222;">${escapeHtml(ins.nome)}</div>
          <div style="font-size:0.9rem; color:#222; margin-top:4px;">Turma: <strong>${escapeHtml(ins.turma)}</strong></div>
          <div style="margin-top:6px; color:#222; opacity:0.9;">Motivo: indicado por ${bloqueios} professor(es).</div>
        </div>
      </div>`;
    // registrar invalida√ß√£o na sess√£o? (opcional) - por ora n√£o
    return mostrarStatusHTML(html, 1700);
  }

  // CASO VALIDADO -> se sess√£o ativa, grava no Firestore
  const dataUrl = await (async ()=>{ try { return await QRCode.toDataURL(idLido, {width:240, margin:1}); } catch(e){ return ""; } })();

  const html = `
    <div style="display:flex; gap:12px; align-items:center;">
      <div style="flex:1;">
        <div style="font-weight:700; font-size:1.05rem; color:#fff; background:#27ae60; padding:8px; border-radius:6px; text-align:center;">VALIDADO</div>
        <div style="margin-top:8px; font-size:0.95rem; color:#222;">${escapeHtml(ins.nome)}</div>
        <div style="font-size:0.9rem; color:#222; margin-top:4px;">Turma: <strong>${escapeHtml(ins.turma)}</strong></div>
        <div style="margin-top:6px; color:#222; opacity:0.9;">Modalidades: ${((ins.modalidades||[]).map(m=>escapeHtml(m))).join(", ")}</div>
      </div>
      <div style="width:140px; text-align:center;">
        ${dataUrl ? `<img src="${dataUrl}" style="width:120px;height:120px;border:1px solid #ccc;background:#fff;border-radius:6px;">` : `<div style="width:120px;height:120px;background:#fff;border-radius:6px;border:1px solid #ccc;"></div>`}
      </div>
    </div>
  `;

  // se houver sess√£o de chamada ativa, grava presen√ßa
  if (chamadaSessionId && isAdmin){
    try{
      await db.collection("chamadas").doc(chamadaSessionId).collection("presencas").doc(ins.id).set({
        inscricaoId: ins.id,
        nome: ins.nome,
        turno: ins.turno,
        turma: ins.turma,
        modalidade: (document.getElementById("chModalidade").value || ""),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        via: 'scanner'
      });
    }catch(e){
      console.error("Erro ao gravar presen√ßa:", e);
    }
  }

  return mostrarStatusHTML(html, 1600);
}

/* ========== LISTENERS FIRESTORE (inscricoes/jogos) ========== */

function iniciarListeners(){
  db.collection("inscricoes").orderBy("timestamp","asc").onSnapshot(snap => {
    todasInscricoes = [];
    snap.forEach(doc => {
      const d = doc.data();
      todasInscricoes.push({
        id: doc.id,
        nome: d.nome || "",
        nomeNormalizado: d.nomeNormalizado || normalizarNome(d.nome || ""),
        email: d.email || "",
        sexo: d.sexo || "",
        turno: d.turno || "",
        turma: d.turma || "",
        camisaNumero: d.camisaNumero || "",
        modalidades: d.modalidades || [],
        observacoes: d.observacoes || "",
        naoAutorizadoPor: d.naoAutorizadoPor || [],
        timestamp: d.timestamp
      });
    });
    // Atualizar selects de turma (cred & ch)
    atualizarSelectsCredenciais();
    // atualizar listas
    renderCredenciaisLista();
    renderChamadaListIfVisible();
  });

  db.collection("jogos").orderBy("dataJogo","asc").onSnapshot(snap => {
    todosJogos = [];
    snap.forEach(doc => {
      const d = doc.data();
      todosJogos.push({ id: doc.id, ...d });
    });
    // caso precise, atualizar jogos UI
  });

  db.collection("professoresAcesso").onSnapshot(snap => {
    todosProfessores = [];
    snap.forEach(doc => {
      const d = doc.data();
      todosProfessores.push({ id: doc.id, nome: d.nome, tipo: d.tipo, senha: d.senha });
    });
  });
}

function atualizarSelectsCredenciais(){
  // credFiltroTurma options
  const turno = document.getElementById("credFiltroTurno").value;
  const sel = document.getElementById("credFiltroTurma");
  sel.innerHTML = "";
  const def = document.createElement("option");
  if (!turno){ def.value=""; def.textContent="Selecione o turno primeiro..."; sel.appendChild(def); return; }
  def.value=""; def.textContent="Selecione a turma..."; sel.appendChild(def);
  const turmas = getTurmasPorTurno(turno);
  turmas.forEach(t => { const o=document.createElement("option"); o.value=t; o.textContent=t; sel.appendChild(o); });
}

function renderChamadaListIfVisible(){
  const panel = document.getElementById("chamadaPanel");
  if (panel.style.display === "block") renderChamadaLista();
}

/* ========== OVERLAY EMAIL ========== */

function configurarOverlayEmail(){
  const overlay = document.getElementById("emailOverlay");
  const emailInput = document.getElementById("emailAluno");
  const btnEntrar = document.getElementById("btnEntrarEmail");
  const msgEmail = document.getElementById("msgEmailOverlay");

  try { const saved = localStorage.getItem('insc_email'); if (validarEmail(saved)) { emailAtual = saved; if (overlay) overlay.style.display='none'; } } catch(e){}

  setTimeout(()=>{ const auto = (emailInput.value||'').trim(); if (validarEmail(auto)){ setEmailEFechar(auto); } }, 250);

  function mostrarErro(msg){ if (msgEmail) msgEmail.textContent = msg; }

  function tentarEntrar(){
    const val = (emailInput.value||'').trim();
    if (!validarEmail(val)){ mostrarErro('Digite um e-mail v√°lido (ex: nome@dominio.com)'); emailInput.focus(); return; }
    setEmailEFechar(val);
  }

  btnEntrar.addEventListener('click', (ev) => { ev.preventDefault(); tentarEntrar(); });
  emailInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter'){ ev.preventDefault(); tentarEntrar(); } });

  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape'){
      const saved = localStorage.getItem('insc_email');
      if (validarEmail(saved) && overlay) overlay.style.display='none';
    }
  });

  overlay.addEventListener('click', (ev) => {
    if (ev.target === overlay){ const saved = localStorage.getItem('insc_email'); if (validarEmail(saved) && overlay) overlay.style.display='none'; }
  });
}

function setEmailEFechar(email){
  try{ localStorage.setItem('insc_email', email); }catch(e){}
  window._inscricao_email_fallback = email;
  emailAtual = email;
  const ov = document.getElementById('emailOverlay'); if (ov) ov.style.display='none';
}

/* ========== INICIALIZA√á√ÉO GERAL ========== */

function init(){
  initUI();
  iniciarListeners();
  // ocultar scanner overlay inicialmente
  document.getElementById("scannerOverlay").style.display = "none";
}

if (document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", init); } else { init(); }

</script>
</body>
</html>
